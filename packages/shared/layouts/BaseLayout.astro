---
/**
 * BaseLayout ‚Äî The Grocery Index Design System
 * Light/dark theme support via CSS custom properties
 * Wraps all pages with shared head, fonts, Alpine, global CSS, noise overlay
 */
import ThemeToggle from '../components/ThemeToggle.astro';

interface Props {
  title: string;
  description?: string;
  canonicalUrl?: string;
  structuredData?: string;
  ogImage?: string;
  ogType?: string;
  siteName?: string;
  faviconEmoji?: string;
}

const {
  title,
  description = '',
  canonicalUrl,
  structuredData,
  ogImage = 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&q=80&w=1200',
  ogType = 'website',
  siteName,
  faviconEmoji,
} = Astro.props;

// Infer site from URL or fallback
const currentUrl = canonicalUrl || Astro.url?.href || '';
const isMealPrep = currentUrl.includes('mealprepideas') || Astro.url?.pathname?.startsWith('/meal-prep');
const resolvedSiteName = siteName || (isMealPrep ? 'MealPrepIdeas.co' : 'ProteinMeals.co');
const resolvedFavicon = faviconEmoji || (isMealPrep ? 'ü•¶' : 'üçó');
---

<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{title}</title>
  {description && <meta name="description" content={description} />}
  {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

  <!-- Favicon (emoji) -->
  <link rel="icon" href={`data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>${resolvedFavicon}</text></svg>`} />

  <!-- Open Graph -->
  <meta property="og:title" content={title} />
  {description && <meta property="og:description" content={description} />}
  <meta property="og:type" content={ogType} />
  {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
  <meta property="og:image" content={ogImage} />
  <meta property="og:site_name" content={resolvedSiteName} />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={title} />
  {description && <meta name="twitter:description" content={description} />}
  <meta name="twitter:image" content={ogImage} />

  <!-- FOUC Prevention: Apply saved theme before paint -->
  <script is:inline>
    (function() {
      const saved = localStorage.getItem('theme');
      const theme = saved || 'light';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- Fonts (preconnect + font-display swap) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet" />

  <!-- Clerk Auth -->
  <script is:inline>
    // Clerk auth state for Alpine.js integration
    window.__clerkPublishableKey = 'pk_test_ZGVhci1saW9uZmlzaC00OS5jbGVyay5hY2NvdW50cy5kZXYk';
    window.__authReady = false;
    window.__authUser = null;
  </script>
  <script async crossorigin="anonymous" data-clerk-publishable-key="pk_test_ZGVhci1saW9uZmlzaC00OS5jbGVyay5hY2NvdW50cy5kZXYk" src="https://dear-lionfish-49.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" onload="
    window.Clerk.load().then(function() {
      window.__authReady = true;
      window.__authUser = window.Clerk.user;
      window.dispatchEvent(new CustomEvent('clerk-ready'));
    });
  "></script>

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Structured Data -->
  {structuredData && <script type="application/ld+json" set:html={structuredData} />}

  <!-- Theme Variables -->
  <style is:global>
    /* ============================================
       Theme System ‚Äî Light/Dark CSS Custom Properties
       ============================================ */

    /* ---- LIGHT MODE (DEFAULT) ---- */
    :root,
    [data-theme="light"] {
      --bg-primary: #F9F7F2;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #F0EDE6;
      --bg-nav: rgba(249, 247, 242, 0.85);

      --text-primary: #2D3436;
      --text-secondary: #636E72;
      --text-tertiary: #B2BEC3;
      --text-inverse: #FFFFFF;

      --accent-primary: #7E9680;
      --accent-primary-hover: #6B8370;
      --accent-secondary: #E67E22;
      --accent-secondary-hover: #D35400;
      --accent-glow: rgba(126, 150, 128, 0.15);

      --border-default: rgba(0, 0, 0, 0.08);
      --border-hover: rgba(126, 150, 128, 0.4);
      --border-strong: rgba(0, 0, 0, 0.15);

      --shadow-card: 0 4px 0px rgba(0,0,0,0.02), 0 15px 35px -5px rgba(0,0,0,0.06);
      --shadow-card-hover: 0 25px 50px -12px rgba(0,0,0,0.1);
      --shadow-glow: 0 0 30px rgba(126, 150, 128, 0.12);

      --pill-active-bg: #7E9680;
      --pill-active-text: #FFFFFF;
      --pill-inactive-bg: #F0EDE6;
      --pill-inactive-text: #636E72;

      --badge-bg: #F0EDE6;
      --badge-text: #2D3436;
      --badge-border: rgba(126, 150, 128, 0.3);

      --grid-dot: rgba(0, 0, 0, 0.04);
      --noise-opacity: 0.03;
      --scanner-color: #7E9680;
      --scanner-opacity: 0.15;

      --scrollbar-track: #F9F7F2;
      --scrollbar-thumb: #7E9680;

      --hero-overlay-bg: #F0EDE6;
      --hero-overlay-hover: #E8E4DA;
      --select-bg: var(--bg-tertiary);
      --select-border: var(--border-default);
    }

    /* ---- DARK MODE ---- */
    [data-theme="dark"] {
      --bg-primary: #0F0F0F;
      --bg-secondary: #1A1A1A;
      --bg-tertiary: #252525;
      --bg-nav: rgba(15, 15, 15, 0.8);

      --text-primary: #FFFFFF;
      --text-secondary: #A0A0A0;
      --text-tertiary: #666666;
      --text-inverse: #0F0F0F;

      --accent-primary: #D9FF00;
      --accent-primary-hover: #C4E600;
      --accent-secondary: #D9FF00;
      --accent-secondary-hover: #C4E600;
      --accent-glow: rgba(217, 255, 0, 0.1);

      --border-default: rgba(255, 255, 255, 0.1);
      --border-hover: rgba(217, 255, 0, 0.5);
      --border-strong: rgba(255, 255, 255, 0.2);

      --shadow-card: 0 4px 15px rgba(0, 0, 0, 0.3);
      --shadow-card-hover: 0 0 30px rgba(217, 255, 0, 0.1);
      --shadow-glow: 0 0 30px rgba(217, 255, 0, 0.1);

      --pill-active-bg: #D9FF00;
      --pill-active-text: #000000;
      --pill-inactive-bg: #1A1A1A;
      --pill-inactive-text: #A0A0A0;

      --badge-bg: #1A1A1A;
      --badge-text: #FFFFFF;
      --badge-border: rgba(255, 255, 255, 0.1);

      --grid-dot: rgba(255, 255, 255, 0.05);
      --noise-opacity: 0.03;
      --scanner-color: #D9FF00;
      --scanner-opacity: 0.3;

      --scrollbar-track: #0F0F0F;
      --scrollbar-thumb: #D9FF00;

      --hero-overlay-bg: #1A1A1A;
      --hero-overlay-hover: #252525;
      --select-bg: #0F0F0F;
      --select-border: rgba(255, 255, 255, 0.1);
    }

    /* ---- BASE STYLES ---- */
    body {
      font-family: 'Lexend', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Grid Background */
    .bg-grid {
      background-image: radial-gradient(circle at 1px 1px, var(--grid-dot) 1px, transparent 0);
      background-size: 40px 40px;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
    ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; }

    /* Theme Card */
    .theme-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      box-shadow: var(--shadow-card);
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .theme-card:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-card-hover);
    }

    /* Hyper Border ‚Äî signature card style (theme-aware) */
    .hyper-border {
      position: relative;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .hyper-border:hover {
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-glow);
    }

    /* Theme Navigation */
    .theme-nav {
      backdrop-filter: blur(12px);
      background: var(--bg-nav);
      border-bottom: 1px solid var(--border-default);
    }

    /* Glass Navigation (legacy alias for theme-nav) */
    .glass-nav {
      backdrop-filter: blur(12px);
      background: var(--bg-nav);
      border-bottom: 1px solid var(--border-default);
    }

    /* Scanner Line Animation */
    .scanner-line {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 2px;
      background: var(--scanner-color);
      box-shadow: 0 0 15px var(--scanner-color);
      animation: scan 4s linear infinite;
      opacity: var(--scanner-opacity);
      pointer-events: none;
    }

    @keyframes scan {
      0% { top: 0%; }
      50% { top: 100%; }
      100% { top: 0%; }
    }

    /* Pills */
    .theme-pill-active,
    .pill-active {
      background-color: var(--pill-active-bg);
      color: var(--pill-active-text);
    }

    .theme-pill-inactive {
      background-color: var(--pill-inactive-bg);
      color: var(--pill-inactive-text);
      border: 1px solid var(--border-default);
    }

    /* Buttons */
    .theme-btn-primary {
      background-color: var(--accent-primary);
      color: var(--text-inverse);
      transition: all 0.3s ease;
    }

    .theme-btn-primary:hover {
      background-color: var(--accent-primary-hover);
      box-shadow: var(--shadow-glow);
    }

    .theme-btn-cta {
      background-color: var(--accent-secondary);
      color: var(--text-inverse);
      transition: all 0.3s ease;
    }

    .theme-btn-cta:hover {
      background-color: var(--accent-secondary-hover);
    }

    /* Text Stroke Effect */
    .text-stroke {
      -webkit-text-stroke: 1px var(--border-strong);
      color: transparent;
    }

    /* Noise Overlay */
    .noise-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 50;
      opacity: var(--noise-opacity);
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    /* Bento Card */
    .bento-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: 24px;
      transition: all 0.3s ease;
    }

    .bento-card:hover {
      border-color: var(--accent-primary);
      transform: translateY(-4px);
    }

    /* Macro Card */
    .macro-card {
      background: linear-gradient(145deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
      border: 1px solid var(--border-default);
    }

    /* PE Gradient */
    .pe-gradient {
      background: linear-gradient(90deg, var(--text-tertiary) 0%, var(--accent-primary) 100%);
    }

    /* Data Row Hover */
    .data-row:hover {
      background: var(--accent-glow);
    }

    /* Recipe Card Hover */
    .recipe-card-hover:hover .recipe-img {
      transform: scale(1.05);
      filter: grayscale(0%);
    }

    .recipe-img {
      transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
      filter: grayscale(40%);
    }

    /* Recipe Gradient */
    .recipe-gradient {
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, var(--bg-primary) 100%);
    }

    /* Macro Bar */
    .macro-bar {
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      overflow: hidden;
    }

    .macro-fill {
      height: 100%;
      background: var(--accent-primary);
    }

    /* Barcode Decoration */
    .barcode-deco {
      background: repeating-linear-gradient(90deg, var(--text-tertiary), var(--text-tertiary) 2px, transparent 2px, transparent 4px);
      width: 60px;
      height: 20px;
      opacity: 0.5;
    }

    /* Stat Glow */
    .stat-glow {
      text-shadow: 0 0 20px var(--accent-glow);
    }

    /* Data Stream Mask */
    .data-stream {
      mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    }

    /* Receipt Edge */
    .receipt-edge {
      mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
    }

    /* Marquee Animation */
    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .animate-marquee {
      display: flex;
      animation: marquee 40s linear infinite;
    }

    /* PE Ratio Gauge */
    .pe-ratio-gauge {
      background: conic-gradient(from 180deg at 50% 50%, var(--accent-primary) var(--percentage), var(--bg-secondary) 0);
    }

    /* Theme-aware hover utilities (for components migrated from hardcoded dark colors) */
    .hover-accent-bg:hover { background-color: var(--accent-primary) !important; }
    .hover-accent-text:hover { color: var(--accent-primary) !important; }
    .hover-accent-border:hover { border-color: var(--border-hover) !important; }
    .hover-inverse-text:hover { color: var(--text-inverse) !important; }
    .hover-text-primary:hover { color: var(--text-primary) !important; }
    .hover-bg-secondary:hover { background-color: var(--bg-secondary) !important; }
    .hover-bg-tertiary:hover { background-color: var(--bg-tertiary) !important; }

    /* Group hover variants */
    .group:hover .group-hover-accent-text { color: var(--accent-primary); }
    .group:hover .group-hover-accent-bg { background-color: var(--accent-primary); }
    .group:hover .group-hover-inverse-text { color: var(--text-inverse); }
    .group:hover .group-hover-accent-border { border-color: var(--border-hover); }
    .group:hover .group-hover-accent-opacity { color: color-mix(in srgb, var(--accent-primary) 50%, transparent); }

    /* FAQ panel theme */
    .theme-faq-panel { background-color: var(--bg-secondary); border-color: var(--border-default); }
    .theme-faq-body { background-color: color-mix(in srgb, var(--bg-secondary) 50%, transparent); }

    /* Alpine Cloak */
    [x-cloak] { display: none !important; }

    /* Select Arrow */
    select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }

    /* Text utilities */
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-tertiary { color: var(--text-tertiary); }
    .text-accent { color: var(--accent-primary); }
    .bg-accent { background-color: var(--accent-primary); }
  </style>
</head>
<body class="bg-grid">
  <!-- Noise Overlay -->
  <div class="noise-overlay"></div>

  <!-- Clerk Sign-In Modal Container -->
  <div id="clerk-sign-in-modal" style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); justify-content:center; align-items:center;">
    <div style="position:relative; max-width:420px; width:100%; margin:1rem;">
      <button onclick="document.getElementById('clerk-sign-in-modal').style.display='none'" style="position:absolute; top:-2.5rem; right:0; background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">‚úï</button>
      <div id="clerk-sign-in-mount"></div>
    </div>
  </div>

  <!-- Page Content -->
  <slot />

  <!-- Magnetic Button Effect -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.hyper-border').forEach(btn => {
        btn.addEventListener('mousemove', e => {
          const rect = (btn as HTMLElement).getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          (btn as HTMLElement).style.setProperty('--mouse-x', `${x}px`);
          (btn as HTMLElement).style.setProperty('--mouse-y', `${y}px`);
        });
      });
    });
  </script>

  <!-- Global Auth Helper -->
  <script is:inline>
    window.authHelper = {
      isSignedIn: function() {
        return !!(window.Clerk && window.Clerk.user);
      },
      getUser: function() {
        return window.Clerk ? window.Clerk.user : null;
      },
      requireAuth: function(callback) {
        if (this.isSignedIn()) {
          callback(this.getUser());
        } else {
          this.openSignIn();
        }
      },
      openSignIn: function() {
        var modal = document.getElementById('clerk-sign-in-modal');
        var mount = document.getElementById('clerk-sign-in-mount');
        if (window.Clerk && modal && mount) {
          modal.style.display = 'flex';
          mount.innerHTML = '';
          window.Clerk.mountSignIn(mount, {
            afterSignInUrl: window.location.href,
            afterSignUpUrl: window.location.href,
          });
        }
      },
      signOut: function() {
        if (window.Clerk) {
          window.Clerk.signOut().then(function() {
            window.location.reload();
          });
        }
      },
      // Saved recipes (localStorage)
      getSavedRecipes: function() {
        try { return JSON.parse(localStorage.getItem('savedRecipes') || '[]'); } catch(e) { return []; }
      },
      saveRecipe: function(recipe) {
        var saved = this.getSavedRecipes();
        if (!saved.find(function(r) { return r.slug === recipe.slug; })) {
          saved.push(recipe);
          localStorage.setItem('savedRecipes', JSON.stringify(saved));
        }
        return saved;
      },
      unsaveRecipe: function(slug) {
        var saved = this.getSavedRecipes().filter(function(r) { return r.slug !== slug; });
        localStorage.setItem('savedRecipes', JSON.stringify(saved));
        return saved;
      },
      isRecipeSaved: function(slug) {
        return this.getSavedRecipes().some(function(r) { return r.slug === slug; });
      },
      // Grocery list
      getGroceryList: function() {
        try { return JSON.parse(localStorage.getItem('groceryList') || '[]'); } catch(e) { return []; }
      },
      setGroceryList: function(list) {
        localStorage.setItem('groceryList', JSON.stringify(list));
      },
      // Macro calculator
      getMacroProfile: function() {
        try { return JSON.parse(localStorage.getItem('macroProfile') || 'null'); } catch(e) { return null; }
      },
      setMacroProfile: function(profile) {
        localStorage.setItem('macroProfile', JSON.stringify(profile));
      }
    };

    // Close modal on backdrop click
    document.addEventListener('click', function(e) {
      var modal = document.getElementById('clerk-sign-in-modal');
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });

    // Update auth UI when Clerk is ready
    window.addEventListener('clerk-ready', function() {
      document.querySelectorAll('[data-auth-show]').forEach(function(el) {
        var condition = el.getAttribute('data-auth-show');
        if (condition === 'signed-in') {
          el.style.display = window.authHelper.isSignedIn() ? '' : 'none';
        } else if (condition === 'signed-out') {
          el.style.display = window.authHelper.isSignedIn() ? 'none' : '';
        }
      });
      // Update avatar
      var avatarEls = document.querySelectorAll('[data-clerk-avatar]');
      var user = window.authHelper.getUser();
      if (user) {
        avatarEls.forEach(function(el) {
          el.src = user.imageUrl;
          el.alt = user.fullName || user.firstName || 'User';
        });
      }
    });
  </script>
</body>
</html>
