---
/**
 * MethodCategory — Method Category Page (T2)
 * Theme-aware: uses CSS custom properties
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import BreadcrumbNav from './BreadcrumbNav.astro';
import ExploreByBlock from './ExploreByBlock.astro';
import PlanCTA from './PlanCTA.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Recipe {
  id: number;
  title: string;
  protein: string;
  cals: string;
  time: string;
  category: string;
  img?: string;
}

interface FAQ {
  question: string;
  answer: string;
}

interface Props {
  title: string;
  description?: string;
  canonicalUrl?: string;
  hub: string;
  facetType: string;
  facetValue: string;
  headline: string;
  subheadline?: string;
  site?: "mealprepideas" | "proteinmeals";
  useCases?: { number: string; title: string; description: string }[];
  recipeCount?: number;
  recipes?: Recipe[];
  faqs?: FAQ[];
  exploreColumns?: { title: string; number?: string; links: { label: string; href: string }[] }[];
  executionNotes?: { batchingRule: string; storageLogic: string };
  relatedMethods?: { label: string; href: string }[];
  planCard?: { title: string; description: string; href?: string };
}

const {
  title, description, canonicalUrl, hub, facetType, facetValue,
  headline, subheadline,
  useCases = [],
  recipeCount: recipeCountProp,
  recipes = [],
  faqs = [],
  exploreColumns = [],
  executionNotes,
  relatedMethods = [],
  planCard,
} = Astro.props;

const recipeCount = recipeCountProp ?? recipes.length;
const hubPath = hub === 'meal-prep' ? '/meal-prep/' : '/high-protein/';
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: hub === 'meal-prep' ? 'Meal Prep' : 'High Protein', href: hubPath },
  { label: `Method: ${headline}` },
];

const recipesJson = JSON.stringify(recipes);

const faqStructuredData = faqs.length > 0 ? JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqs.map(faq => ({
    '@type': 'Question',
    name: faq.question,
    acceptedAnswer: { '@type': 'Answer', text: faq.answer },
  })),
}) : null;

// i18n
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<BaseLayout title={title} description={description} canonicalUrl={canonicalUrl}>
  <HeaderNav statusText={`METHOD: ${headline.toUpperCase()}`} />

  {faqStructuredData && <script type="application/ld+json" set:html={faqStructuredData} />}

  <main class="flex-grow" x-data={`{ filter: 'all', activeFaq: null, hubPath: '${hubPath}', recipes: ${recipesJson}, showCount: 6, get visibleRecipes() { const filtered = this.filter === 'all' ? this.recipes : this.recipes.filter(r => r.category === this.filter); return filtered.slice(0, this.showCount); }, get totalFiltered() { return this.filter === 'all' ? this.recipes.length : this.recipes.filter(r => r.category === this.filter).length; }, get allShown() { return this.showCount >= this.totalFiltered; } }`}>
    <BreadcrumbNav items={breadcrumbs} />

    <!-- T2 HERO: METHOD SPECIFICATION -->
    <section class="px-6 max-w-7xl mx-auto mb-20">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 items-end">
        <div class="lg:col-span-8">
          <div class="flex items-center gap-4 mb-6">
            <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-widest" style="background-color: var(--accent-primary); color: var(--text-inverse);">Facet ID: M-05</span>
            <div class="barcode-deco"></div>
          </div>
          <h1 class="text-7xl md:text-9xl font-black tracking-tighter leading-[0.85] mb-8">{headline}<br/>{t('category.strategies')}</h1>
          <div class="flex flex-col md:flex-row gap-8 items-start">
            {subheadline && (
              <div class="max-w-md">
                <p class="text-xl font-medium leading-relaxed" style="color: var(--text-secondary);">{subheadline}</p>
              </div>
            )}
            {useCases.length > 0 && (
              <div class="border-l-2 p-6 space-y-4 flex-1 w-full md:w-auto" style="background-color: var(--bg-secondary); border-color: var(--accent-primary);">
                <h3 class="text-[10px] font-black uppercase tracking-[0.3em]" style="color: var(--accent-primary);">{t('category.primaryUtility')}</h3>
                <ul class="space-y-2">
                  {useCases.map(uc => (
                    <li class="flex items-center gap-3 text-sm font-bold">
                      <span style="color: var(--accent-primary);">{uc.number}</span> {uc.description}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </div>
        <div class="lg:col-span-4 hidden lg:block">
          <div class="aspect-square rounded-3xl border relative overflow-hidden flex items-center justify-center p-8 group" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
            <div class="relative z-10 text-center">
              <span class="text-6xl font-black block tabular-nums leading-none mb-2" style="color: var(--accent-primary);">{recipeCount}</span>
              <span class="text-[10px] font-bold uppercase tracking-widest" style="color: var(--text-secondary);">Verified {headline} Recipes</span>
            </div>
            <div class="scanner-line"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- FILTER BAR -->
    <section class="sticky top-[73px] z-40 border-y py-4 px-6" style="background-color: var(--bg-primary); border-color: var(--border-default);">
      <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0">
          {['All Specs', 'Dinner', 'Lunch', 'Snacks'].map(f => (
            <button
              x-on:click={`filter = '${f === 'All Specs' ? 'all' : f.toLowerCase()}'`}
              x-bind:class={`filter === '${f === 'All Specs' ? 'all' : f.toLowerCase()}' ? 'pill-active' : 'theme-pill-inactive'`}
              class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all"
            >{f}</button>
          ))}
        </div>
        <div class="flex items-center gap-4 w-full md:w-auto">
          <span class="text-[10px] font-black uppercase tracking-widest whitespace-nowrap" style="color: var(--text-tertiary);">{t('category.sortByProtein')}</span>
        </div>
      </div>
    </section>

    <!-- RECIPE GRID + SIDEBAR -->
    <section class="py-16 px-6 max-w-7xl mx-auto">
      <div class="flex gap-8">
      <!-- Main Content -->
      <div class="flex-1 min-w-0">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-8">
        <template x-for="recipe in visibleRecipes" x-bind:key="recipe.id">
          <div
            class="recipe-card-hover group hyper-border rounded-2xl overflow-hidden flex flex-col h-full"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4"
            x-transition:enter-end="opacity-100 translate-y-0"
          >
            <div class="relative aspect-[4/3] overflow-hidden" style="background-color: var(--bg-tertiary);">
              <template x-if="recipe.img">
                <img x-bind:src="recipe.img" class="recipe-img w-full h-full object-cover" x-bind:alt="recipe.title" />
              </template>
              <div class="absolute top-4 left-4 flex gap-2">
                <span class="bg-black/80 backdrop-blur-md text-[9px] font-black px-2 py-1 rounded" style="color: var(--accent-primary);" x-text="recipe.time"></span>
                <span class="bg-black/80 backdrop-blur-md text-[9px] font-black px-2 py-1 rounded text-white" x-text="recipe.category.toUpperCase()"></span>
              </div>
            </div>
            <div class="p-6 flex-grow flex flex-col justify-between">
              <div>
                <h4 class="text-xl font-black tracking-tight mb-4 group-hover-accent-text transition-colors" x-text="recipe.title"></h4>
                <div class="grid grid-cols-2 gap-px border rounded-lg overflow-hidden mb-6" style="background-color: var(--bg-tertiary); border-color: var(--border-default);">
                  <div class="p-3 text-center" style="background-color: var(--bg-primary);">
                    <span class="block text-[8px] font-black uppercase tracking-widest mb-1" style="color: var(--text-secondary);">{t('common.protein')}</span>
                    <span class="text-lg font-black tracking-tighter" style="color: var(--accent-primary);" x-text="recipe.protein"></span>
                  </div>
                  <div class="p-3 text-center" style="background-color: var(--bg-primary);">
                    <span class="block text-[8px] font-black uppercase tracking-widest mb-1" style="color: var(--text-secondary);">{t('common.calories')}</span>
                    <span class="text-lg font-black tracking-tighter" x-text="recipe.cals"></span>
                  </div>
                </div>
              </div>
              <a x-bind:href="recipe.slug ? hubPath + 'recipes/' + recipe.slug + '/' : hubPath" class="w-full py-4 text-[10px] font-black uppercase tracking-widest rounded-xl text-center transition-all flex items-center justify-center gap-2 hover-accent-bg hover-inverse-text" style="background-color: var(--bg-tertiary);">
                View Protocol <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
              </a>
            </div>
          </div>
        </template>
      </div>
      <div class="mt-20 flex flex-col items-center">
        <div x-show="!allShown" class="w-full max-w-xs h-1 rounded-full mb-6 relative overflow-hidden" style="background-color: var(--bg-secondary);">
          <div class="absolute top-0 left-0 h-full transition-all duration-500" x-bind:style="'width: ' + Math.round(Math.min(showCount, totalFiltered) / totalFiltered * 100) + '%; background-color: var(--accent-primary);'"></div>
        </div>
        <button
          x-show="!allShown"
          x-on:click="showCount += 6"
          class="hyper-border px-8 py-4 rounded-full text-[10px] font-black uppercase tracking-widest flex items-center gap-4 hover:scale-105 transition-transform cursor-pointer"
        >
          Retrieve Additional Inventory <span style="color: var(--text-secondary);">(Showing <span x-text="Math.min(showCount, totalFiltered)"></span> of <span x-text="totalFiltered"></span>)</span>
        </button>
      </div>
      </div><!-- /main content -->

      <!-- RIGHT SIDEBAR -->
      <aside class="hidden lg:block w-80 shrink-0">
        <div class="sticky top-[90px] space-y-6">
          {executionNotes && (
            <div class="rounded-2xl p-6" style="background-color: var(--bg-secondary); border: 1px solid var(--border-default);">
              <h3 class="text-[10px] font-black uppercase tracking-[0.3em] mb-6" style="color: var(--text-primary);">{t('category.executionNotes')}</h3>
              <div class="mb-6">
                <span class="text-[10px] font-black uppercase tracking-widest block mb-2" style="color: var(--accent-primary);">{t('category.batchingRule')}</span>
                <p class="text-sm font-medium leading-relaxed" style="color: var(--text-secondary);">{executionNotes.batchingRule}</p>
              </div>
              <div class="mb-4">
                <span class="text-[10px] font-black uppercase tracking-widest block mb-2" style="color: var(--accent-primary);">{t('category.storageLogic')}</span>
                <p class="text-sm font-medium leading-relaxed" style="color: var(--text-secondary);">{executionNotes.storageLogic}</p>
              </div>
              <div class="h-1 rounded-full overflow-hidden" style="background-color: var(--bg-tertiary);">
                <div class="h-full w-1/3" style="background-color: var(--accent-primary);"></div>
              </div>
            </div>
          )}

          {relatedMethods.length > 0 && (
            <div>
              <h3 class="text-[10px] font-black uppercase tracking-[0.3em] mb-4" style="color: var(--text-secondary);">{t('category.relatedMethods')}</h3>
              <div class="space-y-3">
                {relatedMethods.map(rm => (
                  <a href={rm.href} class="block p-5 rounded-2xl transition-all group" style="background-color: var(--bg-secondary); border: 1px solid var(--border-default);">
                    <span class="text-[9px] font-black uppercase tracking-widest block mb-1" style="color: var(--text-tertiary);">{t('category.swapMethod')}</span>
                    <span class="text-base font-black group-hover:opacity-80 transition-opacity">{rm.label}</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          {planCard && (
            <div class="rounded-2xl p-6" style="background-color: var(--bg-inverse, #fff); color: var(--text-inverse, #000);" x-data="{ generating: false }">
              <span class="text-[10px] font-black uppercase tracking-widest block mb-3" style="color: var(--accent-primary);">{t('category.systemUpdate')}</span>
              <h4 class="text-xl font-black tracking-tight mb-2">{planCard.title}</h4>
              <p class="text-sm font-medium mb-5 opacity-70">{planCard.description}</p>
              <button
                x-show="!generating"
                @click={`
                  if (!window.authHelper?.isSignedIn()) {
                    window.authHelper?.openSignIn();
                    return;
                  }
                  generating = true;
                  window.__generatePrepPDF('${headline}', recipes, '${hub}');
                  setTimeout(() => generating = false, 3000);
                `}
                class="block w-full py-3 rounded-full text-center text-[10px] font-black uppercase tracking-widest cursor-pointer transition-all hover:opacity-80"
                style="background-color: var(--text-primary, #000); color: var(--bg-primary, #fff);"
              >
                Generate PDF
              </button>
              <div x-show="generating" class="flex items-center justify-center py-3 gap-2">
                <div class="w-4 h-4 border-2 border-t-transparent rounded-full animate-spin" style="border-color: var(--text-primary, #000); border-top-color: transparent;"></div>
                <span class="text-[10px] font-black uppercase tracking-widest">{t('category.generating')}</span>
              </div>
            </div>
          )}
        </div>
      </aside>
      </div>
    </section>

    <!-- PLAN CTA -->
    <PlanCTA hub={hub} />

    <!-- INTERNAL LINKS -->
    {exploreColumns.length > 0 && (
      <ExploreByBlock headline={`OPTIMIZE YOUR ${headline.toUpperCase()} STACK`} columns={exploreColumns} />
    )}

    <!-- FAQ -->
    {faqs.length > 0 && (
      <section class="py-24 px-6 max-w-3xl mx-auto">
        <h2 class="text-4xl font-black tracking-tighter mb-12 text-center">{t('common.technicalRecap')}</h2>
        <div class="space-y-4">
          {faqs.map((faq, index) => (
            <div class="border rounded-2xl overflow-hidden" style="border-color: var(--border-default);">
              <button
                x-on:click={`activeFaq = (activeFaq === ${index} ? null : ${index})`}
                class="w-full p-6 text-left flex justify-between items-center hover-bg-secondary transition-colors"
                style="background-color: color-mix(in srgb, var(--bg-secondary) 30%, transparent);"
              >
                <span class="font-bold text-sm">{faq.question}</span>
                <span class="font-black text-xl" style="color: var(--accent-primary);" x-text={`activeFaq === ${index} ? '-' : '+'`}></span>
              </button>
              <div
                x-show={`activeFaq === ${index}`}
                x-cloak
                class="p-6 text-sm leading-relaxed border-t"
                style="color: var(--text-secondary); border-color: var(--border-default); background-color: color-mix(in srgb, var(--bg-secondary) 10%, transparent);"
              >
                <p>{faq.answer}</p>
              </div>
            </div>
          ))}
        </div>
      </section>
    )}
  </main>

  <FooterNav copyrightSuffix={`Index Authority Network. Facet: Method/${headline}.`} />

  <!-- PDF Generation Script -->
  <script is:inline>
    window.__generatePrepPDF = function(method, recipes, hub) {
      // Build a printable prep sheet and trigger browser print-to-PDF
      var recipeList = typeof recipes === 'string' ? JSON.parse(recipes) : recipes;
      var dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
      var hubLabel = hub === 'meal-prep' ? 'Meal Prep' : 'High Protein';

      var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
      html += '<title>' + method + ' Prep Sheet</title>';
      html += '<style>';
      html += 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px 24px; color: #1a1a1a; }';
      html += 'h1 { font-size: 28px; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 4px; }';
      html += '.subtitle { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: #888; margin-bottom: 24px; }';
      html += '.day-label { font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 3px; color: #7E9680; margin-top: 28px; margin-bottom: 8px; border-top: 1px solid #eee; padding-top: 16px; }';
      html += '.recipe-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }';
      html += '.recipe-title { font-size: 14px; font-weight: 700; }';
      html += '.recipe-meta { font-size: 12px; color: #666; }';
      html += '.section-title { font-size: 12px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; margin-top: 32px; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #1a1a1a; }';
      html += '.checklist { list-style: none; padding: 0; }';
      html += '.checklist li { padding: 6px 0; border-bottom: 1px solid #f5f5f5; font-size: 13px; }';
      html += '.checklist li:before { content: "☐ "; font-size: 14px; }';
      html += '.notes-box { border: 1px solid #ddd; border-radius: 8px; padding: 16px; min-height: 80px; margin-top: 8px; font-size: 12px; color: #999; }';
      html += '.footer { margin-top: 40px; text-align: center; font-size: 10px; color: #bbb; text-transform: uppercase; letter-spacing: 1px; }';
      html += '@media print { body { padding: 20px; } .no-print { display: none; } }';
      html += '</style></head><body>';

      // Header
      html += '<h1>' + method + ' Prep Sheet</h1>';
      html += '<div class="subtitle">' + hubLabel + ' &middot; ' + recipeList.length + ' Recipes &middot; Generated ' + new Date().toLocaleDateString() + '</div>';

      // Assign recipes to days
      var perDay = Math.ceil(recipeList.length / 5);
      for (var d = 0; d < 5 && d * perDay < recipeList.length; d++) {
        html += '<div class="day-label">' + dayNames[d] + '</div>';
        var dayRecipes = recipeList.slice(d * perDay, (d + 1) * perDay);
        for (var r = 0; r < dayRecipes.length; r++) {
          var rec = dayRecipes[r];
          html += '<div class="recipe-row">';
          html += '<span class="recipe-title">' + rec.title + '</span>';
          html += '<span class="recipe-meta">' + (rec.protein || '') + 'P &middot; ' + (rec.cals || '') + ' cal &middot; ' + (rec.time || '') + '</span>';
          html += '</div>';
        }
      }

      // Sunday Prep Checklist
      html += '<div class="section-title">Sunday Prep Checklist</div>';
      html += '<ul class="checklist">';
      html += '<li>Wash and chop all vegetables</li>';
      html += '<li>Portion proteins into containers</li>';
      html += '<li>Prepare marinades and sauces</li>';
      html += '<li>Cook grains and bases in batch</li>';
      html += '<li>Assemble and label containers</li>';
      html += '<li>Check freezer space</li>';
      html += '</ul>';

      // Shopping List Header
      html += '<div class="section-title">Quick Shopping List</div>';
      var ingredients = {};
      recipeList.forEach(function(rec) {
        var cat = rec.category || 'General';
        if (!ingredients[cat]) ingredients[cat] = [];
        ingredients[cat].push(rec.title);
      });
      html += '<ul class="checklist">';
      recipeList.forEach(function(rec) {
        html += '<li>' + rec.title + ' ingredients</li>';
      });
      html += '</ul>';

      // Notes
      html += '<div class="section-title">Notes</div>';
      html += '<div class="notes-box">Write your personal notes, substitutions, and timing adjustments here...</div>';

      // Footer
      html += '<div class="footer">Generated by ' + (hub === 'meal-prep' ? 'MealPrepIdeas.co' : 'ProteinMeals.co') + '</div>';

      // Print button
      html += '<div class="no-print" style="text-align:center;margin-top:24px;">';
      html += '<button onclick="window.print()" style="background:#1a1a1a;color:#fff;border:none;padding:12px 32px;border-radius:999px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:2px;cursor:pointer;">Print / Save as PDF</button>';
      html += '</div>';

      html += '</body></html>';

      // Open in new window for print
      var win = window.open('', '_blank');
      win.document.write(html);
      win.document.close();
    };
  </script>
</BaseLayout>
