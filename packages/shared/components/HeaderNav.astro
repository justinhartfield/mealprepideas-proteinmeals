---
/**
 * HeaderNav — Theme-aware sticky navigation bar
 * Uses CSS custom properties from themes.css
 */
import ThemeToggle from './ThemeToggle.astro';
import LanguageSwitcher from './LanguageSwitcher.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

// i18n — must be before nav arrays that use t()
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface Props {
  site?: 'mealprepideas' | 'proteinmeals';
  brandLabel?: string;
  brandName?: string;
  activeLink?: string;
  navLinks?: { href: string; label: string }[];
  statusText?: string;
  statusBadge?: string;
}

const mealprepNav = [
  { href: '/', label: t('nav.home') },
  { href: '/meal-prep/', label: t('nav.hub') },
  { href: '/meal-prep/method/', label: t('nav.methods') },
  { href: '/meal-prep/persona/', label: t('nav.personas') },
  { href: '/meal-prep/store/', label: t('nav.stores') },
  { href: '/meal-prep/constraint/', label: t('nav.plans') },
  { href: '/tools/', label: t('nav.tools') },
];

const proteinNav = [
  { href: '/', label: t('nav.home') },
  { href: '/high-protein/', label: t('nav.hpHub') },
  { href: '/high-protein/method/', label: t('nav.methods') },
  { href: '/high-protein/diet/', label: t('nav.diets') },
  { href: '/high-protein/goal/', label: t('nav.goals') },
  { href: '/high-protein/persona/', label: t('nav.personas') },
  { href: '/stores/', label: t('nav.stores') },
  { href: '/tools/', label: t('nav.tools') },
];

// Auto-detect site from the Astro site config URL
const siteUrl = Astro.site?.href || Astro.site?.toString() || Astro.site?.hostname || '';
const autoSite = siteUrl.includes('proteinmeals') ? 'proteinmeals' : 'mealprepideas';

const {
  site = autoSite,
  brandLabel = site === 'proteinmeals' ? t('nav.brandHP') : t('nav.brand'),
  brandName = site === 'proteinmeals' ? 'PROTEINMEALS.CO' : 'MEALPREPIDEAS.CO',
  activeLink,
  navLinks = site === 'proteinmeals' ? proteinNav : mealprepNav,
  statusText,
  statusBadge,
} = Astro.props;

---

<header class="glass-nav sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
  <div class="flex items-center space-x-8">
    <a href="/" class="flex flex-col leading-none group">
      <span class="text-[10px] uppercase tracking-[0.3em] mb-1 font-bold transition-colors"
            style="color: var(--text-tertiary);">{brandLabel}</span>
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full" style="background-color: var(--accent-primary);"></div>
        <span class="text-xl font-black tracking-tighter italic" style="color: var(--text-primary);">{brandName}</span>
      </div>
    </a>
    <nav class="hidden md:flex space-x-6 text-xs font-bold uppercase tracking-widest" style="color: var(--text-secondary);">
      {navLinks.map((link, i) => (
        <>
          {i > 0 && <span style="color: var(--border-default);">/</span>}
          <a
            href={link.href}
            class="transition-colors hover:opacity-100"
            style={activeLink === link.href
              ? `color: var(--text-primary); border-bottom: 2px solid var(--accent-primary); padding-bottom: 4px;`
              : `color: var(--text-secondary);`}
          >
            {link.label}
          </a>
        </>
      ))}
    </nav>
  </div>

  <div class="flex items-center space-x-4">
    {statusText && (
      <div class="hidden md:block">
        <div class="flex items-center gap-3 px-4 py-2 rounded-lg"
             style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
          <span class="text-[10px] font-bold uppercase tracking-widest" style="color: var(--text-tertiary);">{statusText}</span>
          {statusBadge && <span class="text-[10px] font-bold animate-pulse" style="color: var(--accent-primary);">{statusBadge}</span>}
        </div>
      </div>
    )}
    <LanguageSwitcher />
    <ThemeToggle />

    <!-- Auth: Signed Out - Sign In Button -->
    <button
      data-auth-show="signed-out"
      onclick="window.authHelper && window.authHelper.openSignIn()"
      class="hidden md:flex items-center gap-2 px-4 py-2 rounded-full text-[11px] font-black uppercase tracking-wider cursor-pointer transition-all"
      style="background: var(--accent-primary); color: var(--text-inverse); border: none;">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
      </svg>
      {t('nav.signIn')}
    </button>

    <!-- Auth: Signed In - Avatar Dropdown -->
    <div data-auth-show="signed-in" style="display:none;" class="relative" x-data="{ open: false }">
      <button @click="open = !open" class="flex items-center gap-2 cursor-pointer" style="background:none; border:none;">
        <img data-clerk-avatar src="/images/placeholder.svg" alt="User" class="w-9 h-9 rounded-full object-cover" style="border: 2px solid var(--accent-primary);" />
      </button>
      <div x-show="open" @click.outside="open = false" x-transition
           class="absolute right-0 mt-2 w-56 rounded-xl py-2 z-50"
           style="background: var(--bg-secondary); border: 1px solid var(--border-default); box-shadow: var(--shadow-card-hover);">
        <div class="px-4 py-3" style="border-bottom: 1px solid var(--border-default);">
          <p class="text-xs font-black uppercase tracking-wider" style="color: var(--text-primary);" id="nav-user-name">User</p>
          <p class="text-[10px] mt-1" style="color: var(--text-tertiary);" id="nav-user-email">—</p>
        </div>
        <a href="/profile/" class="flex items-center gap-3 px-4 py-2.5 text-xs font-bold transition-colors" style="color: var(--text-secondary); text-decoration: none;">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
          {t('nav.profile')}
        </a>
        <a href="/profile/#saved" class="flex items-center gap-3 px-4 py-2.5 text-xs font-bold transition-colors" style="color: var(--text-secondary); text-decoration: none;">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
          {t('nav.savedRecipes')}
        </a>
        <a href="/profile/#macros" class="flex items-center gap-3 px-4 py-2.5 text-xs font-bold transition-colors" style="color: var(--text-secondary); text-decoration: none;">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
          {t('nav.macroCalc')}
        </a>
        <div style="border-top: 1px solid var(--border-default); margin-top: 0.25rem; padding-top: 0.25rem;">
          <button onclick="window.authHelper && window.authHelper.signOut()" class="flex items-center gap-3 px-4 py-2.5 text-xs font-bold w-full text-left cursor-pointer" style="color: var(--accent-primary); background:none; border:none;">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            {t('nav.signOut')}
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Sign In (small screens) -->
    <button
      data-auth-show="signed-out"
      onclick="window.authHelper && window.authHelper.openSignIn()"
      class="md:hidden w-10 h-10 rounded-lg flex items-center justify-center cursor-pointer transition-all"
      style="background: var(--accent-primary); border: none; color: var(--text-inverse);">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
      </svg>
    </button>

    <div class="w-10 h-10 rounded-lg flex items-center justify-center cursor-pointer transition-all"
         style="background: var(--bg-secondary); border: 1px solid var(--border-default); color: var(--text-secondary);">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
  </div>
</header>

<script is:inline>
  window.addEventListener('clerk-ready', function() {
    var user = window.authHelper && window.authHelper.getUser();
    if (user) {
      var nameEl = document.getElementById('nav-user-name');
      var emailEl = document.getElementById('nav-user-email');
      if (nameEl) nameEl.textContent = user.fullName || user.firstName || 'User';
      if (emailEl) emailEl.textContent = user.primaryEmailAddress ? user.primaryEmailAddress.emailAddress : '';
    }
  });
</script>
