---
/**
 * GlobalDiscoveryLanding — Homepage / Entry Portal
 * Theme-aware: uses CSS custom properties for light/dark support
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import FacetNav from './FacetNav.astro';
import { recipes } from '../data/content/recipes';
import { plans } from '../data/content/plans';
import { stores } from '../data/content/stores';
import {
  getTotalStrategies,
  getAverageProtein,
  getFastFoodChains,
  getRecipeCount,
  getPlanCount,
  getFirstPlanShoppingList,
} from '../utils/stats';

const featuredMealPrep = recipes.filter(r => r.hub === 'meal-prep').slice(0, 3);
const featuredProtein = recipes.filter(r => r.hub === 'high-protein').slice(0, 3);
const fallbackImg = '/images/placeholder.svg';

// Dynamic stats
const totalStrategies = getTotalStrategies();
const avgProtein = getAverageProtein();
const recipeCount = getRecipeCount();
const planCount = getPlanCount();

// Dynamic chain data from stores
const fastFoodChains = getFastFoodChains().slice(0, 4);
const chainNames = fastFoodChains.map(c => c.name.toUpperCase());

// Real shopping list from first plan
const shoppingListItems = getFirstPlanShoppingList();

// Store abbreviation badges with links
const storeBadges = [
  { abbr: 'TJ', slug: 'trader-joes' },
  { abbr: 'CO', slug: 'costco' },
  { abbr: 'WM', slug: 'walmart' },
];

interface Props {
  title: string;
  description?: string;
  site?: "mealprepideas" | "proteinmeals";
}

const { title, description } = Astro.props;

const facetChips = [
  { label: 'Crockpot', href: '/meal-prep/method/crockpot/' },
  { label: 'Slow-Cooker', href: '/meal-prep/method/slow-cooker/' },
  { label: 'Trader Joes', href: '/stores/trader-joes/' },
  { label: 'Costco', href: '/stores/costco/' },
  { label: 'Weight-Loss', href: '/high-protein/goal/weight-loss/' },
  { label: 'Postpartum', href: '/meal-prep/persona/postpartum/' },
  { label: 'High Fiber', href: '/high-protein/constraint/high-fiber/' },
  { label: 'Budget', href: '/meal-prep/constraint/budget/' },
  { label: 'Chicken', href: '/meal-prep/ingredient/chicken/' },
  { label: 'Salmon', href: '/high-protein/ingredient/salmon/' },
  { label: 'Low-Sodium', href: '/high-protein/constraint/low-sodium/' },
  { label: 'Air-Fryer', href: '/meal-prep/method/air-fryer/' },
  { label: 'Walmart', href: '/stores/walmart/' },
  { label: 'Chick-Fil-A', href: '/stores/chick-fil-a/' },
  { label: 'Bariatric', href: '/high-protein/persona/bariatric/' },
  { label: 'College', href: '/meal-prep/persona/college/' },
];
---

<BaseLayout title={title} description={description}>
  <HeaderNav />

  <main class="flex-grow" x-data="{ activeHub: 'all', openFilter: false }">
    <!-- HERO: GATEWAY MODULE -->
    <section class="relative min-h-[70vh] flex flex-col md:flex-row overflow-hidden"
             style="border-bottom: 1px solid var(--border-default);">
      <!-- PORTAL 1: MEAL PREP -->
      <a href="/meal-prep/"
         x-on:mouseenter="activeHub = 'meal-prep'"
         x-on:mouseleave="activeHub = 'all'"
         class="relative flex-1 group transition-all duration-700 ease-out flex flex-col justify-end p-12 overflow-hidden"
         style="border-right: 1px solid var(--border-default);"
         x-bind:class="activeHub === 'high-protein' ? 'opacity-30' : 'opacity-100'">
        <div class="absolute inset-0 transition-colors" style="background-color: var(--bg-secondary);"></div>
        <img src="/images/hero-meal-prep.jpg" onerror="this.onerror=null;this.src='/images/placeholder.svg'"
             class="absolute inset-0 w-full h-full object-cover mix-blend-overlay opacity-20 group-hover:opacity-40 transition-opacity duration-700" alt="Meal Prep" width="1200" height="675" />
        <div class="relative z-10">
          <span class="text-xs font-bold tracking-[0.5em] block mb-4" style="color: var(--accent-primary);">OPTIMIZE LOGISTICS</span>
          <h2 class="text-6xl md:text-8xl font-black tracking-tighter mb-4 leading-none" style="color: var(--text-primary);">MEAL<br/>PREP</h2>
          <p class="max-w-xs font-medium text-sm leading-relaxed mb-8" style="color: var(--text-secondary);">Batching, logistics, storage, and 5-day protocols for high-performance living.</p>
          <div class="flex gap-2">
            {['Crockpot', 'No-Cook', 'Freezer'].map(tag => (
              <span class="px-3 py-1 rounded-full text-[10px] uppercase font-bold tracking-widest transition-colors"
                    style="border: 1px solid var(--border-default); color: var(--text-secondary);">{tag}</span>
            ))}
          </div>
        </div>
        <div class="scanner-line opacity-0 group-hover:opacity-100"></div>
      </a>

      <!-- PORTAL 2: HIGH PROTEIN -->
      <a href="/high-protein/"
         x-on:mouseenter="activeHub = 'high-protein'"
         x-on:mouseleave="activeHub = 'all'"
         class="relative flex-1 group transition-all duration-700 ease-out flex flex-col justify-end p-12 overflow-hidden"
         x-bind:class="activeHub === 'meal-prep' ? 'opacity-30' : 'opacity-100'">
        <div class="absolute inset-0 transition-colors" style="background-color: var(--bg-secondary);"></div>
        <img src="/images/hero-high-protein.jpg" onerror="this.onerror=null;this.src='/images/placeholder.svg'"
             class="absolute inset-0 w-full h-full object-cover mix-blend-overlay opacity-20 group-hover:opacity-40 transition-opacity duration-700" alt="High Protein" width="1200" height="675" />
        <div class="relative z-10">
          <span class="text-xs font-bold tracking-[0.5em] block mb-4" style="color: var(--accent-primary);">OPTIMIZE MACROS</span>
          <h2 class="text-6xl md:text-8xl font-black tracking-tighter mb-4 leading-none" style="color: var(--text-primary);">HIGH<br/>PROTEIN</h2>
          <p class="max-w-xs font-medium text-sm leading-relaxed mb-8" style="color: var(--text-secondary);">Muscle gain, weight loss, and fast-food survival guides with hard calorie bands.</p>
          <div class="flex gap-2">
            {['Weight Loss', 'Muscle Gain', 'Bariatric'].map(tag => (
              <span class="px-3 py-1 rounded-full text-[10px] uppercase font-bold tracking-widest transition-colors"
                    style="border: 1px solid var(--border-default); color: var(--text-secondary);">{tag}</span>
            ))}
          </div>
        </div>
        <div class="scanner-line opacity-0 group-hover:opacity-100"></div>
      </a>
    </section>

    <!-- SEARCH & SOLVE WIDGET -->
    <section class="py-20 px-6 max-w-7xl mx-auto" x-data="{
      goal: 'Weight Loss',
      method: 'Air Fryer',
      diet: 'Low Carb',
      generateIndex() {
        const goalMap = { 'Weight Loss': 'weight-loss', 'Muscle Gain': 'muscle-gain', 'Healthy (General)': 'healthy' };
        const methodMap = { 'Air Fryer': 'air-fryer', 'Crockpot': 'crockpot', 'No-Cook': 'no-cook', 'Microwave': 'microwave', 'Instant Pot': 'instant-pot' };
        const dietMap = { 'Low Carb': 'low-carb', 'Vegan': 'vegan', 'High Protein': 'keto', 'Gluten Free': 'gluten-free' };
        const g = goalMap[this.goal];
        const m = methodMap[this.method];
        const d = dietMap[this.diet];
        if (g) { window.location.href = '/high-protein/goal/' + g + '/'; }
        else if (m) { window.location.href = '/meal-prep/method/' + m + '/'; }
        else if (d) { window.location.href = '/high-protein/diet/' + d + '/'; }
        else { window.location.href = '/meal-prep/'; }
      }
    }">
      <div class="flex flex-col md:flex-row items-end justify-between mb-12 gap-8">
        <div class="max-w-xl">
          <div class="flex items-center gap-4 mb-4">
            <div class="h-[1px] w-12" style="background-color: var(--accent-primary);"></div>
            <span class="text-[10px] uppercase font-black tracking-widest" style="color: var(--accent-primary);">Smart Query Engine</span>
          </div>
          <h3 class="text-4xl font-black tracking-tight leading-none mb-4" style="color: var(--text-primary);">SYSTEMATIC SELECTION</h3>
          <p class="font-medium" style="color: var(--text-secondary);">Use the inventory controls below to generate a precise meal protocol matching your biological and logistical constraints.</p>
        </div>
        <div class="text-right">
          <span class="text-[40px] font-black tabular-nums tracking-tighter block leading-none" style="color: var(--text-primary);">{totalStrategies}</span>
          <span class="text-[10px] font-bold uppercase tracking-widest" style="color: var(--text-secondary);">Recipes & Plans</span>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 rounded-2xl"
           style="background: var(--bg-tertiary); border: 1px solid var(--border-default);">
        <div class="p-6 rounded-xl flex flex-col justify-between transition-all"
             style="background: var(--select-bg); border: 1px solid var(--select-border);">
          <label class="text-[10px] font-black uppercase tracking-widest mb-6 block" style="color: var(--text-tertiary);">01. Primary Goal</label>
          <select x-model="goal" class="bg-transparent text-xl font-bold tracking-tight outline-none w-full appearance-none cursor-pointer" style="color: var(--text-primary);">
            <option>Weight Loss</option>
            <option>Muscle Gain</option>
            <option>Healthy (General)</option>
          </select>
        </div>
        <div class="p-6 rounded-xl flex flex-col justify-between transition-all"
             style="background: var(--select-bg); border: 1px solid var(--select-border);">
          <label class="text-[10px] font-black uppercase tracking-widest mb-6 block" style="color: var(--text-tertiary);">02. Method</label>
          <select x-model="method" class="bg-transparent text-xl font-bold tracking-tight outline-none w-full appearance-none cursor-pointer" style="color: var(--text-primary);">
            <option>Air Fryer</option>
            <option>Crockpot</option>
            <option>No-Cook</option>
            <option>Microwave</option>
            <option>Instant Pot</option>
          </select>
        </div>
        <div class="p-6 rounded-xl flex flex-col justify-between transition-all"
             style="background: var(--select-bg); border: 1px solid var(--select-border);">
          <label class="text-[10px] font-black uppercase tracking-widest mb-6 block" style="color: var(--text-tertiary);">03. Diet Type</label>
          <select x-model="diet" class="bg-transparent text-xl font-bold tracking-tight outline-none w-full appearance-none cursor-pointer" style="color: var(--text-primary);">
            <option>Low Carb</option>
            <option>Vegan</option>
            <option>High Protein</option>
            <option>Gluten Free</option>
          </select>
        </div>
        <button x-on:click="generateIndex()" class="theme-btn-cta rounded-xl p-6 flex flex-col items-center justify-center transition-all group overflow-hidden relative cursor-pointer">
          <span class="relative z-10 text-xl font-black uppercase tracking-tight">Generate Index</span>
          <span class="relative z-10 text-[10px] font-bold opacity-60">MATCHING DATA POINTS</span>
        </button>
      </div>
    </section>

    <!-- TRENDING RECIPES -->
    <section class="py-20 px-6 max-w-7xl mx-auto">
      <div class="flex items-center gap-4 mb-12">
        <div class="h-[2px] w-16" style="background-color: var(--accent-primary);"></div>
        <h3 class="text-xs font-black tracking-[0.5em] uppercase" style="color: var(--text-tertiary);">Trending Recipes</h3>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Meal Prep Column -->
        <div>
          <h4 class="text-lg font-black tracking-tight mb-6 uppercase" style="color: var(--text-primary);">Meal Prep</h4>
          <div class="space-y-4">
            {featuredMealPrep.map(r => (
              <a href={`/meal-prep/recipes/${r.slug}/`} class="flex gap-4 items-center group p-3 rounded-xl transition-all hover:shadow-md" style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
                <div class="w-20 h-20 rounded-xl overflow-hidden flex-shrink-0">
                  <img
                    src={`/images/recipes/${r.slug}.jpg`}
                    onerror={`this.onerror=null;this.src='${fallbackImg}'`}
                    alt={r.imageAlt || r.title}
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                    width="80"
                    height="80"
                    loading="lazy"
                  />
                </div>
                <div class="flex-1 min-w-0">
                  <h5 class="font-black text-sm mb-1 truncate group-hover:opacity-80 transition-opacity">{r.title}</h5>
                  <div class="flex gap-3 text-[10px] font-bold" style="color: var(--text-tertiary);">
                    <span>{r.protein}g protein</span>
                    <span>·</span>
                    <span>{r.calories} cal</span>
                    <span>·</span>
                    <span>{r.prepTime + r.cookTime}m</span>
                  </div>
                </div>
              </a>
            ))}
        </div>
        </div>
        <!-- High Protein Column -->
        <div>
          <h4 class="text-lg font-black tracking-tight mb-6 uppercase" style="color: var(--text-primary);">High Protein</h4>
          <div class="space-y-4">
            {featuredProtein.map(r => (
              <a href={`/high-protein/recipes/${r.slug}/`} class="flex gap-4 items-center group p-3 rounded-xl transition-all hover:shadow-md" style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
                <div class="w-20 h-20 rounded-xl overflow-hidden flex-shrink-0">
                  <img
                    src={`/images/recipes/${r.slug}.jpg`}
                    onerror={`this.onerror=null;this.src='${fallbackImg}'`}
                    alt={r.imageAlt || r.title}
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                    width="80"
                    height="80"
                    loading="lazy"
                  />
                </div>
                <div class="flex-1 min-w-0">
                  <h5 class="font-black text-sm mb-1 truncate group-hover:opacity-80 transition-opacity">{r.title}</h5>
                  <div class="flex gap-3 text-[10px] font-bold" style="color: var(--text-tertiary);">
                    <span>{r.protein}g protein</span>
                    <span>·</span>
                    <span>{r.calories} cal</span>
                    <span>·</span>
                    <span>{r.prepTime + r.cookTime}m</span>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- FACET MEGA-NAV (CHIPS) -->
    <FacetNav chips={facetChips} />

    <!-- TOP CLUSTERS (BENTO GRID) -->
    <section class="py-24 px-6 max-w-7xl mx-auto">
      <h4 class="text-4xl font-black tracking-tighter mb-12" style="color: var(--text-primary);">FEATURED AUTHORITY PACKS</h4>
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- PACK A: HIGH PROTEIN FROZEN -->
        <div class="md:col-span-8 hyper-border rounded-3xl p-8 min-h-[400px] flex flex-col justify-between group overflow-hidden relative">
          <img src="/images/hero-high-protein.jpg" onerror="this.onerror=null;this.src='/images/placeholder.svg'"
               class="absolute inset-0 w-full h-full object-cover opacity-10 group-hover:scale-105 transition-transform duration-700" alt="High-protein frozen meals and store picks" />
          <div>
            <div class="flex gap-2 mb-6">
              <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--accent-primary); color: var(--text-inverse);">Pack 01</span>
              <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background: var(--bg-tertiary); color: var(--text-primary);">150+ Pages</span>
            </div>
            <h5 class="text-5xl font-black tracking-tighter mb-4 leading-none" style="color: var(--text-primary);">High-Protein<br/>Frozen Index</h5>
            <p class="max-w-sm font-medium" style="color: var(--text-secondary);">Trader Joe's, Costco, and Walmart SKU deep-dives sorted by macro-density.</p>
          </div>
          <div class="flex items-center justify-between mt-8 relative z-10">
            <div class="flex -space-x-3">
              {storeBadges.map(badge => (
                <a href={`/stores/${badge.slug}/`} class="w-10 h-10 rounded-full flex items-center justify-center text-[10px] font-bold hover:scale-110 transition-transform"
                     style="background: var(--bg-tertiary); border: 2px solid var(--bg-primary); color: var(--text-primary);">{badge.abbr}</a>
              ))}
            </div>
            <a href="/stores/trader-joes/" class="text-[10px] font-black uppercase tracking-[0.2em] transition-colors flex items-center gap-2" style="color: var(--text-secondary);">
              View Full Pack <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
            </a>
          </div>
        </div>

        <!-- PACK B: POSTPARTUM -->
        <div class="md:col-span-4 rounded-3xl p-8 flex flex-col justify-between group"
             style="background-color: var(--accent-primary); color: var(--text-inverse); border: 1px solid var(--border-default);">
          <div>
            <div class="flex gap-2 mb-6">
              <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase"
                    style="background: var(--text-primary); color: var(--bg-primary);">High Sticky</span>
            </div>
            <h5 class="text-3xl font-black tracking-tighter mb-4 leading-tight">Postpartum<br/>Freezer Stash</h5>
            <p class="font-medium text-sm opacity-70">Targeted recovery nutrition for new mothers. High-fiber, anti-inflammatory protocols.</p>
          </div>
          <div class="mt-8">
            <a href="/meal-prep/persona/postpartum/" class="w-full py-4 rounded-xl font-black uppercase text-xs tracking-widest flex items-center justify-center transition-colors"
               style="background: var(--text-primary); color: var(--bg-primary);">
              Explore Vault
            </a>
          </div>
        </div>

        <!-- PACK C: NO MICROWAVE -->
        <a href="/meal-prep/constraint/no-microwave/" class="md:col-span-4 hyper-border rounded-3xl p-8 flex flex-col justify-between group block">
          <div class="mb-8">
            <span class="text-[10px] font-black uppercase tracking-widest mb-4 block" style="color: var(--text-tertiary);">Persona: Office</span>
            <h5 class="text-3xl font-black tracking-tighter leading-tight" style="color: var(--text-primary);">No-Microwave Work Lunches</h5>
          </div>
          <div class="space-y-4">
            <div class="flex justify-between items-center text-xs font-bold pb-2" style="border-bottom: 1px solid var(--border-default);">
              <span style="color: var(--text-tertiary);">Constraint</span>
              <span style="color: var(--text-primary);">Cold / Ambient</span>
            </div>
            <div class="flex justify-between items-center text-xs font-bold pb-2" style="border-bottom: 1px solid var(--border-default);">
              <span style="color: var(--text-tertiary);">Avg Protein</span>
              <span style="color: var(--text-primary);">{avgProtein}g / serving</span>
            </div>
          </div>
        </a>

        <!-- PACK D: FAST FOOD MATRIX -->
        <div class="md:col-span-8 rounded-3xl p-8 flex flex-col md:flex-row gap-8 items-center"
             style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
          <div class="flex-1">
            <h5 class="text-4xl font-black tracking-tighter mb-4" style="color: var(--text-primary);">Fast-Food Chain Modification Guides</h5>
            <p class="text-sm mb-6" style="color: var(--text-secondary);">How to hack Chick-Fil-A, McDonalds, and Chipotle for maximum protein with zero sauce-slop.</p>
            <div class="flex flex-wrap gap-2">
              {fastFoodChains.map(chain => (
                <a href={`/stores/${chain.slug}/`} class="text-[9px] font-black px-2 py-1 rounded transition-colors hover:opacity-80" style="border: 1px solid var(--border-default); color: var(--text-primary);">{chain.name.toUpperCase()}</a>
              ))}
            </div>
          </div>
          <div class="w-full md:w-48 h-48 rounded-2xl flex items-center justify-center p-4"
               style="background: var(--bg-tertiary);">
            <div class="w-full h-full rounded-xl flex flex-col items-center justify-center text-center"
                 style="border: 2px dashed var(--border-default);">
              <span class="text-4xl font-black tracking-tighter" style="color: var(--text-primary);">{recipeCount}</span>
              <span class="text-[8px] font-bold uppercase tracking-widest" style="color: var(--text-tertiary);">Recipes</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FEATURED PLANS (5-DAY PROTOCOL) -->
    <section class="py-24 overflow-hidden" style="background: var(--bg-secondary);">
      <div class="px-6 max-w-7xl mx-auto flex flex-col md:flex-row gap-16 items-center">
        <div class="flex-1">
          <span class="text-[10px] font-black tracking-[0.5em] uppercase mb-4 block" style="color: var(--text-tertiary);">Retention Module</span>
          <h2 class="text-6xl md:text-8xl font-black tracking-tighter leading-[0.8] mb-8" style="color: var(--text-primary);">THE 5-DAY<br/>PROTOCOL</h2>
          <p class="text-xl font-medium mb-8" style="color: var(--text-secondary);">Download the Sunday Prep Execution Plan. 90 minutes of work for 15 high-protein meals.</p>
          <div class="flex gap-4">
            <a href="/meal-prep/plans/beginner-meal-prep-5-day/" class="theme-btn-primary px-8 py-4 rounded-full font-black uppercase text-xs tracking-widest hover:scale-105 transition-transform inline-block">Get The Plan</a>
            <a href="/high-protein/plans/high-protein-muscle-gain-5-day/" class="px-8 py-4 rounded-full font-black uppercase text-xs tracking-widest transition-all inline-block"
                    style="border: 2px solid var(--text-primary); color: var(--text-primary);">Preview Steps</a>
          </div>
        </div>
        <div class="flex-1 relative">
          <div class="p-8 rounded-3xl rotate-3 shadow-2xl relative z-10"
               style="background: var(--bg-tertiary); border: 1px solid var(--border-default);">
            <div class="flex items-center justify-between mb-8 pb-4" style="border-bottom: 1px solid var(--border-default);">
              <span class="text-xs font-black tracking-widest" style="color: var(--text-primary);">SHOPPING LIST</span>
              <span class="text-xs font-bold" style="color: var(--text-tertiary);">#P-0042</span>
            </div>
            <div class="space-y-4">
              {shoppingListItems.slice(0, 4).map((item, i) => {
                const done = i === shoppingListItems.length - 1;
                return (
                  <div class="flex items-center gap-4">
                    <div class="w-4 h-4 rounded" style={`border: 2px solid var(--border-strong); ${done ? 'background: var(--text-primary);' : ''}`}></div>
                    <span class="text-sm font-bold" style={done ? 'color: var(--text-tertiary); text-decoration: line-through;' : `color: var(--text-primary);`}>{item}</span>
                  </div>
                );
              })}
            </div>
          </div>
          <div class="absolute top-0 right-0 w-full h-full rounded-3xl -rotate-6 -z-10" style="background-color: var(--accent-primary);"></div>
        </div>
      </div>
    </section>
  </main>

  <FooterNav />
</BaseLayout>
