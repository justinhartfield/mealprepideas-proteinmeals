---
/**
 * DietGoalCombo — Diet + Goal Combo (T3)
 * Theme-aware: uses CSS custom properties
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import BreadcrumbNav from './BreadcrumbNav.astro';
import ExploreByBlock from './ExploreByBlock.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Recipe {
  id: number; title: string; slug?: string; protein: string; cal: string; method: string; tag: string; img?: string;
}
interface FAQ { question: string; answer: string; }

interface Props {
  title: string; description?: string; canonicalUrl?: string;
  site?: "mealprepideas" | "proteinmeals";
  hub: string; facetA: { type: string; value: string }; facetB: { type: string; value: string };
  headline: string; headlineAccent: string; subheadline: string;
  recipes?: Recipe[]; faqs?: FAQ[];
  siblings?: { href: string; label: string; sublabel?: string }[];
}

const { title, description, canonicalUrl, hub, facetA, facetB, headline, headlineAccent, subheadline, recipes = [], faqs = [], siblings = [] } = Astro.props;
const hubPath = hub === 'meal-prep' ? '/meal-prep/' : '/high-protein/';
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: hub === 'meal-prep' ? 'Meal Prep' : 'High Protein', href: hubPath },
  { label: `${headline} ${headlineAccent}` },
];
const recipesJson = JSON.stringify(recipes);

const faqStructuredData = faqs.length > 0 ? JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqs.map(faq => ({
    '@type': 'Question',
    name: faq.question,
    acceptedAnswer: { '@type': 'Answer', text: faq.answer },
  })),
}) : null;

// i18n
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<BaseLayout title={title} description={description} canonicalUrl={canonicalUrl}>
  <HeaderNav />

  {faqStructuredData && <script type="application/ld+json" set:html={faqStructuredData} />}

  <main class="flex-grow" x-data={`{ filter: 'all', faqOpen: null, recipes: ${recipesJson} }`}>
    <!-- HERO -->
    <section class="relative pt-20 pb-16 px-6 border-b" style="border-color: var(--border-default);">
      <div class="max-w-7xl mx-auto">
        <BreadcrumbNav items={breadcrumbs} />
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-8 mt-8">
          <div class="max-w-2xl">
            <div class="flex items-center gap-3 mb-4">
              <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-widest" style="background-color: var(--accent-primary); color: var(--text-inverse);">T3: Two-Facet Intersection</span>
            </div>
            <h1 class="text-5xl md:text-7xl font-black tracking-tighter leading-none mb-6">
              {headline} <span style="color: var(--accent-primary);">{headlineAccent}</span>
            </h1>
            <p class="text-xl leading-relaxed" style="color: var(--text-secondary);">{subheadline}</p>
          </div>
          <div class="border p-6 rounded-3xl w-full md:w-64" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
            <div class="text-[10px] font-black uppercase tracking-widest mb-4" style="color: var(--text-secondary);">{t('combo.macroIntent')}</div>
            <div class="flex justify-between items-end mb-2">
              <span class="text-sm font-bold">{t('combo.proteinMin')}</span>
              <span class="text-2xl font-black" style="color: var(--accent-primary);">30g</span>
            </div>
            <div class="w-full h-1 rounded-full overflow-hidden" style="background-color: var(--bg-tertiary);">
              <div class="h-full w-[85%]" style="background-color: var(--accent-primary);"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SOLUTION FRAMEWORK -->
    <section class="max-w-7xl mx-auto py-16 px-6 grid md:grid-cols-3 gap-12">
      <div class="md:col-span-2">
        <h3 class="text-2xl font-black mb-6 flex items-center gap-3">
          <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-black" style="background-color: var(--accent-primary); color: var(--text-inverse);">?</span>
          The Solution Framework
        </h3>
        <div class="space-y-6 text-lg" style="color: var(--text-secondary);">
          <p>{subheadline}</p>
        </div>
      </div>
      <div class="border rounded-3xl p-8" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
        <h4 class="text-xs font-black uppercase tracking-widest mb-6" style="color: var(--text-secondary);">{t('combo.quickFilters')}</h4>
        <div class="flex flex-col gap-2">
          {['all', 'no-cook', 'one-pan', 'air-fryer', 'crockpot'].map(f => (
            <button
              x-on:click={`filter = '${f}'`}
              x-bind:class={`filter === '${f}' ? 'pill-active' : 'hover-bg-tertiary'`}
              class="w-full text-left px-4 py-3 rounded-xl text-sm font-bold transition-all"
              x-bind:style={`filter === '${f}' ? '' : 'color: var(--text-secondary)'`}
            >{f === 'all' ? 'All Protocols' : f.replace('-', ' ').replace(/\b\w/g, c => c.toUpperCase())}</button>
          ))}
        </div>
      </div>
    </section>

    <!-- RECIPE GRID -->
    <section class="py-24 px-6 overflow-hidden relative" style="background-color: var(--bg-primary);">
      <div class="max-w-7xl mx-auto relative z-10">
        <div class="flex flex-col md:flex-row justify-between items-end mb-16 gap-8">
          <div>
            <span class="text-[10px] font-black uppercase tracking-widest mb-4 block" style="color: var(--accent-primary);">{t('combo.rankingMachine')}</span>
            <h2 class="text-4xl md:text-5xl font-black tracking-tight">Top {headline} <br/>{headlineAccent} Protocols</h2>
          </div>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <template x-for="(recipe, index) in recipes.filter(r => filter === 'all' || r.method === filter)" x-bind:key="recipe.id">
            <a x-bind:href={`recipe.slug ? '${hubPath}recipes/' + recipe.slug + '/' : '${hubPath}'`} class="hyper-border rounded-3xl overflow-hidden group transition-all cursor-pointer block">
              <div class="aspect-video relative overflow-hidden" style="background-color: var(--bg-tertiary);" x-show="recipe.img">
                <img x-bind:src="recipe.img" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" x-bind:alt="recipe.title" loading="lazy" onerror="this.parentElement.style.display='none'" />
                <div class="absolute inset-0" style="background: linear-gradient(to top, var(--bg-primary) 0%, transparent 60%);"></div>
              </div>
              <div class="p-6">
              <div class="flex justify-between items-start mb-6">
                <span class="text-4xl font-black group-hover-accent-opacity transition-colors" style="color: var(--text-tertiary);" x-text="index + 1"></span>
                <span class="text-[9px] font-black px-2 py-1 rounded uppercase" style="background-color: var(--bg-tertiary);" x-text="recipe.tag"></span>
              </div>
              <h4 class="text-2xl font-bold mb-4 group-hover-accent-text transition-colors" x-text="recipe.title"></h4>
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="rounded-xl p-3 border" style="background-color: var(--bg-primary); border-color: var(--border-default);">
                  <div class="text-[10px] font-black uppercase" style="color: var(--text-secondary);">Protein</div>
                  <div class="text-lg font-black" style="color: var(--accent-primary);" x-text="recipe.protein"></div>
                </div>
                <div class="rounded-xl p-3 border" style="background-color: var(--bg-primary); border-color: var(--border-default);">
                  <div class="text-[10px] font-black uppercase" style="color: var(--text-secondary);">Calories</div>
                  <div class="text-lg font-black" x-text="recipe.cal"></div>
                </div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-xs font-bold uppercase tracking-widest" style="color: var(--text-tertiary);" x-text="'Method: ' + recipe.method"></span>
                <div class="w-8 h-8 rounded-full border flex items-center justify-center group-hover-accent-bg group-hover-accent-border transition-all" style="border-color: var(--border-default);">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </div>
              </div>
              </div>
            </a>
          </template>
        </div>
      </div>
    </section>

    <!-- SIBLINGS / RELATED -->
    {siblings.length > 0 && (
      <section class="py-24 px-6 border-t" style="border-color: var(--border-default);">
        <div class="max-w-7xl mx-auto">
          <div class="mb-12">
            <span class="text-[10px] font-black uppercase tracking-widest mb-4 block" style="color: var(--text-secondary);">{t('combo.relatedSystems')}</span>
            <h3 class="text-3xl font-black tracking-tight">{t('combo.exploreSiblings')}</h3>
          </div>
          <div class="grid md:grid-cols-4 gap-4">
            {siblings.map(sib => (
              <a href={sib.href} class="p-6 border rounded-2xl hover-accent-border transition-all group" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
                <div class="text-[10px] font-black group-hover-accent-text mb-2" style="color: var(--text-tertiary);">{sib.sublabel || 'NEXT FACET'}</div>
                <div class="font-bold text-sm">{sib.label}</div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- FAQ -->
    {faqs.length > 0 && (
      <section class="py-24 px-6 max-w-4xl mx-auto">
        <h4 class="text-4xl font-black tracking-tighter mb-12 text-center">{t('common.technicalFaq')}</h4>
        <div class="space-y-4">
          {faqs.map((faq, index) => (
            <div class="border rounded-2xl overflow-hidden" style="border-color: var(--border-default);">
              <button x-on:click={`faqOpen === ${index} ? faqOpen = null : faqOpen = ${index}`} class="w-full flex justify-between items-center p-6 text-left hover-bg-secondary transition-colors">
                <span class="text-sm font-black uppercase tracking-wider">{faq.question}</span>
                <span class="text-2xl font-black" style="color: var(--accent-primary);" x-text={`faqOpen === ${index} ? '−' : '+'`}></span>
              </button>
              <div x-show={`faqOpen === ${index}`} x-cloak class="p-6 border-t text-sm leading-relaxed" style="background-color: color-mix(in srgb, var(--bg-secondary) 50%, transparent); border-color: var(--border-default); color: var(--text-secondary);">{faq.answer}</div>
            </div>
          ))}
        </div>
      </section>
    )}
  </main>

  <FooterNav copyrightSuffix="Index Authority Network. T3 Combo Page." />
</BaseLayout>
