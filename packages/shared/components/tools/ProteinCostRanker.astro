---
import AuthGate from '../AuthGate.astro';

import BaseLayout from '../../layouts/BaseLayout.astro';
import HeaderNav from '../HeaderNav.astro';
import FooterNav from '../FooterNav.astro';

interface Props {
  site?: 'mealprepideas' | 'proteinmeals';
}

const { site = 'mealprepideas' } = Astro.props;

const proteinData = [
  { name: 'Chicken Breast', price: 3.99, unit: 'lb', proteinPer100g: 31, calsPer100g: 165, category: 'meat', diet: ['all'] },
  { name: 'Ground Beef (93%)', price: 5.49, unit: 'lb', proteinPer100g: 26, calsPer100g: 170, category: 'meat', diet: ['all'] },
  { name: 'Ground Turkey', price: 4.99, unit: 'lb', proteinPer100g: 27, calsPer100g: 170, category: 'meat', diet: ['all'] },
  { name: 'Eggs (dozen)', price: 3.99, unit: '12ct', proteinPer100g: 13, calsPer100g: 155, category: 'dairy', diet: ['all', 'vegetarian'] },
  { name: 'Greek Yogurt', price: 5.99, unit: '32oz', proteinPer100g: 10, calsPer100g: 59, category: 'dairy', diet: ['all', 'vegetarian'] },
  { name: 'Cottage Cheese', price: 3.49, unit: '16oz', proteinPer100g: 11, calsPer100g: 98, category: 'dairy', diet: ['all', 'vegetarian'] },
  { name: 'Tofu (firm)', price: 2.49, unit: '14oz', proteinPer100g: 8, calsPer100g: 76, category: 'plant', diet: ['all', 'vegetarian', 'vegan'] },
  { name: 'Lentils (dry)', price: 1.99, unit: 'lb', proteinPer100g: 26, calsPer100g: 352, category: 'plant', diet: ['all', 'vegetarian', 'vegan'] },
  { name: 'Canned Tuna', price: 1.29, unit: '5oz', proteinPer100g: 26, calsPer100g: 116, category: 'fish', diet: ['all'] },
  { name: 'Whey Protein', price: 29.99, unit: '2lb', proteinPer100g: 80, calsPer100g: 370, category: 'supplement', diet: ['all', 'vegetarian'] },
  { name: 'Salmon', price: 9.99, unit: 'lb', proteinPer100g: 20, calsPer100g: 208, category: 'fish', diet: ['all'] },
  { name: 'Shrimp', price: 8.99, unit: 'lb', proteinPer100g: 24, calsPer100g: 99, category: 'fish', diet: ['all'] },
  { name: 'Canned Chickpeas', price: 1.09, unit: '15oz', proteinPer100g: 9, calsPer100g: 164, category: 'plant', diet: ['all', 'vegetarian', 'vegan'] },
  { name: 'Tempeh', price: 3.29, unit: '8oz', proteinPer100g: 19, calsPer100g: 192, category: 'plant', diet: ['all', 'vegetarian', 'vegan'] },
  { name: 'Peanut Butter', price: 3.49, unit: '16oz', proteinPer100g: 25, calsPer100g: 588, category: 'plant', diet: ['all', 'vegetarian', 'vegan'] },
  { name: 'Edamame (frozen)', price: 2.99, unit: '12oz', proteinPer100g: 11, calsPer100g: 121, category: 'plant', diet: ['all', 'vegetarian', 'vegan'] },
];

const dataJson = JSON.stringify(proteinData);
---

<BaseLayout title="Protein Cost Efficiency Ranker | Compare Protein Sources" description="Compare protein sources by cost-per-gram. Find the most affordable high-protein foods for your budget and diet.">
  <HeaderNav site={site} />
  
  <main class="flex-grow py-16 px-6">
  <AuthGate toolName="Protein Cost Ranker" toolDescription="Compare protein sources by cost per gram. Find the best value for your budget." toolIcon="ðŸ’°">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <div class="mb-12">
        <div class="flex items-center gap-4 mb-4">
          <div class="h-[2px] w-12" style="background-color: var(--accent-primary);"></div>
          <span class="text-[10px] font-black tracking-[0.5em] uppercase" style="color: var(--accent-primary);">Protein Intelligence</span>
        </div>
        <h1 class="text-5xl md:text-7xl font-black tracking-tighter mb-4" style="color: var(--text-primary);">PROTEIN COST<br/>EFFICIENCY RANKER</h1>
        <p class="text-lg max-w-2xl" style="color: var(--text-secondary);">Compare protein sources by cost-per-gram. Sort, filter by diet, and find the most affordable way to hit your protein goals.</p>
      </div>

      <!-- Interactive Table -->
      <div x-data={`{
        items: ${dataJson},
        sortKey: 'costPerGram',
        sortAsc: true,
        dietFilter: 'all',
        get filteredItems() {
          let filtered = this.items;
          if (this.dietFilter !== 'all') {
            filtered = filtered.filter(i => i.diet.includes(this.dietFilter));
          }
          // Calculate cost per gram for each
          return filtered.map(i => {
            let grams;
            if (i.unit === 'lb') grams = 453.6;
            else if (i.unit === '32oz') grams = 907.2;
            else if (i.unit === '16oz') grams = 453.6;
            else if (i.unit === '14oz') grams = 396.9;
            else if (i.unit === '15oz') grams = 425.2;
            else if (i.unit === '12oz') grams = 340.2;
            else if (i.unit === '8oz') grams = 226.8;
            else if (i.unit === '5oz') grams = 141.7;
            else if (i.unit === '2lb') grams = 907.2;
            else if (i.unit === '12ct') grams = 600; // ~50g per egg x 12
            else grams = 453.6;
            const totalProtein = (grams * i.proteinPer100g) / 100;
            const costPerGram = i.price / totalProtein;
            return { ...i, totalProtein: Math.round(totalProtein), costPerGram: costPerGram };
          }).sort((a, b) => {
            const key = this.sortKey;
            const mul = this.sortAsc ? 1 : -1;
            return (a[key] - b[key]) * mul;
          });
        },
        get bestValue() {
          return this.filteredItems.length > 0 ? this.filteredItems[0].name : '';
        },
        toggleSort(key) {
          if (this.sortKey === key) this.sortAsc = !this.sortAsc;
          else { this.sortKey = key; this.sortAsc = true; }
        }
      }`}>
        <!-- Diet Filter -->
        <div class="flex flex-wrap gap-3 mb-8">
          <span class="text-[10px] font-black uppercase tracking-widest self-center mr-2" style="color: var(--text-tertiary);">Filter:</span>
          {['all', 'vegetarian', 'vegan'].map(d => (
            <button x-on:click={`dietFilter = '${d}'`}
                    x-bind:style={`dietFilter === '${d}' ? 'background: var(--accent-primary); color: var(--text-inverse); border-color: var(--accent-primary);' : 'color: var(--text-secondary); border-color: var(--border-default);'`}
                    class="px-4 py-2 border rounded-full text-[11px] font-bold uppercase transition-all cursor-pointer">
              {d === 'all' ? 'All Sources' : d.charAt(0).toUpperCase() + d.slice(1)}
            </button>
          ))}
        </div>

        <!-- Best Value Banner -->
        <div class="mb-8 p-4 rounded-xl flex items-center gap-4" style="background: var(--bg-secondary); border: 1px solid var(--accent-primary);">
          <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background: var(--accent-primary);">
            <svg class="w-5 h-5" style="color: var(--text-inverse);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
          </div>
          <div>
            <span class="text-[10px] font-black uppercase tracking-widest" style="color: var(--accent-primary);">Best Value</span>
            <p class="font-black text-lg" style="color: var(--text-primary);" x-text="bestValue + ' â€” lowest cost per gram of protein'"></p>
          </div>
        </div>

        <!-- Table -->
        <div class="rounded-2xl overflow-hidden" style="border: 1px solid var(--border-default);">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr style="background: var(--bg-tertiary);">
                  <th class="text-left px-6 py-4 text-[10px] font-black uppercase tracking-widest cursor-pointer select-none" style="color: var(--text-tertiary);" x-on:click="toggleSort('name')">
                    Source <span x-show="sortKey==='name'" x-text="sortAsc ? 'â†‘' : 'â†“'"></span>
                  </th>
                  <th class="text-right px-6 py-4 text-[10px] font-black uppercase tracking-widest cursor-pointer select-none" style="color: var(--text-tertiary);" x-on:click="toggleSort('price')">
                    Price <span x-show="sortKey==='price'" x-text="sortAsc ? 'â†‘' : 'â†“'"></span>
                  </th>
                  <th class="text-right px-6 py-4 text-[10px] font-black uppercase tracking-widest cursor-pointer select-none" style="color: var(--text-tertiary);" x-on:click="toggleSort('proteinPer100g')">
                    Protein/100g <span x-show="sortKey==='proteinPer100g'" x-text="sortAsc ? 'â†‘' : 'â†“'"></span>
                  </th>
                  <th class="text-right px-6 py-4 text-[10px] font-black uppercase tracking-widest cursor-pointer select-none" style="color: var(--text-tertiary);" x-on:click="toggleSort('calsPer100g')">
                    Cal/100g <span x-show="sortKey==='calsPer100g'" x-text="sortAsc ? 'â†‘' : 'â†“'"></span>
                  </th>
                  <th class="text-right px-6 py-4 text-[10px] font-black uppercase tracking-widest cursor-pointer select-none" style="color: var(--accent-primary);" x-on:click="toggleSort('costPerGram')">
                    $/g Protein <span x-show="sortKey==='costPerGram'" x-text="sortAsc ? 'â†‘' : 'â†“'"></span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(item, idx) in filteredItems" :key="item.name">
                  <tr class="transition-colors" x-bind:style="idx === 0 ? 'background: var(--bg-secondary); border-left: 3px solid var(--accent-primary);' : 'border-bottom: 1px solid var(--border-default);'">
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-3">
                        <span x-show="idx === 0" class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black flex-shrink-0" style="background: var(--accent-primary); color: var(--text-inverse);">1</span>
                        <span x-show="idx > 0" class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black flex-shrink-0" style="background: var(--bg-tertiary); color: var(--text-tertiary);" x-text="idx + 1"></span>
                        <div>
                          <span class="font-bold text-sm" style="color: var(--text-primary);" x-text="item.name"></span>
                          <span class="block text-[10px] font-bold uppercase" style="color: var(--text-tertiary);" x-text="item.category"></span>
                        </div>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <span class="font-bold text-sm" style="color: var(--text-primary);" x-text="'$' + item.price.toFixed(2)"></span>
                      <span class="block text-[10px]" style="color: var(--text-tertiary);" x-text="'per ' + item.unit"></span>
                    </td>
                    <td class="px-6 py-4 text-right font-bold text-sm" style="color: var(--text-primary);" x-text="item.proteinPer100g + 'g'"></td>
                    <td class="px-6 py-4 text-right font-bold text-sm" style="color: var(--text-secondary);" x-text="item.calsPer100g"></td>
                    <td class="px-6 py-4 text-right">
                      <span class="font-black text-lg" x-bind:style="idx === 0 ? 'color: var(--accent-primary);' : 'color: var(--text-primary);'" x-text="'$' + item.costPerGram.toFixed(3)"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Summary -->
        <div class="mt-8 p-6 rounded-2xl" style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
          <h3 class="text-lg font-black mb-4" style="color: var(--text-primary);">HOW TO READ THIS TABLE</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm" style="color: var(--text-secondary);">
            <div>
              <strong style="color: var(--accent-primary);">$/g Protein</strong> â€” The lower, the better. This is how much you pay for each gram of protein from that source.
            </div>
            <div>
              <strong style="color: var(--accent-primary);">Protein/100g</strong> â€” How protein-dense the food is. Higher means less volume to hit your target.
            </div>
            <div>
              <strong style="color: var(--accent-primary);">Cal/100g</strong> â€” Caloric density. Lower is better for weight loss; higher is fine for muscle gain.
            </div>
          </div>
        </div>
      </div>
    </div>
  
    </AuthGate>
</main>

  <FooterNav site={site} />
  
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Protein Cost Efficiency Ranker",
    "description": "Compare protein sources by cost-per-gram to find the most affordable high-protein foods.",
    "applicationCategory": "HealthApplication",
    "operatingSystem": "Web",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" }
  })} />
</BaseLayout>
