---
/**
 * HighProteinRecipe — High Protein Recipe Page (T4) — Redesigned
 * Split hero, inventory grid, execution steps, bottom 3-column
 * Theme-aware: uses CSS custom properties
 * Includes Schema.org Recipe structured data
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import BreadcrumbNav from './BreadcrumbNav.astro';
import type { Recipe } from '../data/content/recipes';
import { plans } from '../data/content/plans';

interface Props {
  recipe: Recipe;
  relatedRecipes?: Recipe[];
  site?: "mealprepideas" | "proteinmeals";
}

const { recipe, relatedRecipes = [], site } = Astro.props;

// Auto-detect site and cross-hub base URL
const siteHref = Astro.site?.href || Astro.site?.toString() || '';
const detectedSite = site || (siteHref.includes('proteinmeals') ? 'proteinmeals' : 'mealprepideas');
const isProteinmeals = detectedSite === 'proteinmeals';
const mpBase = isProteinmeals ? 'https://mealprepideas.co' : '';
const hpBase = isProteinmeals ? '' : 'https://proteinmeals.co';

// Build image path
const localImagePath = `/images/recipes/${recipe.slug}.jpg`;
const heroImage = localImagePath;
const fallbackImage = '/images/placeholder.svg';

// Map recipe data
const recipeName = recipe.title;
const recipeId = `HP-${recipe.slug.split('-').map(w => w[0]?.toUpperCase()).join('').slice(0, 4)}`;
const totalTimeMin = recipe.prepTime + recipe.cookTime;
const servings = recipe.servings;

// P:E Ratio (Ted Naiman) = protein_g / (fat_g + net_carb_g)
// Net carbs = carbs - fiber; energy = fat + net carbs
const netCarbs = Math.max(0, (recipe.carbs || 0) - (recipe.fiber || 0));
const energyDenom = (recipe.fat || 0) + netCarbs;
const peRatio = energyDenom > 0 ? (recipe.protein / energyDenom).toFixed(1) : '∞';

// Ingredient role assignment
function getIngredientRole(text: string, protein: number): string {
  const lower = text.toLowerCase();
  if (/chicken|beef|turkey|salmon|shrimp|tofu|egg/.test(lower)) return `${protein}G PROTEIN`;
  if (/garlic|onion|spice|sauce|oil|lemon|lime|oregano|dill|parsley|herb|pepper|salt|vinegar|cumin|paprika|chili|ginger|soy|sesame|mustard|mayo/.test(lower)) return 'FLAVOR';
  if (/broccoli|spinach|beans|lentil|kale|cabbage|cauliflower|zucchini|asparagus/.test(lower)) return 'HIGH FIBER';
  if (/rice|quinoa|pasta|bread|oat|potato|tortilla|wrap|noodle|couscous/.test(lower)) return 'CARB BASE';
  if (/cheese|cream|butter|milk|yogurt|feta/.test(lower)) return 'DAIRY';
  if (/tomato|cucumber|pepper|carrot|celery|avocado|olive|corn/.test(lower)) return 'PRODUCE';
  return 'FLAVOR';
}

const ingredients = recipe.ingredients.map((text, i) => ({
  id: `ing-${i}`,
  text,
  role: getIngredientRole(text, recipe.protein),
}));

// Step title generation
const stepTitles = ['THE MACRO PREP', 'HIGH HEAT SEAR', 'VEGGIE STEAM-SAUTÉ', 'THE ASSEMBLY'];
const altTitles = ['PREP & SEASON', 'COOK PROTEIN', 'ADD VEGETABLES', 'PLATE & STORE'];

function generateStepTitle(detail: string, index: number): string {
  const lower = detail.toLowerCase();
  if (index < stepTitles.length) {
    if (lower.includes('preheat') || lower.includes('prep') || lower.includes('dice') || lower.includes('chop') || lower.includes('mix') || lower.includes('toss') || lower.includes('marinate') || lower.includes('season')) return stepTitles[0] || altTitles[0];
    if (lower.includes('cook') || lower.includes('sear') || lower.includes('bake') || lower.includes('grill') || lower.includes('roast') || lower.includes('heat') || lower.includes('fry') || lower.includes('sauté')) return stepTitles[1] || altTitles[1];
    if (lower.includes('vegetable') || lower.includes('broccoli') || lower.includes('steam') || lower.includes('spinach') || lower.includes('add')) return stepTitles[2] || altTitles[2];
    if (lower.includes('assemble') || lower.includes('divide') || lower.includes('portion') || lower.includes('plate') || lower.includes('container') || lower.includes('serve') || lower.includes('garnish') || lower.includes('top')) return stepTitles[3] || altTitles[3];
    return stepTitles[index] || `STEP ${index + 1}`;
  }
  return `STEP ${index + 1}`;
}

const steps = recipe.instructions.map((detail, i) => ({
  number: String(i + 1).padStart(2, '0'),
  title: generateStepTitle(detail, i),
  detail,
}));

// Community preps seeded from slug
function hashCode(s: string): number {
  let hash = 0;
  for (let i = 0; i < s.length; i++) {
    const char = s.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash |= 0;
  }
  return Math.abs(hash);
}
const communityPreps = 800 + (hashCode(recipe.slug) % 2201);
const communityPrepsFormatted = communityPreps.toLocaleString('en-US');

// Storage & logistics
const storageText = recipe.storageInstructions || 'Store in airtight containers for up to 5 days.';
const batchingText = recipe.tips?.[0] || `Double the recipe for ${servings * 2} portions.`;
const reheatText = recipe.reheatingInstructions || 'Microwave for 90s at 70% power.';

// Primary category
const primaryMethod = recipe.facets.method;
const primaryDiet = recipe.facets.diet;
const primaryGoal = recipe.facets.goal;
const primaryCategory = primaryMethod
  ? { label: primaryMethod.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()), slug: primaryMethod, type: 'method' }
  : primaryGoal
  ? { label: primaryGoal.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()), slug: primaryGoal, type: 'goal' }
  : primaryDiet
  ? { label: primaryDiet.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()), slug: primaryDiet, type: 'diet' }
  : null;

// Related ingredients from facets + ingredient text parsing
const mainIngredientSlugs: { label: string; slug: string }[] = [];
if (recipe.facets.ingredient) {
  mainIngredientSlugs.push({
    label: recipe.facets.ingredient.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
    slug: recipe.facets.ingredient,
  });
}
const ingredientKeywords = ['chicken', 'beef', 'turkey', 'salmon', 'shrimp', 'tofu', 'rice', 'quinoa', 'broccoli', 'spinach', 'eggs', 'sweet-potato', 'lentils', 'pasta', 'beans'];
for (const kw of ingredientKeywords) {
  const kwClean = kw.replace(/-/g, ' ');
  if (recipe.ingredients.some(ing => ing.toLowerCase().includes(kwClean)) && !mainIngredientSlugs.find(s => s.slug === kw)) {
    mainIngredientSlugs.push({
      label: kwClean.replace(/\b\w/g, c => c.toUpperCase()),
      slug: kw,
    });
  }
}
const relatedIngredients = mainIngredientSlugs.slice(0, 5);

// Find matching plans
const matchingPlans = plans.filter(p => p.hub === 'high-protein' && p.days.some(d => d.meals.some(m => m.recipeSlug === recipe.slug))).slice(0, 1);
const fallbackPlan = matchingPlans.length === 0
  ? plans.filter(p => p.hub === 'high-protein').slice(0, 1)
  : [];
const displayPlans = matchingPlans.length > 0 ? matchingPlans : fallbackPlan;

// Tags
const tags = Object.values(recipe.facets).filter(Boolean).slice(0, 4) as string[];

// ISO8601 Duration
function toISO8601Duration(minutes: number): string {
  if (minutes >= 60) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `PT${h}H${m > 0 ? m + 'M' : ''}`;
  }
  return `PT${minutes}M`;
}

const pageTitle = `${recipeName} | ProteinMeals.co`;
const pageDescription = recipe.description;

const structuredData = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Recipe',
  name: recipeName,
  description: recipe.description,
  image: heroImage,
  prepTime: toISO8601Duration(recipe.prepTime),
  cookTime: toISO8601Duration(recipe.cookTime),
  totalTime: toISO8601Duration(totalTimeMin),
  recipeYield: `${servings} servings`,
  recipeCategory: 'High Protein',
  nutrition: {
    '@type': 'NutritionInformation',
    proteinContent: `${recipe.protein}g`,
    calories: `${recipe.calories} cal`,
  },
  recipeIngredient: recipe.ingredients,
  recipeInstructions: steps.map(s => ({
    '@type': 'HowToStep',
    name: s.title,
    text: s.detail,
  })),
});
---

<BaseLayout title={pageTitle} description={pageDescription} canonicalUrl={`/high-protein/recipes/${recipe.slug}/`} structuredData={structuredData}>
  <HeaderNav
    site="proteinmeals"
    statusText={`Recipe: ${recipeId}`}
  />

  <main class="recipe-page flex-grow" x-data={`{
    servings: ${servings},
    baseServings: ${servings},
    baseMacros: { calories: ${recipe.calories}, protein: ${recipe.protein}, carbs: ${recipe.carbs}, fat: ${recipe.fat}, fiber: ${recipe.fiber || 0} },
    get multiplier() { return this.servings / this.baseServings; },
    get scaledCalories() { return Math.round(this.baseMacros.calories * this.multiplier); },
    get scaledProtein() { return Math.round(this.baseMacros.protein * this.multiplier); },
    get scaledCarbs() { return Math.round(this.baseMacros.carbs * this.multiplier); },
    get scaledFat() { return Math.round(this.baseMacros.fat * this.multiplier); },
    get scaledFiber() { return Math.round(this.baseMacros.fiber * this.multiplier); },
    showGrocery: false,
    yieldGateMsg: '',
    increment() {
      if (this.servings >= 5 && !(window.authHelper && window.authHelper.isSignedIn())) {
        this.yieldGateMsg = 'Sign up free to unlock 6+ servings!';
        if (window.authHelper) window.authHelper.openSignIn();
        return;
      }
      this.yieldGateMsg = '';
      this.servings = Math.min(12, this.servings + 1);
    },
    decrement() { this.yieldGateMsg = ''; this.servings = Math.max(1, this.servings - 1); },
    scaleIngredient(text) {
      const ratio = this.multiplier;
      return text.replace(/^(\\d+)\\/(\\d+)/, (m, a, b) => {
        const scaled = (parseInt(a) / parseInt(b)) * ratio;
        return scaled % 1 === 0 ? String(scaled) : scaled.toFixed(2);
      }).replace(/^([\\d]+\\.?[\\d]*)/, (m, n) => {
        const scaled = parseFloat(n) * ratio;
        return scaled % 1 === 0 ? String(scaled) : scaled.toFixed(1);
      });
    }
  }`}>
    <BreadcrumbNav items={[
      { label: 'Home', href: '/' },
      { label: 'High Protein', href: '/high-protein/' },
      { label: recipeName },
    ]} />

    <!-- ═══ HERO SECTION (Split Layout) ═══ -->
    <section class="rp-hero px-6 max-w-7xl mx-auto mb-16">
      <div class="grid md:grid-cols-2 gap-12 items-start">
        <!-- LEFT: Title, Description, Stats -->
        <div class="rp-hero__left">
          <h1 class="rp-hero__title">{recipeName}</h1>
          <p class="rp-hero__desc">{recipe.description}</p>

          <!-- Macro Stat Boxes -->
          <div class="rp-stats">
            <div class="rp-stat">
              <span class="rp-stat__label">PROTEIN</span>
              <span class="rp-stat__value" x-text="scaledProtein + 'g'">{recipe.protein}g</span>
            </div>
            <div class="rp-stat">
              <span class="rp-stat__label">CALORIES</span>
              <span class="rp-stat__value" x-text="scaledCalories">{recipe.calories}</span>
            </div>
            <div class="rp-stat">
              <span class="rp-stat__label">P:E RATIO</span>
              <span class="rp-stat__value rp-stat__value--accent">{peRatio}</span>
            </div>
            <div class="rp-stat">
              <span class="rp-stat__label">TIME</span>
              <span class="rp-stat__value">{totalTimeMin}m</span>
            </div>
          </div>

          <!-- Yield + Save -->
          <div class="rp-yield-row">
            <div class="rp-yield">
              <span class="rp-yield__label">YIELD</span>
              <button x-on:click="decrement()" class="rp-yield__btn" x-bind:disabled="servings <= 1" x-bind:style="servings <= 1 ? 'opacity:0.3;cursor:not-allowed' : ''">−</button>
              <span class="rp-yield__count" x-text="servings">{servings}</span>
              <button x-on:click="increment()" class="rp-yield__btn" x-bind:disabled="servings >= 12" x-bind:style="servings >= 12 ? 'opacity:0.3;cursor:not-allowed' : ''">+</button>
            </div>
            <button class="rp-save-btn" id="save-recipe-btn" data-slug={recipe.slug} data-title={recipeName} data-protein={recipe.protein} data-calories={recipe.calories} data-image={heroImage}>
              <span id="save-btn-text">SAVE PROTOCOL</span>
            </button>
            <button class="rp-grocery-btn" x-on:click="showGrocery = !showGrocery" title="View grocery list">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z"></path></svg>
              <span>GROCERY LIST</span>
            </button>
            <button class="rp-print-btn" onclick="window.print()" title="Print prep sheet">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
              <span>PRINT PREP SHEET</span>
            </button>
          </div>
          <!-- Yield gate message -->
          <div x-show="yieldGateMsg" x-cloak class="mt-3 px-4 py-2 rounded-lg text-sm font-bold" style="background: var(--accent-primary); color: var(--text-inverse);">
            <span x-text="yieldGateMsg"></span>
          </div>
        </div>

        <!-- RIGHT: Hero Image with P:E Badge -->
        <div class="rp-hero__right">
          <div class="rp-hero-image">
            <img
              src={heroImage}
              onerror={`this.onerror=null;this.src='${fallbackImage}'`}
              class="rp-hero-image__img"
              alt={recipe.imageAlt || recipeName}
              width="700"
              height="470"
              loading="eager"
            />
            <div class="rp-hero-image__line"></div>
            <div class="rp-pe-badge">
              <span class="rp-pe-badge__label">P:E</span>
              <span class="rp-pe-badge__value">{peRatio}</span>
            </div>
            <span class="rp-pe-badge__sublabel">ELITE DENSITY</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ═══ TWO-COLUMN BODY (Inventory + Steps) ═══ -->
    <section class="rp-body px-6 max-w-7xl mx-auto mb-16">
      <div class="grid md:grid-cols-2 gap-16">
        <!-- LEFT COLUMN: Inventory List -->
        <div class="rp-inventory">
          <div class="rp-inventory__header">
            <h2 class="rp-section-title">INVENTORY LIST</h2>
            <div class="rp-toggle-pills">
              <span class="rp-pill rp-pill--active" id="pill-original">ORIGINAL</span>
              <span class="rp-pill" id="pill-vegan" onclick="window.authHelper ? window.authHelper.requireAuth(function() { document.getElementById('pill-vegan').classList.add('rp-pill--active'); document.getElementById('pill-original').classList.remove('rp-pill--active'); }) : void(0)">
                <svg class="inline w-3 h-3 mr-1 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-auth-show="signed-out"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                VEGAN SWAP
              </span>
            </div>
          </div>

          <!-- Ingredient Grid (2 columns) -->
          <div class="rp-ingredients-grid">
            {ingredients.map(ing => (
              <div class="rp-ingredient">
                <span class="rp-ingredient__text" x-text={`scaleIngredient('${ing.text.replace(/'/g, "\\'")}')`}>{ing.text}</span>
                <span class="rp-ingredient__role">{ing.role}</span>
              </div>
            ))}
          </div>

          <!-- Meal Prep Logistics Box -->
          <div class="rp-logistics">
            <div class="rp-logistics__header">
              <h3 class="rp-logistics__title">MEAL PREP LOGISTICS</h3>
              <div class="rp-logistics__icon">
                <span></span><span></span><span></span>
              </div>
            </div>
            <ul class="rp-logistics__list">
              <li>
                <span class="rp-logistics__dot"></span>
                <span><strong>Storage:</strong> {storageText}</span>
              </li>
              <li>
                <span class="rp-logistics__dot"></span>
                <span><strong>Batching:</strong> {batchingText}</span>
              </li>
              <li>
                <span class="rp-logistics__dot"></span>
                <span><strong>Reheat:</strong> {reheatText}</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- RIGHT COLUMN: Execution Steps -->
        <div class="rp-steps">
          <h2 class="rp-section-title">EXECUTION STEPS</h2>

          <div class="rp-steps__list">
            {steps.map(step => (
              <div class="rp-step">
                <span class="rp-step__number">{step.number}</span>
                <div class="rp-step__content">
                  <h4 class="rp-step__title">{step.title}</h4>
                  <p class="rp-step__detail">{step.detail}</p>
                </div>
              </div>
            ))}
          </div>

          <!-- Community Counter -->
          <div class="rp-community">
            <div class="rp-community__dots">
              <span class="rp-community__dot rp-community__dot--light"></span>
              <span class="rp-community__dot rp-community__dot--light"></span>
              <span class="rp-community__dot rp-community__dot--dark"></span>
            </div>
            <span class="rp-community__text">{communityPrepsFormatted} COMMUNITY PREPS THIS WEEK</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ═══ BOTTOM SECTION (3 columns) ═══ -->
    <section class="rp-bottom px-6 max-w-7xl mx-auto mb-16">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Primary Category -->
        <div class="rp-bottom-col">
          <h3 class="rp-bottom__label">PRIMARY CATEGORY</h3>
          {primaryCategory && (
            <a href={`/high-protein/${primaryCategory.type}/${primaryCategory.slug}/`} class="rp-category-card">
              <span class="rp-category-card__eyebrow">EXPLORE MORE</span>
              <span class="rp-category-card__title">{primaryCategory.label} Protein</span>
            </a>
          )}
        </div>

        <!-- Related Ingredients -->
        <div class="rp-bottom-col">
          <h3 class="rp-bottom__label">RELATED INGREDIENTS</h3>
          <div class="rp-ingredient-pills">
            {relatedIngredients.map(ing => (
              <a href={`/high-protein/ingredient/${ing.slug}/`} class="rp-ing-pill">{ing.label}</a>
            ))}
          </div>
        </div>

        <!-- Full Execution Plans -->
        <div class="rp-bottom-col">
          <h3 class="rp-bottom__label">FULL EXECUTION PLANS</h3>
          {displayPlans.map(plan => (
            <a href={`/high-protein/plans/${plan.slug}/`} class="rp-plan-link">
              <span class="rp-plan-link__title">{plan.title.toUpperCase()}</span>
              <span class="rp-plan-link__arrow">›</span>
            </a>
          ))}
        </div>
      </div>
    </section>

    <!-- ═══ GROCERY LIST SLIDE-OUT PANEL ═══ -->
    <div x-show="showGrocery" x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="translate-x-full"
         class="fixed top-0 right-0 h-full w-full max-w-md z-50 shadow-2xl overflow-y-auto"
         style="background: var(--bg-primary); border-left: 1px solid var(--border-subtle);">
      <!-- Header -->
      <div class="flex items-center justify-between px-6 py-5 border-b" style="border-color: var(--border-subtle);">
        <div>
          <h3 class="text-lg font-black uppercase tracking-wider" style="color: var(--text-primary);">Grocery List</h3>
          <p class="text-xs mt-1" style="color: var(--text-tertiary);"><span x-text="servings"></span> servings</p>
        </div>
        <button x-on:click="showGrocery = false" class="p-2 rounded-lg hover:opacity-70" style="color: var(--text-secondary);">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <!-- Ingredient List -->
      <div class="px-6 py-4">
        <ul class="space-y-3">
          {recipe.ingredients.map((ing: string, i: number) => (
            <li class="flex items-start gap-3 group" x-data={`{ checked: false }`}>
              <button x-on:click="checked = !checked"
                      class="mt-1 w-5 h-5 rounded border-2 flex-shrink-0 flex items-center justify-center transition-all"
                      x-bind:style="checked ? 'background: var(--accent-primary); border-color: var(--accent-primary);' : 'border-color: var(--text-tertiary);'">
                <svg x-show="checked" class="w-3 h-3" fill="none" stroke="white" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
              </button>
              <span class="text-sm leading-relaxed transition-all"
                    x-bind:style="checked ? 'color: var(--text-tertiary); text-decoration: line-through;' : 'color: var(--text-primary);'"
                    x-text={`scaleIngredient('${ing.replace(/'/g, "\\'")}')`}>
                {ing}
              </span>
            </li>
          ))}
        </ul>
      </div>
      <!-- Footer actions -->
      <div class="px-6 py-4 border-t" style="border-color: var(--border-subtle);">
        <button id="copy-grocery-list" x-on:click="
          const items = [...document.querySelectorAll('[x-show=showGrocery] ul li span')].map(s => s.textContent).join('\n');
          navigator.clipboard.writeText(items).then(() => { $el.textContent = '✓ COPIED'; setTimeout(() => { $el.textContent = 'COPY TO CLIPBOARD'; }, 2000); });
        " class="w-full py-3 rounded-full font-black text-xs uppercase tracking-widest cursor-pointer transition-all hover:opacity-90"
           style="background: var(--accent-primary); color: var(--text-inverse);">
          COPY TO CLIPBOARD
        </button>
      </div>
    </div>
    <!-- Overlay -->
    <div x-show="showGrocery" x-cloak x-on:click="showGrocery = false"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 bg-black/50 z-40"></div>

  </main>

  <FooterNav site="proteinmeals" copyrightSuffix={`Index Authority Network. Recipe ${recipeId}.`} />
</BaseLayout>

<style>
  /* ═══════════════════════════════════════════════════════
     RECIPE PAGE STYLES (High Protein variant)
     All colors use CSS custom properties from the theme
     ═══════════════════════════════════════════════════════ */

  /* ─── HERO SECTION ──────────────────────────────── */
  .rp-hero__title {
    font-size: clamp(2.5rem, 6vw, 4.5rem);
    font-weight: 900;
    letter-spacing: -0.03em;
    line-height: 0.95;
    margin-bottom: 1rem;
    text-transform: uppercase;
  }

  .rp-hero__desc {
    color: var(--text-secondary);
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 2rem;
    max-width: 380px;
  }

  /* Stat Boxes Row */
  .rp-stats {
    display: flex;
    gap: 0;
    margin-bottom: 2rem;
  }

  .rp-stat {
    flex: 1;
    padding: 0.75rem 1rem;
    border-left: 3px solid var(--accent-primary);
  }

  .rp-stat__label {
    display: block;
    font-size: 0.6rem;
    font-weight: 800;
    letter-spacing: 0.1em;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
    text-transform: uppercase;
  }

  .rp-stat__value {
    display: block;
    font-size: 1.5rem;
    font-weight: 900;
    letter-spacing: -0.02em;
  }

  .rp-stat__value--accent {
    color: var(--accent-primary);
  }

  /* Yield + Save Row */
  .rp-yield-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .rp-yield {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background-color: var(--bg-tertiary);
    border-radius: 999px;
    padding: 0.5rem 1rem;
  }

  .rp-yield__label {
    font-size: 0.65rem;
    font-weight: 800;
    letter-spacing: 0.1em;
    color: var(--text-secondary);
    margin-right: 0.25rem;
  }

  .rp-yield__btn {
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: transparent;
    border: 1px solid var(--border-default);
    color: var(--text-primary);
    font-weight: 700;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .rp-yield__btn:hover {
    background: var(--bg-secondary);
  }

  .rp-yield__count {
    font-size: 1rem;
    font-weight: 900;
    min-width: 1.25rem;
    text-align: center;
  }

  .rp-save-btn {
    background-color: var(--accent-primary);
    color: var(--text-inverse);
    border: none;
    border-radius: 999px;
    padding: 0.65rem 1.5rem;
    font-size: 0.7rem;
    font-weight: 900;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .rp-save-btn:hover {
    opacity: 0.9;
  }

  /* Hero Image */
  .rp-hero-image {
    position: relative;
    border-radius: 1rem;
    overflow: hidden;
  }

  .rp-hero-image__img {
    width: 100%;
    height: auto;
    display: block;
    aspect-ratio: 3 / 2;
    object-fit: cover;
  }

  .rp-hero-image__line {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background-color: var(--accent-primary);
  }

  /* P:E Badge */
  .rp-pe-badge {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    width: 4rem;
    height: 4rem;
    border-radius: 50%;
    background-color: var(--accent-primary);
    color: var(--text-inverse);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 2;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .rp-pe-badge__label {
    font-size: 0.5rem;
    font-weight: 800;
    letter-spacing: 0.05em;
    line-height: 1;
  }

  .rp-pe-badge__value {
    font-size: 1.25rem;
    font-weight: 900;
    line-height: 1.1;
  }

  .rp-pe-badge__sublabel {
    position: absolute;
    bottom: -0.25rem;
    right: 1rem;
    font-size: 0.5rem;
    font-weight: 800;
    letter-spacing: 0.1em;
    color: var(--text-secondary);
    text-align: right;
    z-index: 2;
  }

  /* ─── SECTION TITLES ────────────────────────────── */
  .rp-section-title {
    font-size: 1.5rem;
    font-weight: 900;
    letter-spacing: -0.02em;
    margin-bottom: 1.5rem;
  }

  /* ─── INVENTORY LIST ────────────────────────────── */
  .rp-inventory__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .rp-inventory__header .rp-section-title {
    margin-bottom: 0;
  }

  .rp-toggle-pills {
    display: flex;
    gap: 0;
    border-radius: 999px;
    overflow: hidden;
    border: 1px solid var(--border-default);
  }

  .rp-pill {
    padding: 0.4rem 1rem;
    font-size: 0.6rem;
    font-weight: 800;
    letter-spacing: 0.08em;
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all 0.2s;
  }

  .rp-pill--active {
    background-color: var(--accent-primary);
    color: var(--text-inverse);
  }

  /* Ingredients Grid */
  .rp-ingredients-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem 2rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 640px) {
    .rp-ingredients-grid {
      grid-template-columns: 1fr;
    }
  }

  .rp-ingredient {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid color-mix(in srgb, var(--border-default) 40%, transparent);
  }

  .rp-ingredient__text {
    font-size: 0.85rem;
    font-weight: 600;
  }

  .rp-ingredient__role {
    font-size: 0.55rem;
    font-weight: 800;
    letter-spacing: 0.08em;
    color: var(--text-tertiary);
    white-space: nowrap;
    flex-shrink: 0;
  }

  /* Meal Prep Logistics */
  .rp-logistics {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-default);
    border-radius: 1rem;
    padding: 1.5rem;
  }

  .rp-logistics__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.25rem;
  }

  .rp-logistics__title {
    font-size: 0.7rem;
    font-weight: 900;
    letter-spacing: 0.15em;
    color: var(--accent-primary);
  }

  .rp-logistics__icon {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .rp-logistics__icon span {
    display: block;
    width: 1.25rem;
    height: 2px;
    background-color: var(--text-tertiary);
    border-radius: 1px;
  }

  .rp-logistics__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .rp-logistics__list li {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    font-size: 0.8rem;
    line-height: 1.5;
    color: var(--text-secondary);
  }

  .rp-logistics__dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--accent-primary);
    flex-shrink: 0;
    margin-top: 0.4rem;
  }

  .rp-logistics__list strong {
    color: var(--text-primary);
  }

  /* ─── EXECUTION STEPS ───────────────────────────── */
  .rp-steps__list {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .rp-step {
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
  }

  .rp-step__number {
    font-size: 2.5rem;
    font-weight: 900;
    line-height: 1;
    color: var(--text-tertiary);
    opacity: 0.3;
    flex-shrink: 0;
    min-width: 2.5rem;
  }

  .rp-step__content {
    flex: 1;
    padding-top: 0.25rem;
  }

  .rp-step__title {
    font-size: 0.95rem;
    font-weight: 900;
    letter-spacing: 0.02em;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
  }

  .rp-step__detail {
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--text-secondary);
  }

  /* Community Counter */
  .rp-community {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-top: 1.5rem;
  }

  .rp-community__dots {
    display: flex;
    gap: 4px;
  }

  .rp-community__dot {
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
  }

  .rp-community__dot--light {
    background-color: var(--bg-tertiary);
  }

  .rp-community__dot--dark {
    background-color: var(--text-tertiary);
  }

  .rp-community__text {
    font-size: 0.65rem;
    font-weight: 800;
    letter-spacing: 0.1em;
    color: var(--text-secondary);
  }

  /* ─── BOTTOM SECTION ────────────────────────────── */
  .rp-bottom {
    padding-top: 3rem;
    border-top: 1px solid var(--border-default);
  }

  .rp-bottom-col {
    min-height: 120px;
  }

  .rp-bottom__label {
    font-size: 0.6rem;
    font-weight: 900;
    letter-spacing: 0.15em;
    color: var(--accent-primary);
    margin-bottom: 1rem;
    text-transform: uppercase;
  }

  .rp-category-card {
    display: block;
    background-color: var(--bg-secondary);
    border-radius: 0.75rem;
    padding: 1.5rem;
    text-decoration: none;
    color: var(--text-primary);
    transition: opacity 0.2s;
  }

  .rp-category-card:hover {
    opacity: 0.85;
  }

  .rp-category-card__eyebrow {
    display: block;
    font-size: 0.55rem;
    font-weight: 800;
    letter-spacing: 0.1em;
    color: var(--text-tertiary);
    margin-bottom: 0.5rem;
  }

  .rp-category-card__title {
    display: block;
    font-size: 1.25rem;
    font-weight: 900;
  }

  /* Ingredient Pills */
  .rp-ingredient-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .rp-ing-pill {
    display: inline-block;
    padding: 0.4rem 0.75rem;
    border-radius: 999px;
    font-size: 0.65rem;
    font-weight: 800;
    letter-spacing: 0.05em;
    text-decoration: none;
    text-transform: uppercase;
    color: var(--text-primary);
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-default);
    transition: all 0.2s;
  }

  .rp-ing-pill:hover {
    background-color: var(--accent-primary);
    color: var(--text-inverse);
    border-color: var(--accent-primary);
  }

  /* Plan Link */
  .rp-plan-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    border: 1px solid var(--border-default);
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.2s;
  }

  .rp-plan-link:hover {
    border-color: var(--accent-primary);
  }

  .rp-plan-link__title {
    font-size: 0.7rem;
    font-weight: 800;
    letter-spacing: 0.05em;
  }

  .rp-plan-link__arrow {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--accent-primary);
  }

  /* Grocery List Button */
  .rp-grocery-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background-color: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-default);
    border-radius: 999px;
    padding: 0.65rem 1.25rem;
    font-size: 0.65rem;
    font-weight: 900;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .rp-grocery-btn:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }

  /* Print Prep Sheet Button */
  .rp-print-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background-color: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-default);
    border-radius: 999px;
    padding: 0.65rem 1.25rem;
    font-size: 0.65rem;
    font-weight: 900;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .rp-print-btn:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }

  /* ─── RESPONSIVE ────────────────────────────────── */
  @media (max-width: 768px) {
    .rp-stats {
      flex-wrap: wrap;
    }
    .rp-stat {
      flex: 1 1 45%;
    }
    .rp-hero__title {
      font-size: 2.5rem;
    }
  }

  /* ─── PRINT STYLES ─────────────────────────────── */
  @media print {
    /* Hide non-essential elements */
    .glass-nav,
    header,
    footer,
    .rp-hero__right,
    .rp-hero-image,
    .rp-pe-badge,
    .rp-pe-badge__sublabel,
    .rp-toggle-pills,
    .rp-community,
    .rp-bottom,
    .rp-yield-row,
    .rp-save-btn,
    .rp-grocery-btn,
    .rp-print-btn,
    .rp-pill,
    .scanner-line,
    nav,
    [data-auth-show],
    .breadcrumb-nav {
      display: none !important;
    }

    /* Reset backgrounds and colors for print */
    * {
      color: #000 !important;
      background: #fff !important;
      border-color: #ccc !important;
      box-shadow: none !important;
    }

    body, html {
      background: #fff !important;
      margin: 0;
      padding: 0;
    }

    .recipe-page {
      padding: 0 !important;
    }

    /* Single column layout */
    .rp-hero {
      margin-bottom: 1rem !important;
      padding: 0 !important;
    }

    .rp-hero .grid {
      display: block !important;
    }

    .rp-hero__title {
      font-size: 1.8rem !important;
      margin-bottom: 0.5rem !important;
      color: #000 !important;
    }

    .rp-hero__desc {
      font-size: 0.85rem !important;
      margin-bottom: 0.75rem !important;
      max-width: none !important;
      color: #333 !important;
    }

    /* Compact stats row */
    .rp-stats {
      margin-bottom: 1rem !important;
      border: 1px solid #ccc !important;
      border-radius: 4px !important;
      padding: 0.25rem !important;
    }

    .rp-stat {
      border-left: 2px solid #000 !important;
      padding: 0.3rem 0.5rem !important;
    }

    .rp-stat__label {
      font-size: 0.5rem !important;
    }

    .rp-stat__value {
      font-size: 1rem !important;
    }

    /* Body section: single column */
    .rp-body {
      padding: 0 !important;
      margin-bottom: 0 !important;
    }

    .rp-body .grid {
      display: block !important;
    }

    .rp-section-title {
      font-size: 1rem !important;
      margin-bottom: 0.5rem !important;
      border-bottom: 2px solid #000 !important;
      padding-bottom: 0.25rem !important;
    }

    /* Ingredients compact */
    .rp-ingredients-grid {
      grid-template-columns: 1fr 1fr !important;
      gap: 0.25rem 1rem !important;
      margin-bottom: 1rem !important;
    }

    .rp-ingredient {
      padding: 0.15rem 0 !important;
      font-size: 0.75rem !important;
    }

    .rp-ingredient__role {
      display: none !important;
    }

    /* Logistics box */
    .rp-logistics {
      border-radius: 4px !important;
      padding: 0.75rem !important;
      margin-bottom: 1rem !important;
      page-break-inside: avoid;
    }

    .rp-logistics__title {
      font-size: 0.6rem !important;
    }

    .rp-logistics__list li {
      font-size: 0.7rem !important;
    }

    /* Steps compact */
    .rp-steps__list {
      gap: 0.75rem !important;
    }

    .rp-step__number {
      font-size: 1.2rem !important;
      min-width: 1.5rem !important;
    }

    .rp-step__title {
      font-size: 0.75rem !important;
      margin-bottom: 0.15rem !important;
    }

    .rp-step__detail {
      font-size: 0.7rem !important;
    }

    /* Page break control */
    .rp-inventory {
      page-break-after: auto;
    }

    .rp-steps {
      page-break-before: auto;
    }
  }
</style>

<script is:inline define:vars={{ recipeSlug: recipe.slug, recipeName, recipeProtein: recipe.protein, recipeCalories: recipe.calories, heroImage, ingredientTexts: recipe.ingredients }}>
  document.addEventListener('DOMContentLoaded', function() {
    var saveBtn = document.getElementById('save-recipe-btn');
    var saveBtnText = document.getElementById('save-btn-text');
    var groceryBtn = document.getElementById('add-grocery-btn');

    // Update save button state
    function updateSaveState() {
      if (window.authHelper && window.authHelper.isRecipeSaved(recipeSlug)) {
        saveBtnText.textContent = '✓ SAVED';
        saveBtn.style.opacity = '0.75';
      }
    }

    // Save recipe click
    if (saveBtn) {
      saveBtn.addEventListener('click', function() {
        window.authHelper.requireAuth(function(user) {
          var recipe = { slug: recipeSlug, title: recipeName, protein: recipeProtein, calories: recipeCalories, image: heroImage, savedAt: new Date().toISOString() };
          if (window.authHelper.isRecipeSaved(recipeSlug)) {
            window.authHelper.unsaveRecipe(recipeSlug);
            saveBtnText.textContent = 'SAVE PROTOCOL';
            saveBtn.style.opacity = '1';
          } else {
            window.authHelper.saveRecipe(recipe);
            saveBtnText.textContent = '✓ SAVED';
            saveBtn.style.opacity = '0.75';
          }
        });
      });
    }

    // Grocery list click
    if (groceryBtn) {
      groceryBtn.addEventListener('click', function() {
        window.authHelper.requireAuth(function(user) {
          var list = window.authHelper.getGroceryList();
          ingredientTexts.forEach(function(ing) {
            if (!list.find(function(item) { return item.text === ing && item.recipe === recipeSlug; })) {
              list.push({ text: ing, recipe: recipeSlug, recipeName: recipeName, checked: false });
            }
          });
          window.authHelper.setGroceryList(list);
          groceryBtn.querySelector('span').textContent = '✓ ADDED';
          setTimeout(function() { groceryBtn.querySelector('span').textContent = 'GROCERY LIST'; }, 2000);
        });
      });
    }

    // Check initial state when Clerk loads
    window.addEventListener('clerk-ready', updateSaveState);
    if (window.__authReady) updateSaveState();
  });
</script>
