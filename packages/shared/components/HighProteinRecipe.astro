---
/**
 * HighProteinRecipe — High Protein Recipe Page (T4)
 * Theme-aware: uses CSS custom properties
 * Includes Schema.org Recipe structured data
 * Accepts a `recipe` object from the recipe data layer
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import BreadcrumbNav from './BreadcrumbNav.astro';
import type { Recipe } from '../data/content/recipes';

interface Props {
  recipe: Recipe;
  relatedRecipes?: Recipe[];
}

const { recipe, relatedRecipes = [] } = Astro.props;

// Build image path — local image for this recipe slug
const localImagePath = `/images/recipes/${recipe.slug}.jpg`;
const heroImage = localImagePath;
const fallbackImage = '/images/placeholder.svg';

// Map recipe data to template values
const recipeName = recipe.title;
const recipeId = `HP-${recipe.slug.split('-').map(w => w[0]?.toUpperCase()).join('').slice(0, 4)}`;
const prepTime = `${recipe.prepTime}m`;
const cookTime = `${recipe.cookTime}m`;
const totalTime = `${recipe.prepTime + recipe.cookTime}m`;
const servings = recipe.servings;
const proteinPerServing = `${recipe.protein}g`;
const caloriesPerServing = `${recipe.calories}`;
const peRatio = (recipe.protein * 4 / Math.max(1, recipe.calories - recipe.protein * 4)).toFixed(1);

const macros = [
  { label: 'Protein', value: `${recipe.protein}g`, percent: Math.min(100, Math.round((recipe.protein / 50) * 100)) },
  { label: 'Carbs', value: `${recipe.carbs}g`, percent: Math.min(100, Math.round((recipe.carbs / 100) * 100)) },
  { label: 'Fat', value: `${recipe.fat}g`, percent: Math.min(100, Math.round((recipe.fat / 65) * 100)) },
  { label: 'Fiber', value: `${recipe.fiber || 0}g`, percent: Math.min(100, Math.round(((recipe.fiber || 0) / 30) * 100)) },
];

const ingredients = recipe.ingredients.map((text, i) => ({ id: `ing-${i}`, text }));
const steps = recipe.instructions.map((detail, i) => ({
  number: String(i + 1).padStart(2, '0'),
  title: `Step ${i + 1}`,
  detail,
}));

const tags = Object.values(recipe.facets).filter(Boolean).slice(0, 4) as string[];

// Construct diet variants from facets
const dietVariants = [
  recipe.facets.diet && { name: `${recipe.facets.diet} Variation`, adjustments: `This recipe is optimized for ${recipe.facets.diet} dietary requirements.` },
  recipe.facets.goal && { name: `${recipe.facets.goal} Focus`, adjustments: `Portion and macro-adjusted for ${recipe.facets.goal} goals.` },
].filter(Boolean) as { name: string; adjustments: string }[];

// Parse time to ISO8601 Duration
function toISO8601Duration(minutes: number): string {
  if (minutes >= 60) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `PT${h}H${m > 0 ? m + 'M' : ''}`;
  }
  return `PT${minutes}M`;
}

const pageTitle = `${recipeName} | ProteinMeals.co`;
const pageDescription = recipe.description;

const structuredData = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Recipe',
  name: recipeName,
  description: recipe.description,
  image: heroImage,
  prepTime: toISO8601Duration(recipe.prepTime),
  cookTime: toISO8601Duration(recipe.cookTime),
  totalTime: toISO8601Duration(recipe.prepTime + recipe.cookTime),
  recipeYield: `${servings} servings`,
  recipeCategory: 'High Protein',
  nutrition: {
    '@type': 'NutritionInformation',
    proteinContent: proteinPerServing,
    calories: `${caloriesPerServing} cal`,
  },
  recipeIngredient: recipe.ingredients,
  recipeInstructions: steps.map(s => ({
    '@type': 'HowToStep',
    name: s.title,
    text: s.detail,
  })),
});
---

<BaseLayout title={pageTitle} description={pageDescription} canonicalUrl={`/high-protein/recipes/${recipe.slug}/`} structuredData={structuredData}>
  <HeaderNav
    statusText="Schema: Recipe + HowTo"
    navLinks={[
      { href: '/meal-prep/', label: 'Meal Prep' },
      { href: '/high-protein/', label: 'High Protein' },
    ]}
  />

  <main class="flex-grow" x-data={`{ dietView: 'original', servings: ${servings}, }`}>
    <BreadcrumbNav items={[
      { label: 'Home', href: '/' },
      { label: 'High Protein', href: '/high-protein/' },
      { label: recipeName },
    ]} />

    <!-- HERO -->
    <section class="px-6 max-w-7xl mx-auto mb-16">
      <div class="grid md:grid-cols-12 gap-12">
        <div class="md:col-span-7">
          <div class="flex flex-wrap items-center gap-3 mb-6">
            <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--accent-primary); color: var(--text-inverse);">{recipeId}</span>
            {tags.map(tag => (
              <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--bg-tertiary);">{tag}</span>
            ))}
          </div>
          <h1 class="text-5xl md:text-7xl font-black tracking-tighter leading-none mb-4">{recipeName}</h1>
          <p class="text-base mb-8 leading-relaxed" style="color: var(--text-secondary);">{recipe.description}</p>

          <!-- Key Metrics -->
          <div class="grid grid-cols-4 gap-3 mb-8">
            <div class="macro-card p-4 rounded-xl">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Protein</span>
              <span class="text-2xl font-black" style="color: var(--accent-primary);">{proteinPerServing}</span>
            </div>
            <div class="macro-card p-4 rounded-xl">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Calories</span>
              <span class="text-2xl font-black">{caloriesPerServing}</span>
            </div>
            <div class="macro-card p-4 rounded-xl">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">P:E Ratio</span>
              <span class="text-2xl font-black" style="color: var(--accent-primary);">{peRatio}</span>
            </div>
            <div class="macro-card p-4 rounded-xl">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Servings</span>
              <span class="text-2xl font-black" x-text="servings"></span>
            </div>
          </div>

          <!-- Full Macros -->
          <div class="border rounded-2xl p-6" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
            <h3 class="text-[10px] font-black uppercase tracking-widest mb-6" style="color: var(--text-secondary);">Full Macro Breakdown</h3>
            <div class="space-y-4">
              {macros.map(m => (
                <div>
                  <div class="flex justify-between text-[10px] font-black mb-1">
                    <span class="uppercase" style="color: var(--text-secondary);">{m.label}</span>
                    <span>{m.value}</span>
                  </div>
                  <div class="macro-bar">
                    <div class="macro-fill" style={`width: ${m.percent}%`}></div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
        <div class="md:col-span-5">
          <div class="aspect-[4/5] rounded-3xl overflow-hidden border relative group" style="border-color: var(--border-default);">
            <img
              src={heroImage}
              onerror={`this.onerror=null;this.src='${fallbackImage}'`}
              class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-1000"
              alt={recipe.imageAlt || recipeName}
              width="600"
              height="750"
              loading="eager"
            />
            <div class="recipe-gradient absolute inset-0"></div>
            <div class="scanner-line"></div>
            <div class="absolute bottom-6 left-6 right-6 backdrop-blur-md p-4 rounded-xl border" style="background-color: color-mix(in srgb, var(--bg-primary) 90%, transparent); border-color: var(--border-default);">
              <div class="flex justify-between items-center">
                <span class="text-[10px] font-black uppercase" style="color: var(--accent-primary);">High Protein Verified</span>
                <span class="text-[10px] font-black" style="color: var(--text-secondary);">{totalTime} Total</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- INGREDIENTS + STEPS -->
    <section class="py-16 px-6 border-y" style="background-color: var(--bg-primary); border-color: var(--border-default);">
      <div class="max-w-7xl mx-auto grid md:grid-cols-2 gap-16">
        {ingredients.length > 0 && (
          <div>
            <h2 class="text-3xl font-black tracking-tighter mb-8">Ingredients</h2>
            <div class="space-y-3">
              {ingredients.map(ing => (
                <div class="flex items-center gap-4 p-3 rounded-xl hover-bg-secondary transition-colors">
                  <div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: var(--accent-primary);"></div>
                  <span class="text-sm font-bold">{ing.text}</span>
                </div>
              ))}
            </div>
          </div>
        )}
        {steps.length > 0 && (
          <div>
            <h2 class="text-3xl font-black tracking-tighter mb-8">Method</h2>
            <div class="space-y-6">
              {steps.map(step => (
                <div class="flex gap-4">
                  <span class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 font-black text-xs" style="background-color: var(--accent-primary); color: var(--text-inverse);">{step.number}</span>
                  <div>
                    <h4 class="font-black mb-1">{step.title}</h4>
                    <p class="text-sm" style="color: var(--text-secondary);">{step.detail}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </section>

    <!-- DIET VARIANTS -->
    {dietVariants.length > 0 && (
      <section class="py-16 px-6 max-w-7xl mx-auto">
        <h2 class="text-3xl font-black tracking-tighter mb-8">Diet Variants</h2>
        <div class="grid md:grid-cols-3 gap-4">
          {dietVariants.map(v => (
            <div class="hyper-border rounded-2xl p-6">
              <h4 class="font-black mb-3" style="color: var(--accent-primary);">{v.name}</h4>
              <p class="text-sm" style="color: var(--text-secondary);">{v.adjustments}</p>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- RELATED RECIPES -->
    {relatedRecipes.length > 0 && (
      <section class="py-16 px-6 border-t" style="border-color: var(--border-default); background: var(--bg-tertiary);">
        <div class="max-w-7xl mx-auto">
          <h2 class="text-3xl font-black tracking-tighter mb-8">More High Protein Recipes</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {relatedRecipes.map(r => (
              <a href={`/high-protein/recipes/${r.slug}/`} class="group rounded-2xl overflow-hidden border transition-all hover:shadow-lg" style="border-color: var(--border-default); background: var(--bg-secondary);">
                <div class="aspect-video overflow-hidden relative">
                  <img
                    src={`/images/recipes/${r.slug}.jpg`}
                    onerror={`this.onerror=null;this.src='${fallbackImage}'`}
                    alt={r.imageAlt || r.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                    width="400"
                    height="225"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                </div>
                <div class="p-4">
                  <h3 class="font-black text-sm mb-2 group-hover:opacity-80 transition-opacity">{r.title}</h3>
                  <div class="flex gap-3 text-[10px] font-bold" style="color: var(--text-tertiary);">
                    <span>{r.protein}g protein</span>
                    <span>·</span>
                    <span>{r.calories} cal</span>
                    <span>·</span>
                    <span>{r.prepTime + r.cookTime}m</span>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}
  </main>

  <FooterNav copyrightSuffix={`Index Authority Network. Recipe ${recipeId}.`} />
</BaseLayout>
