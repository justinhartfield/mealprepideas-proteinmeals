---
/**
 * HighProteinRecipe — High Protein Recipe Page (T4)
 * Theme-aware: uses CSS custom properties
 * Includes Schema.org Recipe structured data
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import BreadcrumbNav from './BreadcrumbNav.astro';

interface Ingredient { id: string; text: string; }
interface Step { number: string; title: string; detail: string; time?: string; }
interface Macro { label: string; value: string; percent: number; color?: string; }

interface Props {
  title: string; description?: string; canonicalUrl?: string;
  recipeName: string; recipeId?: string;
  prepTime?: string; cookTime?: string; totalTime?: string; servings?: number;
  proteinPerServing?: string; caloriesPerServing?: string; peRatio?: string;
  macros?: Macro[];
  ingredients?: Ingredient[];
  steps?: Step[];
  dietVariants?: { name: string; adjustments: string }[];
  heroImage?: string;
  tags?: string[];
}

const {
  title, description, canonicalUrl, recipeName, recipeId = 'HP-001',
  prepTime = '10m', cookTime = '20m', totalTime = '30m', servings = 4,
  proteinPerServing = '48g', caloriesPerServing = '485', peRatio = '2.8',
  macros = [
    { label: 'Protein', value: '48g', percent: 85 },
    { label: 'Carbs', value: '28g', percent: 40 },
    { label: 'Fat', value: '14g', percent: 35 },
    { label: 'Fiber', value: '6g', percent: 25 },
  ],
  ingredients = [],
  steps = [],
  dietVariants = [],
  heroImage = 'https://images.unsplash.com/photo-1532550907401-a500c9a57435?auto=format&fit=crop&q=80&w=1200',
  tags = [],
} = Astro.props;

// Helper to parse time string like "15m" → "PT15M"
function toISO8601Duration(t: string): string {
  const h = t.match(/(\d+)\s*h/);
  const mins = t.match(/(\d+)\s*m/);
  let iso = 'PT';
  if (h) iso += h[1] + 'H';
  if (mins) iso += mins[1] + 'M';
  return iso === 'PT' ? `PT${t.replace(/[^0-9]/g, '')}M` : iso;
}

const structuredData = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Recipe',
  name: recipeName,
  description: description || `${recipeName} — high protein recipe optimized for macro targets.`,
  image: heroImage,
  prepTime: toISO8601Duration(prepTime),
  cookTime: toISO8601Duration(cookTime),
  totalTime: toISO8601Duration(totalTime),
  recipeYield: `${servings} servings`,
  recipeCategory: 'High Protein',
  nutrition: {
    '@type': 'NutritionInformation',
    proteinContent: proteinPerServing,
    calories: `${caloriesPerServing} cal`,
  },
  recipeIngredient: ingredients.map(i => i.text),
  recipeInstructions: steps.map(s => ({
    '@type': 'HowToStep',
    name: s.title,
    text: s.detail,
  })),
});
---

<BaseLayout title={title} description={description} canonicalUrl={canonicalUrl} structuredData={structuredData}>
  <HeaderNav
    statusText="Schema: Recipe + HowTo"
    navLinks={[
      { href: '/meal-prep/', label: 'Meal Prep' },
      { href: '/high-protein/', label: 'High Protein' },
    ]}
  />

  <main class="flex-grow" x-data={`{ dietView: 'original', servings: ${servings} }`}>
    <BreadcrumbNav items={[
      { label: 'Home', href: '/' },
      { label: 'High Protein', href: '/high-protein/' },
      { label: recipeName },
    ]} />

    <!-- HERO -->
    <section class="px-6 max-w-7xl mx-auto mb-16">
      <div class="grid md:grid-cols-12 gap-12">
        <div class="md:col-span-7">
          <div class="flex flex-wrap items-center gap-3 mb-6">
            <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--accent-primary); color: var(--text-inverse);">{recipeId}</span>
            {tags.map(tag => (
              <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--bg-tertiary);">{tag}</span>
            ))}
          </div>
          <h1 class="text-5xl md:text-7xl font-black tracking-tighter leading-none mb-8">{recipeName}</h1>

          <!-- Key Metrics -->
          <div class="grid grid-cols-4 gap-3 mb-8">
            <div class="macro-card p-4 rounded-xl">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Protein</span>
              <span class="text-2xl font-black" style="color: var(--accent-primary);">{proteinPerServing}</span>
            </div>
            <div class="macro-card p-4 rounded-xl">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Calories</span>
              <span class="text-2xl font-black">{caloriesPerServing}</span>
            </div>
            <div class="macro-card p-4 rounded-xl">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">P:E Ratio</span>
              <span class="text-2xl font-black" style="color: var(--accent-primary);">{peRatio}</span>
            </div>
            <div class="macro-card p-4 rounded-xl">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Servings</span>
              <span class="text-2xl font-black" x-text="servings"></span>
            </div>
          </div>

          <!-- Full Macros -->
          <div class="border rounded-2xl p-6" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
            <h3 class="text-[10px] font-black uppercase tracking-widest mb-6" style="color: var(--text-secondary);">Full Macro Breakdown</h3>
            <div class="space-y-4">
              {macros.map(m => (
                <div>
                  <div class="flex justify-between text-[10px] font-black mb-1">
                    <span class="uppercase" style="color: var(--text-secondary);">{m.label}</span>
                    <span>{m.value}</span>
                  </div>
                  <div class="macro-bar">
                    <div class="macro-fill" style={`width: ${m.percent}%`}></div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
        <div class="md:col-span-5">
          <div class="aspect-[4/5] rounded-3xl overflow-hidden border relative group" style="border-color: var(--border-default);">
            <img src={heroImage} class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-1000" alt={recipeName} />
            <div class="recipe-gradient absolute inset-0"></div>
            <div class="scanner-line"></div>
            <div class="absolute bottom-6 left-6 right-6 backdrop-blur-md p-4 rounded-xl border" style="background-color: color-mix(in srgb, var(--bg-primary) 90%, transparent); border-color: var(--border-default);">
              <div class="flex justify-between items-center">
                <span class="text-[10px] font-black uppercase" style="color: var(--accent-primary);">High Protein Verified</span>
                <span class="text-[10px] font-black" style="color: var(--text-secondary);">{totalTime} Total</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- INGREDIENTS + STEPS -->
    <section class="py-16 px-6 border-y" style="background-color: var(--bg-primary); border-color: var(--border-default);">
      <div class="max-w-7xl mx-auto grid md:grid-cols-2 gap-16">
        {ingredients.length > 0 && (
          <div>
            <h2 class="text-3xl font-black tracking-tighter mb-8">Ingredients</h2>
            <div class="space-y-3">
              {ingredients.map(ing => (
                <div class="flex items-center gap-4 p-3 rounded-xl hover-bg-secondary transition-colors">
                  <div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: var(--accent-primary);"></div>
                  <span class="text-sm font-bold">{ing.text}</span>
                </div>
              ))}
            </div>
          </div>
        )}
        {steps.length > 0 && (
          <div>
            <h2 class="text-3xl font-black tracking-tighter mb-8">Method</h2>
            <div class="space-y-6">
              {steps.map(step => (
                <div class="flex gap-4">
                  <span class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 font-black text-xs" style="background-color: var(--accent-primary); color: var(--text-inverse);">{step.number}</span>
                  <div>
                    <h4 class="font-black mb-1">{step.title}</h4>
                    <p class="text-sm" style="color: var(--text-secondary);">{step.detail}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </section>

    <!-- DIET VARIANTS -->
    {dietVariants.length > 0 && (
      <section class="py-16 px-6 max-w-7xl mx-auto">
        <h2 class="text-3xl font-black tracking-tighter mb-8">Diet Variants</h2>
        <div class="grid md:grid-cols-3 gap-4">
          {dietVariants.map(v => (
            <div class="hyper-border rounded-2xl p-6">
              <h4 class="font-black mb-3" style="color: var(--accent-primary);">{v.name}</h4>
              <p class="text-sm" style="color: var(--text-secondary);">{v.adjustments}</p>
            </div>
          ))}
        </div>
      </section>
    )}
  </main>

  <FooterNav copyrightSuffix={`Index Authority Network. Recipe ${recipeId}.`} />
</BaseLayout>
