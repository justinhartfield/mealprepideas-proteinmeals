---
/**
 * MealPrepRecipe — Meal Prep Recipe Page (T4)
 * Theme-aware: uses CSS custom properties
 * Includes Schema.org Recipe structured data
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import BreadcrumbNav from './BreadcrumbNav.astro';

interface Ingredient { id: string; text: string; }
interface Step { number: string; title: string; detail: string; time?: string; }
interface Macro { label: string; value: string; percent: number; }

interface Props {
  title: string; description?: string; canonicalUrl?: string;
  recipeName: string; recipeId?: string;
  prepTime?: string; cookTime?: string; totalTime?: string; servings?: number;
  macros?: Macro[];
  ingredients?: Ingredient[];
  steps?: Step[];
  storageNotes?: string[];
  reheatNotes?: string[];
  tags?: string[];
  heroImage?: string;
}

const {
  title, description, canonicalUrl, recipeName, recipeId = 'T4-001',
  prepTime = '15m', cookTime = '25m', totalTime = '40m', servings = 4,
  macros = [
    { label: 'Protein', value: '42g', percent: 75 },
    { label: 'Carbs', value: '35g', percent: 50 },
    { label: 'Fat', value: '12g', percent: 30 },
    { label: 'Calories', value: '520', percent: 60 },
  ],
  ingredients = [],
  steps = [],
  storageNotes = ['Fridge: 5 days in glass containers', 'Freezer: Up to 90 days', 'Separate sauces for best results'],
  reheatNotes = ['Microwave: 2-3 min, stir halfway', 'Air Fryer: 350°F for 5 min'],
  tags = [],
  heroImage = 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&q=80&w=1200',
} = Astro.props;

const ingredientsJson = JSON.stringify(ingredients);

// Helper to parse time string like "15m" → "PT15M"
function toISO8601Duration(t: string): string {
  const m = t.match(/(\d+)\s*h/);
  const mins = t.match(/(\d+)\s*m/);
  let iso = 'PT';
  if (m) iso += m[1] + 'H';
  if (mins) iso += mins[1] + 'M';
  return iso === 'PT' ? `PT${t.replace(/[^0-9]/g, '')}M` : iso;
}

// Find protein/calories from macros
const proteinMacro = macros.find(m => m.label.toLowerCase() === 'protein');
const calorieMacro = macros.find(m => m.label.toLowerCase() === 'calories');

const structuredData = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Recipe',
  name: recipeName,
  description: description || `${recipeName} — optimized meal prep recipe.`,
  image: heroImage,
  prepTime: toISO8601Duration(prepTime),
  cookTime: toISO8601Duration(cookTime),
  totalTime: toISO8601Duration(totalTime),
  recipeYield: `${servings} servings`,
  recipeCategory: 'Meal Prep',
  nutrition: {
    '@type': 'NutritionInformation',
    ...(proteinMacro ? { proteinContent: proteinMacro.value } : {}),
    ...(calorieMacro ? { calories: `${calorieMacro.value} cal` } : {}),
  },
  recipeIngredient: ingredients.map(i => i.text),
  recipeInstructions: steps.map(s => ({
    '@type': 'HowToStep',
    name: s.title,
    text: s.detail,
  })),
});
---

<BaseLayout title={title} description={description} canonicalUrl={canonicalUrl} structuredData={structuredData}>
  <HeaderNav statusText={`Recipe: ${recipeId}`} />

  <main class="flex-grow" x-data={`{ servings: ${servings}, showReheat: false, checkedIngredients: [], toggleIngredient(id) { this.checkedIngredients.includes(id) ? this.checkedIngredients = this.checkedIngredients.filter(i => i !== id) : this.checkedIngredients.push(id) } }`}>
    <!-- BREADCRUMB -->
    <BreadcrumbNav items={[
      { label: 'Home', href: '/' },
      { label: 'Meal Prep', href: '/meal-prep/' },
      { label: recipeName },
    ]} />

    <!-- HERO -->
    <section class="px-6 max-w-7xl mx-auto mb-16">
      <div class="grid md:grid-cols-12 gap-12">
        <div class="md:col-span-7">
          <div class="flex items-center gap-3 mb-6">
            <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--accent-primary); color: var(--text-inverse);">Recipe {recipeId}</span>
            {tags.map(tag => (
              <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--bg-tertiary);">{tag}</span>
            ))}
          </div>
          <h1 class="text-5xl md:text-7xl font-black tracking-tighter leading-none mb-8">{recipeName}</h1>
          <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="border rounded-xl p-4 text-center" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Prep</span>
              <span class="text-xl font-black">{prepTime}</span>
            </div>
            <div class="border rounded-xl p-4 text-center" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Cook</span>
              <span class="text-xl font-black">{cookTime}</span>
            </div>
            <div class="border rounded-xl p-4 text-center" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Total</span>
              <span class="text-xl font-black" style="color: var(--accent-primary);">{totalTime}</span>
            </div>
          </div>
          <!-- Macros -->
          <div class="border rounded-2xl p-6" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
            <h3 class="text-[10px] font-black uppercase tracking-widest mb-6" style="color: var(--text-secondary);">Macro Profile (Per Serving)</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              {macros.map(m => (
                <div>
                  <div class="flex justify-between text-[10px] font-black mb-2">
                    <span style="color: var(--text-secondary);">{m.label}</span>
                    <span style="color: var(--accent-primary);">{m.value}</span>
                  </div>
                  <div class="macro-bar">
                    <div class="macro-fill" style={`width: ${m.percent}%`}></div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
        <div class="md:col-span-5">
          <div class="aspect-[4/5] rounded-3xl overflow-hidden border relative group" style="border-color: var(--border-default);">
            <img src={heroImage} class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-1000" alt={recipeName} />
            <div class="recipe-gradient absolute inset-0"></div>
            <div class="scanner-line"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- INGREDIENTS -->
    {ingredients.length > 0 && (
      <section class="py-16 px-6 border-y" style="background-color: var(--bg-primary); border-color: var(--border-default);">
        <div class="max-w-7xl mx-auto grid md:grid-cols-2 gap-12">
          <div>
            <h2 class="text-3xl font-black tracking-tighter mb-8">Ingredients</h2>
            <div class="flex items-center gap-4 mb-6">
              <span class="text-[10px] font-black uppercase" style="color: var(--text-secondary);">Servings:</span>
              <div class="flex items-center gap-2">
                <button x-on:click="servings = Math.max(1, servings - 1)" class="w-8 h-8 rounded-lg flex items-center justify-center hover-bg-tertiary transition-colors" style="background-color: var(--bg-tertiary);">−</button>
                <span class="text-xl font-black w-8 text-center" x-text="servings"></span>
                <button x-on:click="servings++" class="w-8 h-8 rounded-lg flex items-center justify-center hover-bg-tertiary transition-colors" style="background-color: var(--bg-tertiary);">+</button>
              </div>
            </div>
            <div class="space-y-3">
              {ingredients.map(ing => (
                <label class="flex items-center gap-4 p-3 rounded-xl hover-bg-secondary transition-colors cursor-pointer group">
                  <div
                    x-on:click={`toggleIngredient('${ing.id}')`}
                    x-bind:class={`checkedIngredients.includes('${ing.id}') ? 'pill-active' : ''`}
                    x-bind:style={`checkedIngredients.includes('${ing.id}') ? 'background-color: var(--accent-primary); border-color: var(--accent-primary)' : 'border-color: var(--border-default)'`}
                    class="w-5 h-5 border-2 rounded flex items-center justify-center flex-shrink-0"
                  >
                    <svg x-show={`checkedIngredients.includes('${ing.id}')`} class="w-3 h-3" style="color: var(--text-inverse);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  <span
                    x-bind:style={`checkedIngredients.includes('${ing.id}') ? 'text-decoration: line-through; color: var(--text-tertiary)' : ''`}
                    class="text-sm font-bold transition-colors"
                  >{ing.text}</span>
                </label>
              ))}
            </div>
          </div>
          <div>
            <h2 class="text-3xl font-black tracking-tighter mb-8">Storage & Reheat</h2>
            <div class="space-y-4 mb-8">
              {storageNotes.map(note => (
                <div class="flex items-center gap-3 p-4 border rounded-xl" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
                  <span class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: var(--accent-primary);"></span>
                  <span class="text-sm font-bold">{note}</span>
                </div>
              ))}
            </div>
            <button x-on:click="showReheat = !showReheat" class="w-full border py-4 rounded-xl text-[10px] font-black uppercase tracking-widest hover-accent-border transition-all" style="background-color: var(--bg-tertiary); border-color: var(--border-default);">
              <span x-text="showReheat ? 'Hide Reheat Protocol' : 'Show Reheat Protocol'"></span>
            </button>
            <div x-show="showReheat" x-cloak class="mt-4 space-y-3">
              {reheatNotes.map(note => (
                <div class="p-4 border rounded-xl text-sm font-bold" style="background-color: var(--bg-secondary); border-color: var(--border-default);">{note}</div>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- STEPS -->
    {steps.length > 0 && (
      <section class="py-24 px-6 max-w-4xl mx-auto">
        <h2 class="text-4xl font-black tracking-tighter mb-12">Execution Protocol</h2>
        <div class="space-y-8">
          {steps.map(step => (
            <div class="flex gap-6">
              <div class="flex-shrink-0 w-12 h-12 rounded-2xl flex items-center justify-center font-black text-sm" style="background-color: var(--accent-primary); color: var(--text-inverse);">{step.number}</div>
              <div class="flex-1 pb-8 border-b" style="border-color: var(--border-default);">
                <h4 class="text-xl font-black mb-2">{step.title}</h4>
                <p style="color: var(--text-secondary);" class="leading-relaxed">{step.detail}</p>
                {step.time && <span class="text-[10px] font-black mt-2 inline-block" style="color: var(--accent-primary);">{step.time}</span>}
              </div>
            </div>
          ))}
        </div>
      </section>
    )}
  </main>

  <FooterNav copyrightSuffix={`Index Authority Network. Recipe ${recipeId}.`} />
</BaseLayout>
