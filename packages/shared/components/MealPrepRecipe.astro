---
/**
 * MealPrepRecipe — Meal Prep Recipe Page (T4)
 * Theme-aware: uses CSS custom properties
 * Includes Schema.org Recipe structured data
 * Accepts a `recipe` object from the recipe data layer
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import BreadcrumbNav from './BreadcrumbNav.astro';
import type { Recipe } from '../data/content/recipes';

interface Props {
  recipe: Recipe;
  relatedRecipes?: Recipe[];
}

const { recipe, relatedRecipes = [] } = Astro.props;

// Build image path — check if a local image exists for this recipe slug
const localImagePath = `/images/recipes/${recipe.slug}.jpg`;
const heroImage = localImagePath;
const fallbackImage = 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&q=80&w=1200';

// Map recipe data to template values
const recipeName = recipe.title;
const recipeId = `MP-${recipe.slug.split('-').map(w => w[0]?.toUpperCase()).join('').slice(0, 4)}`;
const prepTime = `${recipe.prepTime}m`;
const cookTime = `${recipe.cookTime}m`;
const totalTime = `${recipe.prepTime + recipe.cookTime}m`;
const servings = recipe.servings;

const macros = [
  { label: 'Protein', value: `${recipe.protein}g`, percent: Math.min(100, Math.round((recipe.protein / 50) * 100)) },
  { label: 'Carbs', value: `${recipe.carbs}g`, percent: Math.min(100, Math.round((recipe.carbs / 100) * 100)) },
  { label: 'Fat', value: `${recipe.fat}g`, percent: Math.min(100, Math.round((recipe.fat / 65) * 100)) },
  { label: 'Calories', value: `${recipe.calories}`, percent: Math.min(100, Math.round((recipe.calories / 800) * 100)) },
];

const ingredients = recipe.ingredients.map((text, i) => ({ id: `ing-${i}`, text }));
const steps = recipe.instructions.map((detail, i) => ({
  number: String(i + 1).padStart(2, '0'),
  title: `Step ${i + 1}`,
  detail,
}));

const storageNotes = [recipe.storageInstructions, ...recipe.tips.slice(0, 2)].filter(Boolean);
const reheatNotes = recipe.reheatingInstructions ? [recipe.reheatingInstructions] : [];

const tags = Object.values(recipe.facets).filter(Boolean).slice(0, 4) as string[];

// Parse time string to ISO8601 Duration
function toISO8601Duration(minutes: number): string {
  if (minutes >= 60) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `PT${h}H${m > 0 ? m + 'M' : ''}`;
  }
  return `PT${minutes}M`;
}

const proteinMacro = macros.find(m => m.label.toLowerCase() === 'protein');
const calorieMacro = macros.find(m => m.label.toLowerCase() === 'calories');

const pageTitle = `${recipeName} | MealPrepIdeas.co`;
const pageDescription = recipe.description;

const structuredData = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Recipe',
  name: recipeName,
  description: recipe.description,
  image: heroImage,
  prepTime: toISO8601Duration(recipe.prepTime),
  cookTime: toISO8601Duration(recipe.cookTime),
  totalTime: toISO8601Duration(recipe.prepTime + recipe.cookTime),
  recipeYield: `${servings} servings`,
  recipeCategory: 'Meal Prep',
  nutrition: {
    '@type': 'NutritionInformation',
    ...(proteinMacro ? { proteinContent: proteinMacro.value } : {}),
    ...(calorieMacro ? { calories: `${calorieMacro.value} cal` } : {}),
  },
  recipeIngredient: recipe.ingredients,
  recipeInstructions: steps.map(s => ({
    '@type': 'HowToStep',
    name: s.title,
    text: s.detail,
  })),
});
---

<BaseLayout title={pageTitle} description={pageDescription} canonicalUrl={`/meal-prep/recipes/${recipe.slug}/`} structuredData={structuredData}>
  <HeaderNav statusText={`Recipe: ${recipeId}`} />

  <main class="flex-grow" x-data={`{ servings: ${servings}, showReheat: false, checkedIngredients: [], toggleIngredient(id) { this.checkedIngredients.includes(id) ? this.checkedIngredients = this.checkedIngredients.filter(i => i !== id) : this.checkedIngredients.push(id) } }`}>
    <!-- BREADCRUMB -->
    <BreadcrumbNav items={[
      { label: 'Home', href: '/' },
      { label: 'Meal Prep', href: '/meal-prep/' },
      { label: recipeName },
    ]} />

    <!-- HERO -->
    <section class="px-6 max-w-7xl mx-auto mb-16">
      <div class="grid md:grid-cols-12 gap-12">
        <div class="md:col-span-7">
          <div class="flex flex-wrap items-center gap-3 mb-6">
            <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--accent-primary); color: var(--text-inverse);">Recipe {recipeId}</span>
            {tags.map(tag => (
              <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--bg-tertiary);">{tag}</span>
            ))}
          </div>
          <h1 class="text-5xl md:text-7xl font-black tracking-tighter leading-none mb-4">{recipeName}</h1>
          <p class="text-base mb-8 leading-relaxed" style="color: var(--text-secondary);">{recipe.description}</p>
          <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="border rounded-xl p-4 text-center" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Prep</span>
              <span class="text-xl font-black">{prepTime}</span>
            </div>
            <div class="border rounded-xl p-4 text-center" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Cook</span>
              <span class="text-xl font-black">{cookTime}</span>
            </div>
            <div class="border rounded-xl p-4 text-center" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
              <span class="text-[10px] font-black uppercase block mb-1" style="color: var(--text-secondary);">Total</span>
              <span class="text-xl font-black" style="color: var(--accent-primary);">{totalTime}</span>
            </div>
          </div>
          <!-- Macros -->
          <div class="border rounded-2xl p-6" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
            <h3 class="text-[10px] font-black uppercase tracking-widest mb-6" style="color: var(--text-secondary);">Macro Profile (Per Serving)</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              {macros.map(m => (
                <div>
                  <div class="flex justify-between text-[10px] font-black mb-2">
                    <span style="color: var(--text-secondary);">{m.label}</span>
                    <span style="color: var(--accent-primary);">{m.value}</span>
                  </div>
                  <div class="macro-bar">
                    <div class="macro-fill" style={`width: ${m.percent}%`}></div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
        <div class="md:col-span-5">
          <div class="aspect-[4/5] rounded-3xl overflow-hidden border relative group" style="border-color: var(--border-default);">
            <img
              src={heroImage}
              onerror={`this.onerror=null;this.src='${fallbackImage}'`}
              class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-1000"
              alt={recipe.imageAlt || recipeName}
              width="600"
              height="750"
              loading="eager"
            />
            <div class="recipe-gradient absolute inset-0"></div>
            <div class="scanner-line"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- INGREDIENTS -->
    {ingredients.length > 0 && (
      <section class="py-16 px-6 border-y" style="background-color: var(--bg-primary); border-color: var(--border-default);">
        <div class="max-w-7xl mx-auto grid md:grid-cols-2 gap-12">
          <div>
            <h2 class="text-3xl font-black tracking-tighter mb-8">Ingredients</h2>
            <div class="flex items-center gap-4 mb-6">
              <span class="text-[10px] font-black uppercase" style="color: var(--text-secondary);">Servings:</span>
              <div class="flex items-center gap-2">
                <button x-on:click="servings = Math.max(1, servings - 1)" class="w-8 h-8 rounded-lg flex items-center justify-center hover-bg-tertiary transition-colors" style="background-color: var(--bg-tertiary);">−</button>
                <span class="text-xl font-black w-8 text-center" x-text="servings"></span>
                <button x-on:click="servings++" class="w-8 h-8 rounded-lg flex items-center justify-center hover-bg-tertiary transition-colors" style="background-color: var(--bg-tertiary);">+</button>
              </div>
            </div>
            <div class="space-y-3">
              {ingredients.map(ing => (
                <label class="flex items-center gap-4 p-3 rounded-xl hover-bg-secondary transition-colors cursor-pointer group">
                  <div
                    x-on:click={`toggleIngredient('${ing.id}')`}
                    x-bind:class={`checkedIngredients.includes('${ing.id}') ? 'pill-active' : ''`}
                    x-bind:style={`checkedIngredients.includes('${ing.id}') ? 'background-color: var(--accent-primary); border-color: var(--accent-primary)' : 'border-color: var(--border-default)'`}
                    class="w-5 h-5 border-2 rounded flex items-center justify-center flex-shrink-0"
                  >
                    <svg x-show={`checkedIngredients.includes('${ing.id}')`} class="w-3 h-3" style="color: var(--text-inverse);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  <span
                    x-bind:style={`checkedIngredients.includes('${ing.id}') ? 'text-decoration: line-through; color: var(--text-tertiary)' : ''`}
                    class="text-sm font-bold transition-colors"
                  >{ing.text}</span>
                </label>
              ))}
            </div>
          </div>
          <div>
            <h2 class="text-3xl font-black tracking-tighter mb-8">Storage & Reheat</h2>
            <div class="space-y-4 mb-8">
              {storageNotes.map(note => (
                <div class="flex items-center gap-3 p-4 border rounded-xl" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
                  <span class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: var(--accent-primary);"></span>
                  <span class="text-sm font-bold">{note}</span>
                </div>
              ))}
            </div>
            {reheatNotes.length > 0 && (
              <div>
                <button x-on:click="showReheat = !showReheat" class="w-full border py-4 rounded-xl text-[10px] font-black uppercase tracking-widest hover-accent-border transition-all" style="background-color: var(--bg-tertiary); border-color: var(--border-default);">
                  <span x-text="showReheat ? 'Hide Reheat Protocol' : 'Show Reheat Protocol'"></span>
                </button>
                <div x-show="showReheat" x-cloak class="mt-4 space-y-3">
                  {reheatNotes.map(note => (
                    <div class="p-4 border rounded-xl text-sm font-bold" style="background-color: var(--bg-secondary); border-color: var(--border-default);">{note}</div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </section>
    )}

    <!-- STEPS -->
    {steps.length > 0 && (
      <section class="py-24 px-6 max-w-4xl mx-auto">
        <h2 class="text-4xl font-black tracking-tighter mb-12">Execution Protocol</h2>
        <div class="space-y-8">
          {steps.map(step => (
            <div class="flex gap-6">
              <div class="flex-shrink-0 w-12 h-12 rounded-2xl flex items-center justify-center font-black text-sm" style="background-color: var(--accent-primary); color: var(--text-inverse);">{step.number}</div>
              <div class="flex-1 pb-8 border-b" style="border-color: var(--border-default);">
                <h4 class="text-xl font-black mb-2">{step.title}</h4>
                <p style="color: var(--text-secondary);" class="leading-relaxed">{step.detail}</p>
              </div>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- RELATED RECIPES -->
    {relatedRecipes.length > 0 && (
      <section class="py-16 px-6 border-t" style="border-color: var(--border-default); background: var(--bg-tertiary);">
        <div class="max-w-7xl mx-auto">
          <h2 class="text-3xl font-black tracking-tighter mb-8">More Meal Prep Recipes</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {relatedRecipes.map(r => (
              <a href={`/meal-prep/recipes/${r.slug}/`} class="group rounded-2xl overflow-hidden border transition-all hover:shadow-lg" style="border-color: var(--border-default); background: var(--bg-secondary);">
                <div class="aspect-video overflow-hidden relative">
                  <img
                    src={`/images/recipes/${r.slug}.jpg`}
                    onerror={`this.onerror=null;this.src='${fallbackImage}'`}
                    alt={r.imageAlt || r.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                    width="400"
                    height="225"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                </div>
                <div class="p-4">
                  <h3 class="font-black text-sm mb-2 group-hover:opacity-80 transition-opacity">{r.title}</h3>
                  <div class="flex gap-3 text-[10px] font-bold" style="color: var(--text-tertiary);">
                    <span>{r.protein}g protein</span>
                    <span>·</span>
                    <span>{r.calories} cal</span>
                    <span>·</span>
                    <span>{r.prepTime + r.cookTime}m</span>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}
  </main>

  <FooterNav copyrightSuffix={`Index Authority Network. Recipe ${recipeId}.`} />
</BaseLayout>
