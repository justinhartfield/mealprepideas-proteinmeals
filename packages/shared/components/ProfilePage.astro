---
/**
 * ProfilePage — User profile with saved recipes, grocery list, macro calculator
 * Theme-aware, client-side auth via Clerk JS
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';

interface Props {
  site?: 'mealprepideas' | 'proteinmeals';
}

const { site = 'mealprepideas' } = Astro.props;
const isProteinmeals = site === 'proteinmeals';
const siteName = isProteinmeals ? 'ProteinMeals.co' : 'MealPrepIdeas.co';
---

<BaseLayout title={`Your Profile | ${siteName}`} description="Manage your saved recipes, grocery list, and macro targets.">
  <HeaderNav site={site} />

  <main class="flex-grow px-6 py-12 max-w-5xl mx-auto" x-data="profileApp()" x-init="init()">
    <!-- Auth Gate: Not Signed In -->
    <div x-show="!isSignedIn" x-cloak class="text-center py-24">
      <div class="w-20 h-20 rounded-full mx-auto mb-6 flex items-center justify-center" style="background: var(--bg-secondary); border: 2px solid var(--border-default);">
        <svg class="w-10 h-10" style="color: var(--text-tertiary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
      </div>
      <h1 class="text-3xl font-black uppercase tracking-tight mb-4" style="color: var(--text-primary);">SIGN IN REQUIRED</h1>
      <p class="text-sm mb-8 max-w-md mx-auto" style="color: var(--text-secondary);">Create a free account to save recipes, build grocery lists, and track your macros.</p>
      <button @click="window.authHelper && window.authHelper.openSignIn()" class="px-8 py-3 rounded-full text-sm font-black uppercase tracking-wider cursor-pointer transition-all" style="background: var(--accent-primary); color: var(--text-inverse); border: none;">
        SIGN IN / CREATE ACCOUNT
      </button>
    </div>

    <!-- Auth Gate: Signed In -->
    <div x-show="isSignedIn" x-cloak>
      <!-- Profile Header -->
      <div class="flex items-center gap-6 mb-12 pb-8" style="border-bottom: 1px solid var(--border-default);">
        <img :src="userAvatar" alt="Avatar" class="w-20 h-20 rounded-full object-cover" style="border: 3px solid var(--accent-primary);" />
        <div>
          <h1 class="text-3xl font-black uppercase tracking-tight" style="color: var(--text-primary);" x-text="userName">User</h1>
          <p class="text-sm mt-1" style="color: var(--text-secondary);" x-text="userEmail">email@example.com</p>
          <p class="text-[10px] font-bold uppercase tracking-widest mt-2" style="color: var(--accent-primary);">FREE MEMBER</p>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="flex gap-1 mb-10 overflow-x-auto pb-2" style="border-bottom: 1px solid var(--border-default);">
        <template x-for="tab in tabs">
          <button @click="activeTab = tab.id; window.location.hash = tab.id"
                  :class="activeTab === tab.id ? 'profile-tab-active' : 'profile-tab'"
                  class="px-5 py-3 text-xs font-black uppercase tracking-widest whitespace-nowrap transition-all cursor-pointer"
                  x-text="tab.label" style="border: none; background: none;"></button>
        </template>
      </div>

      <!-- TAB: Saved Recipes -->
      <div x-show="activeTab === 'saved'" x-transition>
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-black uppercase tracking-tight">SAVED RECIPES</h2>
          <span class="text-xs font-bold" style="color: var(--text-tertiary);" x-text="savedRecipes.length + ' PROTOCOLS'"></span>
        </div>
        <div x-show="savedRecipes.length === 0" class="text-center py-16">
          <p class="text-sm" style="color: var(--text-tertiary);">No saved recipes yet. Browse recipes and click SAVE PROTOCOL to add them here.</p>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <template x-for="(recipe, i) in savedRecipes" :key="recipe.slug">
            <div class="rounded-xl overflow-hidden transition-all" style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
              <img :src="recipe.image || '/images/placeholder.svg'" :alt="recipe.title" class="w-full h-40 object-cover" style="filter: grayscale(30%);" />
              <div class="p-4">
                <h3 class="text-sm font-black uppercase tracking-tight mb-2" x-text="recipe.title"></h3>
                <div class="flex items-center gap-4 mb-3">
                  <span class="text-xs font-bold" style="color: var(--accent-primary);" x-text="recipe.protein + 'g protein'"></span>
                  <span class="text-xs" style="color: var(--text-tertiary);" x-text="recipe.calories + ' cal'"></span>
                </div>
                <div class="flex items-center gap-2">
                  <a :href="getRecipeUrl(recipe.slug)" class="flex-1 text-center py-2 rounded-lg text-[10px] font-black uppercase tracking-wider" style="background: var(--accent-primary); color: var(--text-inverse); text-decoration: none;">VIEW</a>
                  <button @click="removeRecipe(recipe.slug)" class="px-3 py-2 rounded-lg text-[10px] font-black uppercase tracking-wider cursor-pointer" style="background: none; border: 1px solid var(--border-default); color: var(--text-tertiary);">✕</button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- TAB: Grocery List -->
      <div x-show="activeTab === 'grocery'" x-transition>
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-black uppercase tracking-tight">GROCERY LIST</h2>
          <div class="flex gap-3">
            <span class="text-xs font-bold" style="color: var(--text-tertiary);" x-text="groceryList.length + ' ITEMS'"></span>
            <button x-show="groceryList.length > 0" @click="clearGrocery()" class="text-[10px] font-bold uppercase tracking-wider cursor-pointer" style="background:none; border:none; color: var(--accent-primary);">CLEAR ALL</button>
          </div>
        </div>
        <div x-show="groceryList.length === 0" class="text-center py-16">
          <p class="text-sm" style="color: var(--text-tertiary);">Your grocery list is empty. Add ingredients from any recipe page.</p>
        </div>
        <div class="space-y-2">
          <template x-for="(item, i) in groceryList" :key="i">
            <div class="flex items-center gap-4 px-4 py-3 rounded-lg transition-all" :style="item.checked ? 'background: var(--bg-tertiary); opacity: 0.5;' : 'background: var(--bg-secondary); border: 1px solid var(--border-default);'">
              <button @click="toggleGroceryItem(i)" class="w-5 h-5 rounded-md flex items-center justify-center cursor-pointer flex-shrink-0" :style="item.checked ? 'background: var(--accent-primary); border: none;' : 'background: none; border: 2px solid var(--border-default);'">
                <svg x-show="item.checked" class="w-3 h-3" style="color: var(--text-inverse);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
              </button>
              <div class="flex-1 min-w-0">
                <span class="text-sm font-semibold" :class="item.checked ? 'line-through' : ''" x-text="item.text"></span>
                <span class="block text-[10px] font-bold uppercase tracking-wider mt-0.5" style="color: var(--text-tertiary);" x-text="'From: ' + item.recipeName"></span>
              </div>
              <button @click="removeGroceryItem(i)" class="text-xs cursor-pointer flex-shrink-0" style="background:none; border:none; color: var(--text-tertiary);">✕</button>
            </div>
          </template>
        </div>
      </div>

      <!-- TAB: Macro Calculator -->
      <div x-show="activeTab === 'macros'" x-transition id="macros">
        <h2 class="text-xl font-black uppercase tracking-tight mb-6">MACRO CALCULATOR</h2>
        <div class="grid md:grid-cols-2 gap-8">
          <!-- Input Form -->
          <div class="p-6 rounded-xl" style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
            <h3 class="text-xs font-black uppercase tracking-widest mb-6" style="color: var(--accent-primary);">YOUR STATS</h3>
            <div class="space-y-5">
              <div>
                <label class="block text-[10px] font-bold uppercase tracking-widest mb-2" style="color: var(--text-tertiary);">Gender</label>
                <div class="flex gap-2">
                  <button @click="macros.gender = 'male'" :class="macros.gender === 'male' ? 'profile-tab-active' : 'profile-tab'" class="flex-1 py-2 text-xs font-bold uppercase tracking-wider cursor-pointer rounded-lg" style="border: 1px solid var(--border-default);">Male</button>
                  <button @click="macros.gender = 'female'" :class="macros.gender === 'female' ? 'profile-tab-active' : 'profile-tab'" class="flex-1 py-2 text-xs font-bold uppercase tracking-wider cursor-pointer rounded-lg" style="border: 1px solid var(--border-default);">Female</button>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-[10px] font-bold uppercase tracking-widest mb-2" style="color: var(--text-tertiary);">Age</label>
                  <input type="number" x-model.number="macros.age" class="w-full px-3 py-2 rounded-lg text-sm font-bold" style="background: var(--bg-primary); border: 1px solid var(--border-default); color: var(--text-primary);" />
                </div>
                <div>
                  <label class="block text-[10px] font-bold uppercase tracking-widest mb-2" style="color: var(--text-tertiary);">Weight (lbs)</label>
                  <input type="number" x-model.number="macros.weight" class="w-full px-3 py-2 rounded-lg text-sm font-bold" style="background: var(--bg-primary); border: 1px solid var(--border-default); color: var(--text-primary);" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-[10px] font-bold uppercase tracking-widest mb-2" style="color: var(--text-tertiary);">Height (in)</label>
                  <input type="number" x-model.number="macros.height" class="w-full px-3 py-2 rounded-lg text-sm font-bold" style="background: var(--bg-primary); border: 1px solid var(--border-default); color: var(--text-primary);" />
                </div>
                <div>
                  <label class="block text-[10px] font-bold uppercase tracking-widest mb-2" style="color: var(--text-tertiary);">Activity</label>
                  <select x-model="macros.activity" class="w-full px-3 py-2 rounded-lg text-sm font-bold appearance-none" style="background: var(--select-bg); border: 1px solid var(--select-border); color: var(--text-primary);">
                    <option value="1.2">Sedentary</option>
                    <option value="1.375">Light</option>
                    <option value="1.55">Moderate</option>
                    <option value="1.725">Active</option>
                    <option value="1.9">Very Active</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="block text-[10px] font-bold uppercase tracking-widest mb-2" style="color: var(--text-tertiary);">Goal</label>
                <div class="flex gap-2">
                  <button @click="macros.goal = 'lose'" :class="macros.goal === 'lose' ? 'profile-tab-active' : 'profile-tab'" class="flex-1 py-2 text-[10px] font-bold uppercase tracking-wider cursor-pointer rounded-lg" style="border: 1px solid var(--border-default);">Cut</button>
                  <button @click="macros.goal = 'maintain'" :class="macros.goal === 'maintain' ? 'profile-tab-active' : 'profile-tab'" class="flex-1 py-2 text-[10px] font-bold uppercase tracking-wider cursor-pointer rounded-lg" style="border: 1px solid var(--border-default);">Maintain</button>
                  <button @click="macros.goal = 'gain'" :class="macros.goal === 'gain' ? 'profile-tab-active' : 'profile-tab'" class="flex-1 py-2 text-[10px] font-bold uppercase tracking-wider cursor-pointer rounded-lg" style="border: 1px solid var(--border-default);">Bulk</button>
                </div>
              </div>
              <button @click="calculateMacros(); saveMacros()" class="w-full py-3 rounded-full text-xs font-black uppercase tracking-wider cursor-pointer transition-all" style="background: var(--accent-primary); color: var(--text-inverse); border: none;">
                CALCULATE TARGETS
              </button>
            </div>
          </div>

          <!-- Results -->
          <div>
            <div x-show="macroResults" class="space-y-4">
              <div class="p-6 rounded-xl" style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
                <h3 class="text-[10px] font-black uppercase tracking-widest mb-4" style="color: var(--accent-primary);">DAILY TARGETS</h3>
                <div class="text-center mb-6">
                  <span class="text-5xl font-black" style="color: var(--text-primary);" x-text="macroResults ? macroResults.calories : '—'"></span>
                  <span class="text-xs font-bold uppercase tracking-wider ml-1" style="color: var(--text-tertiary);">KCAL/DAY</span>
                </div>
                <div class="grid grid-cols-3 gap-4">
                  <div class="text-center p-3 rounded-lg" style="background: var(--bg-primary);">
                    <span class="block text-2xl font-black" style="color: var(--accent-primary);" x-text="macroResults ? macroResults.protein + 'g' : '—'"></span>
                    <span class="text-[10px] font-bold uppercase tracking-wider" style="color: var(--text-tertiary);">PROTEIN</span>
                  </div>
                  <div class="text-center p-3 rounded-lg" style="background: var(--bg-primary);">
                    <span class="block text-2xl font-black" x-text="macroResults ? macroResults.carbs + 'g' : '—'"></span>
                    <span class="text-[10px] font-bold uppercase tracking-wider" style="color: var(--text-tertiary);">CARBS</span>
                  </div>
                  <div class="text-center p-3 rounded-lg" style="background: var(--bg-primary);">
                    <span class="block text-2xl font-black" x-text="macroResults ? macroResults.fat + 'g' : '—'"></span>
                    <span class="text-[10px] font-bold uppercase tracking-wider" style="color: var(--text-tertiary);">FAT</span>
                  </div>
                </div>
              </div>
              <div class="p-4 rounded-xl text-xs" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                <strong style="color: var(--accent-primary);">PRO TIP:</strong> Aim for <span x-text="macroResults ? macroResults.protein : '—'"></span>g protein split across 4-5 meals = <span x-text="macroResults ? Math.round(macroResults.protein / 4.5) : '—'"></span>g per meal.
              </div>
            </div>
            <div x-show="!macroResults" class="flex items-center justify-center py-16 text-center">
              <p class="text-sm" style="color: var(--text-tertiary);">Enter your stats and click Calculate to see your personalized macro targets.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Settings -->
      <div x-show="activeTab === 'settings'" x-transition>
        <h2 class="text-xl font-black uppercase tracking-tight mb-6">ACCOUNT SETTINGS</h2>
        <div class="p-6 rounded-xl mb-6" style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
          <h3 class="text-xs font-black uppercase tracking-widest mb-4" style="color: var(--accent-primary);">DIETARY PREFERENCES</h3>
          <div class="flex flex-wrap gap-2">
            <template x-for="pref in allDietPrefs">
              <button @click="togglePref(pref)" :class="dietaryPrefs.includes(pref) ? 'profile-tab-active' : 'profile-tab'" class="px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-wider cursor-pointer" style="border: 1px solid var(--border-default);" x-text="pref"></button>
            </template>
          </div>
        </div>
        <div class="p-6 rounded-xl" style="background: var(--bg-secondary); border: 1px solid var(--border-default);">
          <h3 class="text-xs font-black uppercase tracking-widest mb-4" style="color: var(--accent-primary);">MANAGE DATA</h3>
          <div class="flex gap-3">
            <button @click="exportData()" class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider cursor-pointer" style="background: var(--bg-tertiary); border: 1px solid var(--border-default); color: var(--text-secondary);">EXPORT DATA</button>
            <button @click="if(confirm('Clear all saved data? This cannot be undone.')) clearAllData()" class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider cursor-pointer" style="background: none; border: 1px solid var(--border-default); color: var(--text-tertiary);">CLEAR ALL DATA</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <FooterNav site={site} />
</BaseLayout>

<style>
  .profile-tab-active {
    background-color: var(--accent-primary) !important;
    color: var(--text-inverse) !important;
    border-color: var(--accent-primary) !important;
  }
  .profile-tab {
    background-color: transparent;
    color: var(--text-tertiary);
  }
  .profile-tab:hover {
    color: var(--text-primary);
  }
  input[type="number"] {
    -moz-appearance: textfield;
  }
  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button {
    -webkit-appearance: none;
  }
</style>

<script is:inline>
  function profileApp() {
    return {
      isSignedIn: false,
      userName: '',
      userEmail: '',
      userAvatar: '/images/placeholder.svg',
      activeTab: 'saved',
      tabs: [
        { id: 'saved', label: 'Saved Recipes' },
        { id: 'grocery', label: 'Grocery List' },
        { id: 'macros', label: 'Macro Calculator' },
        { id: 'settings', label: 'Settings' },
      ],
      savedRecipes: [],
      groceryList: [],
      dietaryPrefs: [],
      allDietPrefs: ['Keto', 'Vegan', 'Vegetarian', 'Gluten-Free', 'Dairy-Free', 'Low-Carb', 'Low-Calorie', 'High-Fiber'],
      macros: { gender: 'male', age: 30, weight: 170, height: 70, activity: '1.55', goal: 'maintain' },
      macroResults: null,

      init() {
        // Load from hash
        var hash = window.location.hash.replace('#', '');
        if (hash && this.tabs.find(t => t.id === hash)) this.activeTab = hash;

        // Load saved data
        this.savedRecipes = window.authHelper ? window.authHelper.getSavedRecipes() : [];
        this.groceryList = window.authHelper ? window.authHelper.getGroceryList() : [];
        this.dietaryPrefs = JSON.parse(localStorage.getItem('dietaryPrefs') || '[]');
        var savedMacros = window.authHelper ? window.authHelper.getMacroProfile() : null;
        if (savedMacros) {
          this.macros = savedMacros.input || this.macros;
          this.macroResults = savedMacros.results || null;
        }

        // Wait for Clerk
        var self = this;
        function checkAuth() {
          if (window.authHelper && window.authHelper.isSignedIn()) {
            var user = window.authHelper.getUser();
            self.isSignedIn = true;
            self.userName = user.fullName || user.firstName || 'User';
            self.userEmail = user.primaryEmailAddress ? user.primaryEmailAddress.emailAddress : '';
            self.userAvatar = user.imageUrl || '/images/placeholder.svg';
          }
        }
        window.addEventListener('clerk-ready', checkAuth);
        if (window.__authReady) checkAuth();
      },

      getRecipeUrl(slug) {
        // Determine hub from saved recipe data or default
        var isHP = window.location.href.includes('proteinmeals');
        return isHP ? '/high-protein/recipes/' + slug + '/' : '/meal-prep/recipes/' + slug + '/';
      },

      removeRecipe(slug) {
        if (window.authHelper) {
          this.savedRecipes = window.authHelper.unsaveRecipe(slug);
        }
      },

      toggleGroceryItem(i) {
        this.groceryList[i].checked = !this.groceryList[i].checked;
        if (window.authHelper) window.authHelper.setGroceryList(this.groceryList);
      },

      removeGroceryItem(i) {
        this.groceryList.splice(i, 1);
        if (window.authHelper) window.authHelper.setGroceryList(this.groceryList);
      },

      clearGrocery() {
        this.groceryList = [];
        if (window.authHelper) window.authHelper.setGroceryList([]);
      },

      calculateMacros() {
        var w = this.macros.weight * 0.453592; // lbs to kg
        var h = this.macros.height * 2.54; // inches to cm
        var a = this.macros.age;
        var bmr = this.macros.gender === 'male'
          ? 10 * w + 6.25 * h - 5 * a + 5
          : 10 * w + 6.25 * h - 5 * a - 161;
        var tdee = bmr * parseFloat(this.macros.activity);
        var cal = this.macros.goal === 'lose' ? tdee - 500 : this.macros.goal === 'gain' ? tdee + 300 : tdee;
        cal = Math.round(cal);
        var protein = Math.round(this.macros.weight * (this.macros.goal === 'gain' ? 1.0 : 0.85));
        var fat = Math.round(cal * 0.25 / 9);
        var carbs = Math.round((cal - protein * 4 - fat * 9) / 4);
        this.macroResults = { calories: cal, protein: protein, carbs: carbs, fat: fat };
      },

      saveMacros() {
        if (window.authHelper) {
          window.authHelper.setMacroProfile({ input: this.macros, results: this.macroResults });
        }
      },

      togglePref(pref) {
        var idx = this.dietaryPrefs.indexOf(pref);
        if (idx > -1) this.dietaryPrefs.splice(idx, 1);
        else this.dietaryPrefs.push(pref);
        localStorage.setItem('dietaryPrefs', JSON.stringify(this.dietaryPrefs));
      },

      exportData() {
        var data = {
          savedRecipes: this.savedRecipes,
          groceryList: this.groceryList,
          macroProfile: { input: this.macros, results: this.macroResults },
          dietaryPrefs: this.dietaryPrefs,
          exportedAt: new Date().toISOString()
        };
        var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'meal-prep-data.json';
        a.click();
        URL.revokeObjectURL(url);
      },

      clearAllData() {
        localStorage.removeItem('savedRecipes');
        localStorage.removeItem('groceryList');
        localStorage.removeItem('macroProfile');
        localStorage.removeItem('dietaryPrefs');
        this.savedRecipes = [];
        this.groceryList = [];
        this.macroResults = null;
        this.dietaryPrefs = [];
      }
    };
  }
</script>
