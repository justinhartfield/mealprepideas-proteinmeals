---
/**
 * DietCategory — Diet Category Page (T2)
 * Theme-aware: uses CSS custom properties
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import BreadcrumbNav from './BreadcrumbNav.astro';
import PlanCTA from './PlanCTA.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Recipe {
  id: number;
  title: string;
  protein: string;
  cal: string;
  pe?: string;
  tags: string[];
  img?: string;
}

interface FAQ {
  question: string;
  answer: string;
}

interface Props {
  title: string;
  description?: string;
  canonicalUrl?: string;
  hub: string;
  facetType: string;
  facetValue: string;
  headline: string;
  headlineAccent?: string;
  definition?: string;
  definitionBullets?: string[];
  recipes?: Recipe[];
  faqs?: FAQ[];
  site?: "mealprepideas" | "proteinmeals";
  exploreColumns?: { title: string; links: { label: string; href: string }[] }[];
  peLabel?: string;
  peTarget?: string;
  peBarWidth?: string;
  peScore?: string;
  peScoreLabel?: string;
}

const {
  title, description, canonicalUrl, hub, facetType, facetValue,
  headline, headlineAccent, definition,
  definitionBullets = [],
  recipes = [],
  faqs = [],
  exploreColumns = [],
  peLabel = 'TOP TIER',
  peTarget = '30-40%',
  peBarWidth = '85%',
  peScore = '0.8+',
  peScoreLabel = 'Average Protein Grams\nPer 10 Calories',
} = Astro.props;

const hubPath = hub === 'meal-prep' ? '/meal-prep/' : '/high-protein/';
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: hub === 'meal-prep' ? 'Meal Prep' : 'High Protein', href: hubPath },
  { label: facetType.charAt(0).toUpperCase() + facetType.slice(1), href: `${hubPath}${facetType}/` },
  { label: headline },
];

const recipesJson = JSON.stringify(recipes);

const faqStructuredData = faqs.length > 0 ? JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqs.map(faq => ({
    '@type': 'Question',
    name: faq.question,
    acceptedAnswer: { '@type': 'Answer', text: faq.answer },
  })),
}) : null;

// i18n
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<BaseLayout title={title} description={description} canonicalUrl={canonicalUrl}>
  <HeaderNav statusText={`Ref: ${hubPath}${facetType}/${facetValue}/`} />

  {faqStructuredData && <script type="application/ld+json" set:html={faqStructuredData} />}

  <main class="flex-grow" x-data={`{ filter: 'all', faqOpen: null, hubPath: '${hubPath}', recipes: ${recipesJson}, showCount: 6, get visibleRecipes() { const filtered = this.filter === 'all' ? this.recipes : this.recipes.filter(r => r.tags && r.tags.includes(this.filter)); return filtered.slice(0, this.showCount); }, get totalFiltered() { return this.filter === 'all' ? this.recipes.length : this.recipes.filter(r => r.tags && r.tags.includes(this.filter)).length; }, get allShown() { return this.showCount >= this.totalFiltered; } }`}>
    <!-- BREADCRUMB + HERO -->
    <section class="relative pt-20 pb-12 px-6 border-b" style="border-color: var(--border-default);">
      <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-12 items-end">
        <div class="lg:col-span-8">
          <BreadcrumbNav items={breadcrumbs} />
          <h1 class="text-7xl md:text-9xl font-black tracking-tighter leading-[0.85] mb-8">{headline}<br/>{headlineAccent || 'PROTEIN.'}</h1>
          {definition && (
            <div class="max-w-2xl border p-8 rounded-2xl" style="background-color: color-mix(in srgb, var(--bg-secondary) 50%, transparent); border-color: var(--border-default);">
              <h2 class="text-xs font-black uppercase tracking-[0.3em] mb-4" style="color: var(--accent-primary);">{t('category.functionalDef')}</h2>
              <p class="text-lg leading-relaxed font-medium mb-6" style="color: var(--text-secondary);" set:html={definition} />
              {definitionBullets.length > 0 && (
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {definitionBullets.map(bullet => (
                    <div class="flex items-start gap-3">
                      <div class="w-5 h-5 rounded flex items-center justify-center mt-1" style="background-color: var(--accent-primary);">
                        <svg class="w-3 h-3" style="color: var(--text-inverse);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>
                      </div>
                      <span class="text-sm font-bold" style="color: var(--text-secondary);">{bullet}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
        <div class="lg:col-span-4">
          <div class="hyper-border p-8 rounded-3xl" style="background-color: var(--bg-primary);">
            <div class="flex justify-between items-center mb-8">
              <span class="text-[10px] font-black uppercase tracking-widest" style="color: var(--text-secondary);">{t('category.peEfficiency')}</span>
              <span class="font-black italic" style="color: var(--accent-primary);">{peLabel}</span>
            </div>
            <div class="space-y-6">
              <div>
                <div class="flex justify-between text-[10px] font-black mb-2 uppercase tracking-widest">
                  <span>Protein Target</span><span>{peTarget}</span>
                </div>
                <div class="h-2 w-full rounded-full overflow-hidden" style="background-color: var(--bg-tertiary);">
                  <div class="h-full pe-gradient" style={`width: ${peBarWidth}`}></div>
                </div>
              </div>
              <div class="pt-6 border-t" style="border-color: var(--border-default);">
                <div class="flex items-center gap-4">
                  <span class="text-4xl font-black tabular-nums tracking-tighter">{peScore}</span>
                  <p class="text-[10px] font-bold leading-tight uppercase" style="color: var(--text-secondary);">{peScoreLabel}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FILTER BAR -->
    <section class="sticky top-[73px] z-40 backdrop-blur-md border-b px-6 py-4" style="background-color: var(--bg-nav); border-color: var(--border-default);">
      <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
        <div class="flex gap-2">
          {['All', 'Lunch', 'Dinner', 'Weight Loss'].map(f => (
            <button
              x-on:click={`filter = '${f === 'All' ? 'all' : f}'`}
              x-bind:class={`filter === '${f === 'All' ? 'all' : f}' ? 'pill-active' : 'theme-pill-inactive'`}
              class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all"
            >{f}</button>
          ))}
        </div>
        <div class="text-[10px] font-black uppercase tracking-widest" style="color: var(--text-secondary);">
          Showing <span x-text="recipes.filter(r => filter === 'all' || r.tags.includes(filter)).length"></span> Valid Protocols
        </div>
      </div>
    </section>

    <!-- RECIPE GRID -->
    <section class="py-12 px-6 max-w-7xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <template x-for="recipe in visibleRecipes" x-bind:key="recipe.id">
          <div
               x-transition:enter="transition ease-out duration-300"
               x-transition:enter-start="opacity-0 transform translate-y-4"
               x-transition:enter-end="opacity-100 transform translate-y-0"
               class="hyper-border rounded-2xl overflow-hidden group">
            <div class="aspect-video relative overflow-hidden" style="background-color: var(--bg-tertiary);">
              <template x-if="recipe.img"><img x-bind:src="recipe.img" class="w-full h-full object-cover" x-bind:alt="recipe.title" /></template>
              <div class="scanner-line opacity-0 group-hover:opacity-100 transition-opacity"></div>
              <div class="absolute inset-0 recipe-gradient"></div>
              <div class="absolute bottom-4 left-4 right-4 flex justify-between items-end">
                <div>
                  <h3 class="text-xl font-black tracking-tight" x-text="recipe.title"></h3>
                  <div class="flex gap-2 mt-2">
                    <template x-for="tag in recipe.tags">
                      <span class="text-[8px] font-black uppercase tracking-tighter px-1.5 py-0.5 rounded border" style="background-color: color-mix(in srgb, var(--bg-secondary) 80%, transparent); border-color: var(--border-default);" x-text="tag"></span>
                    </template>
                  </div>
                </div>
                <div class="text-right" x-show="recipe.pe">
                  <span class="text-lg font-black italic block leading-none" style="color: var(--accent-primary);" x-text="recipe.pe"></span>
                  <span class="text-[8px] font-bold uppercase tracking-widest" style="color: var(--text-secondary);">P:E Rating</span>
                </div>
              </div>
            </div>
            <div class="p-4 grid grid-cols-2 gap-4 border-t" style="border-color: var(--border-default);">
              <div class="p-3 rounded-xl border" style="background-color: var(--bg-primary); border-color: var(--border-default);">
                <span class="text-[9px] font-bold uppercase tracking-widest block mb-1" style="color: var(--text-secondary);">{t('common.protein')}</span>
                <span class="text-xl font-black tabular-nums" x-text="recipe.protein"></span>
              </div>
              <div class="p-3 rounded-xl border" style="background-color: var(--bg-primary); border-color: var(--border-default);">
                <span class="text-[9px] font-bold uppercase tracking-widest block mb-1" style="color: var(--text-secondary);">{t('common.calories')}</span>
                <span class="text-xl font-black tabular-nums" x-text="recipe.cal"></span>
              </div>
            </div>
            <a x-bind:href="recipe.slug ? hubPath + 'recipes/' + recipe.slug + '/' : hubPath" class="block w-full py-4 text-center hover-accent-bg hover-inverse-text transition-all text-[10px] font-black uppercase tracking-[0.2em]" style="background-color: var(--bg-secondary);">
              View Full Recipe
            </a>
          </div>
        </template>
      </div>
      <div x-show="!allShown" class="mt-12 flex flex-col items-center gap-4">
        <div class="w-full max-w-xs h-1 rounded-full relative overflow-hidden" style="background-color: var(--bg-secondary);">
          <div class="absolute top-0 left-0 h-full transition-all duration-500" x-bind:style="'width: ' + Math.round(Math.min(showCount, totalFiltered) / totalFiltered * 100) + '%; background-color: var(--accent-primary);'"></div>
        </div>
        <button x-on:click="showCount += 6" class="border px-12 py-4 rounded-full text-[10px] font-black uppercase tracking-[0.3em] transition-all hover-accent-border cursor-pointer" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
          Retrieve Additional Inventory <span style="color: var(--text-secondary);">(Showing <span x-text="Math.min(showCount, totalFiltered)"></span> of <span x-text="totalFiltered"></span>)</span>
        </button>
      </div>
    </section>

    <!-- PLAN CTA -->
    <PlanCTA hub={hub} />

    <!-- FAQ -->
    {faqs.length > 0 && (
      <section class="py-24 px-6 max-w-4xl mx-auto">
        <h4 class="text-4xl font-black tracking-tighter mb-12 text-center">{t('common.technicalFaq')}</h4>
        <div class="space-y-4">
          {faqs.map((faq, index) => (
            <div class="border rounded-2xl overflow-hidden" style="border-color: var(--border-default);">
              <button
                x-on:click={`faqOpen === ${index} ? faqOpen = null : faqOpen = ${index}`}
                class="w-full flex justify-between items-center p-6 text-left hover-bg-secondary transition-colors"
              >
                <span class="text-sm font-black uppercase tracking-wider">{faq.question}</span>
                <span class="text-2xl font-black" style="color: var(--accent-primary);" x-text={`faqOpen === ${index} ? '−' : '+'`}></span>
              </button>
              <div x-show={`faqOpen === ${index}`} x-cloak class="p-6 border-t text-sm leading-relaxed" style="background-color: color-mix(in srgb, var(--bg-secondary) 50%, transparent); border-color: var(--border-default); color: var(--text-secondary);">
                {faq.answer}
              </div>
            </div>
          ))}
        </div>
      </section>
    )}
  </main>

  <FooterNav copyrightSuffix="Index Authority Network. Diet Facet System T2." />
</BaseLayout>
