---
/**
 * RetailerChainPage â€” Retailer/Chain Page (T6+T7 merged)
 * Theme-aware: uses CSS custom properties
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import HeaderNav from './HeaderNav.astro';
import FooterNav from './FooterNav.astro';
import BreadcrumbNav from './BreadcrumbNav.astro';
import FacetNav from './FacetNav.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface SKU {
  id: string; name: string; category: string; protein: string; cals: string; price: string; peScore: string;
}

interface MenuHack {
  order: string; modifications: string; protein: string; cals: string; savings: string;
}

interface Props {
  title: string; description?: string; canonicalUrl?: string;
  entityName: string; entityType: 'store' | 'chain';
  tagline?: string; entityDescription?: string;
  totalSKUs?: number; avgPE?: string;
  skus?: SKU[];
  menuHacks?: MenuHack[];
  site?: "mealprepideas" | "proteinmeals";
  topPicks?: { name: string; protein: string; reason: string }[];
  relatedLinks?: { label: string; href: string }[];
}

const {
  title, description, canonicalUrl, entityName, entityType,
  tagline = '', entityDescription = '',
  totalSKUs = 0, avgPE = '0',
  skus = [], menuHacks = [], topPicks = [], relatedLinks = [],
  site,
} = Astro.props;

const skusJson = JSON.stringify(skus);
const isStore = entityType === 'store';

// --- Schema.org Structured Data ---
// Determine hub path from site prop or canonicalUrl, not entity type
const detectedSite = site || (canonicalUrl?.includes('proteinmeals') ? 'proteinmeals' : canonicalUrl?.includes('mealprepideas') ? 'mealprepideas' : undefined);
const hubPath = detectedSite === 'proteinmeals' ? '/high-protein/' : detectedSite === 'mealprepideas' ? '/meal-prep/' : (isStore ? '/meal-prep/' : '/high-protein/');
const siteUrl = canonicalUrl
  ? canonicalUrl.replace(/\/[^/]*\/[^/]*\/[^/]*\/$/, '')
  : (isStore ? 'https://mealprepideas.co' : 'https://proteinmeals.co');

// BreadcrumbList schema
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: `${siteUrl}/` },
    { '@type': 'ListItem', position: 2, name: isStore ? 'Meal Prep Hub' : 'High Protein Hub', item: `${siteUrl}${hubPath}` },
    { '@type': 'ListItem', position: 3, name: entityName },
  ],
};

// ItemList schema for SKUs / top picks
const itemListSchema = skus.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: `${entityName} ${isStore ? 'Top Protein Picks' : 'High Protein Menu Items'}`,
  description: entityDescription,
  numberOfItems: skus.length,
  itemListElement: skus.map((sku: any, idx: number) => ({
    '@type': 'ListItem',
    position: idx + 1,
    name: sku.name,
    description: `${sku.protein} protein, ${sku.cals} calories. Category: ${sku.category}.`,
  })),
} : null;

// FAQPage schema from top picks tips (generate FAQs from store data)
const generatedFaqs = topPicks.slice(0, 5).map((pick: any) => ({
  question: `Why is ${pick.name} a top pick at ${entityName}?`,
  answer: pick.reason,
}));
if (entityDescription) {
  generatedFaqs.unshift({
    question: `What makes ${entityName} good for ${isStore ? 'meal prep' : 'high-protein eating'}?`,
    answer: entityDescription,
  });
}

const faqSchema = generatedFaqs.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: generatedFaqs.map((faq: any) => ({
    '@type': 'Question',
    name: faq.question,
    acceptedAnswer: { '@type': 'Answer', text: faq.answer },
  })),
} : null;

const allSchemas = [breadcrumbSchema, itemListSchema, faqSchema].filter(Boolean);
const combinedSchemaJson = JSON.stringify(allSchemas);

// i18n
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<BaseLayout title={title} description={description} canonicalUrl={canonicalUrl}>
  <HeaderNav statusText={`${entityType === 'store' ? 'Retailer' : 'Chain'}: ${entityName}`} />

  {allSchemas.map((schema: any) => (
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  ))}

  <main class="flex-grow" x-data={`{
    filter: 'all',
    sortBy: 'default',
    allSkus: ${skusJson},
    get categories() {
      const cats = [...new Set(this.allSkus.map(s => s.category))].filter(Boolean);
      return cats;
    },
    get skus() {
      let filtered = this.filter === 'all' ? [...this.allSkus] : this.allSkus.filter(s => s.category === this.filter);
      if (this.sortBy === 'protein') {
        filtered.sort((a, b) => parseFloat(b.protein) - parseFloat(a.protein));
      } else if (this.sortBy === 'calories') {
        filtered.sort((a, b) => parseFloat(a.cals) - parseFloat(b.cals));
      } else if (this.sortBy === 'pe') {
        filtered.sort((a, b) => parseFloat(b.peScore) - parseFloat(a.peScore));
      }
      return filtered;
    }
  }`}>
    <BreadcrumbNav items={[
      { label: 'Home', href: '/' },
      { label: hubPath === '/meal-prep/' ? 'Meal Prep Hub' : 'High Protein Hub', href: hubPath },
      { label: entityName },
    ]} />

    <!-- HERO -->
    <section class="px-6 max-w-7xl mx-auto mb-16">
      <div class="grid md:grid-cols-12 gap-12">
        <div class="md:col-span-8">
          <div class="flex items-center gap-3 mb-6">
            <span class="text-[10px] font-black px-2 py-0.5 rounded uppercase" style="background-color: var(--accent-primary); color: var(--text-inverse);">{isStore ? 'T6: Retailer' : 'T7: Chain'}</span>
          </div>
          <h1 class="text-5xl md:text-8xl font-black tracking-tighter leading-none mb-6">{entityName}</h1>
          {tagline && <p class="text-xl font-bold mb-4" style="color: var(--accent-primary);">{tagline}</p>}
          {entityDescription && <p class="text-lg max-w-2xl leading-relaxed" style="color: var(--text-secondary);">{entityDescription}</p>}
        </div>
        <div class="md:col-span-4">
          <div class="hyper-border rounded-3xl p-8">
            <div class="scanner-line"></div>
            <h3 class="text-[10px] font-black uppercase tracking-widest mb-6" style="color: var(--text-secondary);">{isStore ? 'SKU Intelligence' : 'Menu Intelligence'}</h3>
            <div class="space-y-6">
              <div class="flex justify-between items-end">
                <span class="text-xs font-bold" style="color: var(--text-secondary);">{isStore ? 'Total SKUs' : 'Menu Items'}</span>
                <span class="text-3xl font-black" style="color: var(--accent-primary);">{totalSKUs || skus.length}</span>
              </div>
              <div class="flex justify-between items-end">
                <span class="text-xs font-bold" style="color: var(--text-secondary);">{t('retail.avgPeScore')}</span>
                <span class="text-3xl font-black">{avgPE}</span>
              </div>
              <button class="w-full py-4 rounded-xl font-black uppercase text-xs tracking-widest transition-all theme-btn-primary">
                {isStore ? 'Download Full SKU List' : 'View All Menu Hacks'}
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SKU / MENU TABLE -->
    {skus.length > 0 && (
      <section class="py-16 px-6 border-y" style="background-color: var(--bg-primary); border-color: var(--border-default);">
        <div class="max-w-7xl mx-auto">
          <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
            <h2 class="text-3xl font-black tracking-tighter">{isStore ? 'Product Index' : 'Menu Matrix'}</h2>
            <div class="flex flex-wrap gap-2">
              <button x-on:click="filter = 'all'" x-bind:class="filter === 'all' ? 'pill-active' : 'theme-pill-inactive'" class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest transition-all">All</button>
              <template x-for="cat in categories" x-bind:key="cat">
                <button x-on:click="filter = cat" x-bind:class="filter === cat ? 'pill-active' : 'theme-pill-inactive'" class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest transition-all" x-text="cat"></button>
              </template>
              <span class="w-px h-6 mx-1" style="background: var(--border-default);"></span>
              <button x-on:click="sortBy = sortBy === 'protein' ? 'default' : 'protein'" x-bind:class="sortBy === 'protein' ? 'pill-active' : 'theme-pill-inactive'" class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest transition-all">{t('retail.sortProtein')}</button>
              <button x-on:click="sortBy = sortBy === 'calories' ? 'default' : 'calories'" x-bind:class="sortBy === 'calories' ? 'pill-active' : 'theme-pill-inactive'" class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest transition-all">{t('retail.sortCalories')}</button>
              <button x-on:click="sortBy = sortBy === 'pe' ? 'default' : 'pe'" x-bind:class="sortBy === 'pe' ? 'pill-active' : 'theme-pill-inactive'" class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest transition-all">{t('retail.sortPE')}</button>
            </div>
          </div>

          <div class="hidden md:grid grid-cols-12 gap-4 px-6 py-3 text-[10px] font-black uppercase tracking-widest border-b" style="color: var(--text-tertiary); border-color: var(--border-default);">
            <div class="col-span-1">ID</div>
            <div class="col-span-4">Name</div>
            <div class="col-span-1">Type</div>
            <div class="col-span-2">Protein</div>
            <div class="col-span-2">Calories</div>
            <div class="col-span-2">P:E</div>
          </div>

          <template x-for="sku in skus" x-bind:key="sku.id">
            <div class="data-row grid grid-cols-12 gap-4 px-6 py-4 border-b items-center group cursor-pointer" style="border-color: var(--border-default);">
              <div class="col-span-1 text-[10px] font-black" style="color: var(--text-tertiary);" x-text="sku.id"></div>
              <div class="col-span-4 font-black text-sm group-hover-accent-text transition-colors" x-text="sku.name"></div>
              <div class="col-span-1 text-[10px] font-bold uppercase" style="color: var(--text-secondary);" x-text="sku.category"></div>
              <div class="col-span-2 font-black" style="color: var(--accent-primary);" x-text="sku.protein"></div>
              <div class="col-span-2 font-bold" style="color: var(--text-secondary);" x-text="sku.cals"></div>
              <div class="col-span-2 font-black" x-text="sku.peScore"></div>
            </div>
          </template>
        </div>
      </section>
    )}

    <!-- TOP PICKS -->
    {topPicks.length > 0 && (
      <section class="py-16 px-6 max-w-7xl mx-auto">
        <h2 class="text-3xl font-black tracking-tighter mb-8">{t('retail.topPicks')}</h2>
        <div class="grid md:grid-cols-3 gap-6">
          {topPicks.map((pick, i) => (
            <div class="hyper-border rounded-2xl p-6 group">
              <div class="flex justify-between items-start mb-4">
                <span class="text-4xl font-black group-hover-accent-opacity transition-colors" style="color: var(--text-tertiary);">{i + 1}</span>
                <span class="font-black" style="color: var(--accent-primary);">{pick.protein}</span>
              </div>
              <h4 class="text-xl font-black mb-3">{pick.name}</h4>
              <p class="text-sm" style="color: var(--text-secondary);">{pick.reason}</p>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- MENU HACKS (for chains) -->
    {menuHacks.length > 0 && (
      <section class="py-16 px-6" style="background-color: var(--accent-primary); color: var(--text-inverse);">
        <div class="max-w-7xl mx-auto">
          <h2 class="text-4xl font-black tracking-tighter mb-8">{t('retail.menuModGuide')}</h2>
          <div class="grid md:grid-cols-2 gap-6">
            {menuHacks.map(hack => (
              <div class="rounded-2xl p-6 border-2" style="background-color: var(--bg-secondary); color: var(--text-primary); border-color: var(--text-inverse);">
                <h4 class="text-xl font-black mb-3">{hack.order}</h4>
                <p class="text-sm font-bold mb-4" style="color: var(--text-secondary);">{hack.modifications}</p>
                <div class="grid grid-cols-3 gap-3">
                  <div class="text-center"><span class="text-xs font-bold block" style="color: var(--text-secondary);">{t('common.protein')}</span><span class="font-black">{hack.protein}</span></div>
                  <div class="text-center"><span class="text-xs font-bold block" style="color: var(--text-secondary);">Cals</span><span class="font-black">{hack.cals}</span></div>
                  <div class="text-center"><span class="text-xs font-bold block" style="color: var(--text-secondary);">Savings</span><span class="font-black">{hack.savings}</span></div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- RELATED LINKS -->
    {relatedLinks.length > 0 && (
      <section class="py-16 px-6 max-w-7xl mx-auto">
        <h3 class="text-2xl font-black tracking-tight mb-8">{t('retail.relatedIndexes')}</h3>
        <div class="grid md:grid-cols-4 gap-4">
          {relatedLinks.map(link => (
            <a href={link.href} class="p-6 border rounded-2xl hover-accent-border transition-all group" style="background-color: var(--bg-secondary); border-color: var(--border-default);">
              <div class="font-bold text-sm group-hover-accent-text transition-colors">{link.label}</div>
            </a>
          ))}
        </div>
      </section>
    )}
  </main>

  <FooterNav copyrightSuffix={`Index Authority Network. ${entityType === 'store' ? 'Retailer' : 'Chain'}: ${entityName}.`} />
</BaseLayout>
