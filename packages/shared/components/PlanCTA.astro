---
/**
 * PlanCTA â€” Signature Protocol CTA Card for category pages
 * Shows a featured meal plan with download/grocery list CTAs (auth-gated)
 * Light variant with 2-column layout: text + stacked batch cards
 */
import { plans } from '../data/content/plans';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Props {
  hub: string;
  /** Optional: specific plan slug to feature. Auto-selects first matching if omitted */
  planSlug?: string;
}

const { hub, planSlug } = Astro.props;
const hubPath = hub === 'meal-prep' ? '/meal-prep/' : '/high-protein/';

// Pick a featured plan
const hubPlans = plans.filter(p => p.hub === hub);
const plan = planSlug
  ? hubPlans.find(p => p.slug === planSlug)
  : hubPlans[0];

if (!plan) return;

// Extract meal titles from day 1 grouped by type
const day1 = plan.days?.[0];
const getMeal = (type: string) => day1?.meals?.find(m => m.type === type)?.title || '';
const numDays = plan.days?.length || 5;

const batches = [
  { label: 'BREAKFAST', meal: getMeal('breakfast') || 'Overnight Oats', servings: numDays, accent: false },
  { label: 'LUNCH', meal: getMeal('lunch') || 'Protein Bowls', servings: numDays, accent: false },
  { label: 'DINNER', meal: getMeal('dinner') || 'One-Pan Protein', servings: numDays, accent: true },
];

const totalServings = numDays * 3;
const groceryCost = plan.groceryBudget || `$${numDays * 10}`;

// i18n
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<section class="py-24 px-6" style="background-color: var(--bg-secondary);">
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">

    <!-- LEFT: Text Content -->
    <div>
      <span class="text-[10px] font-black uppercase tracking-[0.5em] block mb-6" style="color: var(--text-tertiary);">{t('planCta.signatureProtocol')}</span>
      <h2 class="text-5xl md:text-7xl font-black tracking-tighter leading-[0.9] mb-8" style="color: var(--text-primary);">
        {plan.title.toUpperCase()}
      </h2>
      <p class="text-lg leading-relaxed mb-10 max-w-lg" style="color: var(--text-secondary);">
        {plan.description}
      </p>

      <!-- Stats -->
      <div class="flex gap-16 mb-10">
        <div>
          <span class="text-5xl font-black block" style="color: var(--text-primary);">{totalServings}</span>
          <span class="text-[9px] font-black uppercase tracking-widest block mt-1" style="color: var(--text-tertiary);">{t('hub.individualServings')}</span>
        </div>
        <div>
          <span class="text-5xl font-black block" style="color: var(--text-primary);">{groceryCost}</span>
          <span class="text-[9px] font-black uppercase tracking-widest block mt-1" style="color: var(--text-tertiary);">{t('hub.totalGroceryCost')}</span>
        </div>
      </div>

      <!-- CTA Buttons -->
      <div class="flex flex-wrap gap-4">
        <a
          href={`${hubPath}plans/${plan.slug}/`}
          class="px-8 py-4 rounded-full font-black text-[10px] uppercase tracking-widest cursor-pointer transition-all hover:scale-105 flex items-center gap-2 no-underline"
          style="background: var(--text-primary); color: var(--bg-primary);"
        >
          {t('hub.viewFullPlan')}
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg>
        </a>
        <a
          href={`${hubPath}plans/`}
          class="px-8 py-4 rounded-full font-black text-[10px] uppercase tracking-widest cursor-pointer transition-all hover:scale-105 border-2 no-underline"
          style="border-color: var(--text-primary); color: var(--text-primary);"
        >
          {t('hub.browseAllPlans')}
        </a>
      </div>
    </div>

    <!-- RIGHT: Stacked Batch Cards -->
    <div class="relative">
      <div class="space-y-4">
        {batches.map((batch, i) => (
          <div
            class="rounded-2xl p-6 flex justify-between items-start transition-transform hover:-translate-y-1"
            style={batch.accent
              ? 'background: var(--accent-primary); color: var(--text-inverse);'
              : 'background: var(--bg-tertiary); color: var(--text-primary);'
            }
          >
            <div>
              <span class="text-[9px] font-black uppercase tracking-widest block mb-2"
                    style={batch.accent ? '' : 'color: var(--text-secondary);'}>
                Batch {String(i + 1).padStart(2, '0')}: {batch.label}
              </span>
              <span class="text-lg font-black tracking-tight">{batch.meal}</span>
            </div>
            <span class="text-[10px] font-black uppercase tracking-wider"
                  style={batch.accent ? '' : 'color: var(--accent-primary);'}>
              {batch.servings} Servings
            </span>
          </div>
        ))}
      </div>
    </div>

  </div>
</section>
