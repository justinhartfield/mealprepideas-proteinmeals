---
/**
 * mealprepideas.co/es/meal-prep/[facetType]/[facetValue]/ — Single Facet Category (Spanish)
 * Same logic as English version, with Spanish meta titles/descriptions and /es/ canonical URLs.
 */
import DietCategory from '@mealprepideas/shared/components/DietCategory.astro';
import MethodCategory from '@mealprepideas/shared/components/MethodCategory.astro';
import PersonaConditionPage from '@mealprepideas/shared/components/PersonaConditionPage.astro';
import RetailerChainPage from '@mealprepideas/shared/components/RetailerChainPage.astro';
import { generateSingleFacetPaths, slugToDisplay, comboUrl } from '@mealprepideas/shared/utils/urls';
import { getRecipesMatchingAnyFacet, getFacetContent, buildFacetKey } from '@mealprepideas/shared/utils/content';
import { stores } from '@mealprepideas/shared/data/content/stores';
import { personaContent } from '@mealprepideas/shared/data/content/personas';
import { getMethodLogistics } from '@mealprepideas/shared/data/content/methodLogistics';
import { facets } from '@mealprepideas/shared/data/taxonomy';
import type { FacetKey } from '@mealprepideas/shared/data/taxonomy';

export function getStaticPaths() {
  const paths = generateSingleFacetPaths('meal-prep');
  return paths.map(({ facetType, facetValue }) => ({
    params: { facetType, facetValue },
  }));
}

const { facetType, facetValue } = Astro.params;
const displayValue = slugToDisplay(facetValue!);
const displayType = slugToDisplay(facetType!);

const isMethod = facetType === 'method';
const isPersona = facetType === 'persona';
const isStoreOrChain = facetType === 'store' || facetType === 'chain';

// --- PERSONA RENDERING ---
let personaRecipes: any[] = [];
const persona = isPersona ? personaContent.find(p => p.slug === facetValue) : undefined;
if (isPersona) {
  const matchingRecipes = getRecipesMatchingAnyFacet('meal-prep', 'persona', facetValue!);
  personaRecipes = matchingRecipes.map((r, i) => ({
    id: i + 1,
    title: r.title,
    slug: r.slug,
    protein: `${r.protein}g`,
    cal: `${r.calories}`,
    tags: Object.values(r.facets).filter(Boolean) as string[],
    img: '/images/recipes/' + r.slug + '.jpg',
  }));
}

// --- STORE/CHAIN RENDERING ---
let storeData: typeof stores[number] | undefined;
if (isStoreOrChain) {
  storeData = stores.find(s => s.slug === facetValue);
}

function calculateAvgPE(topPicks: typeof stores[number]['topPicks']): string {
  const valid = topPicks.filter(p => p.protein && p.calories && p.calories > 0);
  if (valid.length === 0) return '—';
  const avg = valid.reduce((sum, p) => sum + (p.protein! / (p.calories! / 100)), 0) / valid.length;
  return avg.toFixed(1);
}

// --- DEFAULT (Diet/Method) RENDERING ---
const seoContent = getFacetContent(buildFacetKey(facetType!, facetValue!), 'meal-prep');
const realRecipes = getRecipesMatchingAnyFacet('meal-prep', facetType!, facetValue!);

const displayRecipes = realRecipes.length > 0
  ? realRecipes.map((r, i) => isMethod
      ? { id: i + 1, title: r.title, slug: r.slug, protein: `${r.protein}g`, cals: `${r.calories}`, time: `${r.prepTime + r.cookTime}m`, category: r.facets.meal || 'dinner', img: '/images/recipes/' + r.slug + '.jpg' }
      : { id: i + 1, title: r.title, slug: r.slug, protein: `${r.protein}g`, cal: `${r.calories}`, pe: r.protein > 35 ? 'Elite' : r.protein > 25 ? 'High' : 'Mid', tags: [r.facets.meal || 'Dinner', r.facets.goal || r.facets.constraint || 'Prep'].map(t => slugToDisplay(t)), img: '/images/recipes/' + r.slug + '.jpg' }
    )
  : isMethod
    ? Array.from({ length: 6 }, (_, i) => ({
        id: i + 1,
        title: `${displayValue} Recipe ${i + 1}`,
        slug: '',
        protein: `${28 + i * 4}g`,
        cals: `${320 + i * 50}`,
        time: `${10 + i * 3}m`,
        category: ['lunch', 'dinner', 'snacks', 'dinner', 'lunch', 'dinner'][i],
        img: '',
      }))
    : Array.from({ length: 6 }, (_, i) => ({
        id: i + 1,
        title: `${displayValue} Meal ${i + 1}`,
        slug: '',
        protein: `${24 + i * 3}g`,
        cal: `${380 + i * 40}`,
        pe: ['High', 'Elite', 'Mid', 'High', 'Elite', 'Mid'][i],
        tags: [['Lunch', 'Muscle Gain'], ['Dinner', 'Weight Loss'], ['Dinner', 'Cheap'], ['Breakfast', 'Quick'], ['Lunch', 'No-Microwave'], ['Dinner', 'Crockpot']][i],
      }));

const displayFaqs = seoContent?.faqItems ?? [
  { question: `¿Qué hace única la preparación de comidas ${displayValue}?`, answer: `Nuestros protocolos de ${displayValue} están optimizados para eficiencia, estabilidad en la cocción por lotes y densidad nutricional.` },
  { question: `¿Cuánto duran estas comidas?`, answer: `La mayoría de las comidas ${displayValue} están optimizadas para 5 días en refrigerador y 90 días de estabilidad en congelador.` },
];

// Build contextual explore columns — use /es/ prefixed links
const dv = displayValue;
const fv = facetValue;
const ft = facetType;
const isDietOrGoal = ft === 'diet' || ft === 'goal' || ft === 'constraint';
const hp = '/es/meal-prep/';
const cu = (tA: string, vA: string, tB: string, vB: string) => comboUrl(hp, tA, vA, tB, vB);
const exploreColumns = isDietOrGoal ? [
  { title: `${dv} por Comida`, titleHref: '/es/meal-prep/meal/', number: '01', links: [
    { label: `${dv} Desayuno`, href: cu('meal', 'breakfast', ft!, fv!) },
    { label: `${dv} Almuerzo`, href: cu('meal', 'lunch', ft!, fv!) },
    { label: `${dv} Cena`, href: cu('meal', 'dinner', ft!, fv!) },
  ]},
  { title: `${dv} por Método`, titleHref: '/es/meal-prep/method/', number: '02', links: [
    { label: `${dv} Freidora de Aire`, href: cu('method', 'air-fryer', ft!, fv!) },
    { label: `${dv} Crockpot`, href: cu('method', 'crockpot', ft!, fv!) },
    { label: `${dv} Sin Cocción`, href: cu('method', 'no-cook', ft!, fv!) },
  ]},
  { title: `${dv} por Objetivo`, titleHref: '/es/meal-prep/goal/', number: '03', links: ft === 'goal' ? [
    { label: 'Pérdida de Peso', href: '/es/meal-prep/goal/weight-loss/' },
    { label: 'Ganancia Muscular', href: '/es/meal-prep/goal/muscle-gain/' },
    { label: 'Presupuesto', href: '/es/meal-prep/constraint/budget/' },
  ] : [
    { label: `${dv} Pérdida de Peso`, href: cu(ft!, fv!, 'goal', 'weight-loss') },
    { label: `${dv} Ganancia Muscular`, href: cu(ft!, fv!, 'goal', 'muscle-gain') },
    { label: `${dv} Saludable`, href: cu(ft!, fv!, 'goal', 'healthy') },
  ]},
] : [
  { title: 'Por Comida', titleHref: '/es/meal-prep/meal/', number: '01', links: [
    { label: 'Desayuno', href: '/es/meal-prep/meal/breakfast/' }, { label: 'Almuerzo', href: '/es/meal-prep/meal/lunch/' }, { label: 'Cena', href: '/es/meal-prep/meal/dinner/' },
  ]},
  { title: 'Por Objetivo', titleHref: '/es/meal-prep/goal/', number: '02', links: [
    { label: 'Pérdida de Peso', href: '/es/meal-prep/goal/weight-loss/' }, { label: 'Ganancia Muscular', href: '/es/meal-prep/goal/muscle-gain/' }, { label: 'Presupuesto', href: '/es/meal-prep/constraint/budget/' },
  ]},
  { title: 'Restricciones', titleHref: '/es/meal-prep/constraint/', number: '03', links: [
    { label: 'Alta Fibra', href: '/es/meal-prep/constraint/high-fiber/' }, { label: 'Bajo en Calorías', href: '/es/meal-prep/diet/low-calorie/' }, { label: 'Preparación Rápida', href: '/es/meal-prep/constraint/quick/' },
  ]},
];

// P:E widget data per facet type
const peData: Record<string, { label: string; target: string; barWidth: string; score: string; scoreLabel: string }> = {
  'diet': { label: 'DIETA OPTIMIZADA', target: '25-40%', barWidth: '75%', score: '0.7+', scoreLabel: 'Gramos de Proteína Promedio Por 10 Calorías' },
  'goal': { label: 'OBJETIVO ALINEADO', target: '30-45%', barWidth: '85%', score: '0.8+', scoreLabel: 'Gramos de Proteína Promedio Por 10 Calorías' },
  'meal': { label: 'TIPO DE COMIDA', target: '25-35%', barWidth: '70%', score: '6+', scoreLabel: 'Recetas en Esta Categoría' },
  'constraint': { label: 'RESTRICCIÓN CUMPLIDA', target: '100%', barWidth: '90%', score: String(realRecipes.length), scoreLabel: 'Protocolos Disponibles' },
  'ingredient': { label: 'INGREDIENTE CLAVE', target: '20-40g', barWidth: '80%', score: String(realRecipes.length), scoreLabel: 'Recetas con Este Ingrediente' },
};
const pe = peData[facetType!] || peData['diet'];
---

{isPersona ? (
  <PersonaConditionPage
    title={`Meal Prep para ${displayValue} | MealPrepIdeas.co`}
    description={`Guía completa de meal prep para ${displayValue.toLowerCase()}. Recetas, planes y consejos adaptados a tus necesidades.`}
    canonicalUrl={`https://mealprepideas.co/es/meal-prep/persona/${facetValue}/`}
    conditionName={displayValue}
    conditionType={persona?.conditionType || 'persona'}
    definition={persona?.definition || `Guía completa de preparación de comidas adaptada para ${displayValue.toLowerCase()}. Explora recetas curadas, planes semanales y consejos nutricionales diseñados específicamente para tu estilo de vida.`}
    disclaimer={persona?.disclaimer}
    nutritionRules={persona?.nutritionRules || []}
    recipes={personaRecipes}
    faqs={persona?.faqs || []}
  />
) : isStoreOrChain && storeData ? (
  <RetailerChainPage
    site="mealprepideas"
    title={`Guía de Meal Prep en ${storeData.name} | MealPrepIdeas.co`}
    description={storeData.description}
    canonicalUrl={`https://mealprepideas.co/es/meal-prep/${facetType}/${facetValue}/`}
    entityName={storeData.name}
    entityType={storeData.type === 'grocery' ? 'store' : 'chain'}
    tagline={storeData.tagline}
    entityDescription={storeData.description}
    totalSKUs={storeData.topPicks.length}
    avgPE={calculateAvgPE(storeData.topPicks)}
    skus={storeData.topPicks.map((pick, i) => ({
      id: `SKU-${String(i + 1).padStart(3, '0')}`,
      name: pick.name,
      category: pick.category,
      protein: pick.protein ? `${pick.protein}g` : '—',
      cals: pick.calories ? `${pick.calories}` : '—',
      price: pick.price || '—',
      peScore: pick.protein && pick.calories ? (pick.protein / (pick.calories / 100)).toFixed(1) : '—',
    }))}
    topPicks={storeData.topPicks.slice(0, 3).map(p => ({
      name: p.name,
      protein: p.protein ? `${p.protein}g` : '—',
      reason: p.tip,
    }))}
  />
) : isMethod ? (
  <MethodCategory
    hub="meal-prep"
    facetType={facetType!}
    facetValue={facetValue!}
    title={seoContent?.metaTitle ?? `Sistema de Meal Prep ${displayValue} | MealPrepIdeas.co`}
    description={seoContent?.metaDescription ?? `Protocolos de meal prep con ${displayValue.toLowerCase()} optimizados para cocción por lotes.`}
    canonicalUrl={`https://mealprepideas.co/es/meal-prep/${facetType}/${facetValue}/`}
    headline={seoContent?.h1 ?? displayValue}
    subheadline={seoContent?.heroText ?? `Protocolos de cocción ${displayValue.toLowerCase()} de alto rendimiento optimizados para desnaturalización rápida de proteínas y retención de humedad.`}
    useCases={[
      { number: '01.', title: 'Eficiencia', description: 'Recalentamiento de proteínas preparadas por lotes' },
      { number: '02.', title: 'Velocidad', description: 'Cocción rápida en menos de 20 minutos' },
      { number: '03.', title: 'Lotes', description: 'Ejecución individual y familiar' },
    ]}
    recipes={displayRecipes as any}
    faqs={displayFaqs}
    exploreColumns={exploreColumns}
    executionNotes={(() => {
      const ml = getMethodLogistics(facetValue!);
      if (!ml || ml.steps.length < 2) return undefined;
      return { batchingRule: ml.steps[0].description, storageLogic: ml.steps[1].description };
    })()}
    relatedMethods={(() => {
      const methods = (facets.method?.values || []).filter(m => m !== facetValue).slice(0, 2);
      return methods.map(m => ({ label: `${slugToDisplay(m)} ${displayValue}`, href: `/es/meal-prep/method/${m}/` }));
    })()}
    planCard={{ title: `Plan de 5 Días ${displayValue}`, description: `Descarga la hoja de preparación dominical para esta categoría.`, href: `/es/meal-prep/plans/` }}
  />
) : (
  <DietCategory
    hub="meal-prep"
    facetType={facetType!}
    facetValue={facetValue!}
    title={seoContent?.metaTitle ?? `Índice de Meal Prep ${displayValue} | MealPrepIdeas.co`}
    description={seoContent?.metaDescription ?? `Explora protocolos de meal prep ${displayValue.toLowerCase()}.`}
    canonicalUrl={`https://mealprepideas.co/es/meal-prep/${facetType}/${facetValue}/`}
    headline={seoContent?.h1 ?? displayValue}
    headlineAccent="PREP."
    definition={seoContent?.heroText ?? `La preparación de comidas ${displayValue.toLowerCase()} de alto rendimiento se enfoca en maximizar la densidad nutricional mientras optimiza la logística de cocción por lotes.`}
    definitionBullets={seoContent ? [
      seoContent.sectionIntros.recipes?.slice(0, 100) + '...' || `Ideal para cocción por lotes y almacenamiento ${displayValue.toLowerCase()}.`,
      seoContent.sectionIntros.plans?.slice(0, 100) + '...' || `Optimizado para logística semanal y eficiencia de preparación.`,
    ] : [
      `Ideal para cocción por lotes y almacenamiento ${displayValue.toLowerCase()}.`,
      `Optimizado para logística semanal y eficiencia de preparación.`,
    ]}
    recipes={displayRecipes as any}
    faqs={displayFaqs}
    exploreColumns={exploreColumns}
    peLabel={pe.label}
    peTarget={pe.target}
    peBarWidth={pe.barWidth}
    peScore={pe.score}
    peScoreLabel={pe.scoreLabel}
  />
)}
