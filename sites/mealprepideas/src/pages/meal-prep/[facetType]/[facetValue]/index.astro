---
/**
 * mealprepideas.co/meal-prep/[facetType]/[facetValue]/ â€” Single Facet Category (T2)
 */
import DietCategory from '@mealprepideas/shared/components/DietCategory.astro';
import MethodCategory from '@mealprepideas/shared/components/MethodCategory.astro';
import { generateSingleFacetPaths, slugToDisplay } from '@mealprepideas/shared/utils/urls';
import { getRecipesMatchingAnyFacet, getFacetContent, buildFacetKey } from '@mealprepideas/shared/utils/content';
import type { FacetKey } from '@mealprepideas/shared/data/taxonomy';

export function getStaticPaths() {
  const paths = generateSingleFacetPaths('meal-prep');
  return paths.map(({ facetType, facetValue }) => ({
    params: { facetType, facetValue },
  }));
}

const { facetType, facetValue } = Astro.params;
const displayValue = slugToDisplay(facetValue!);
const displayType = slugToDisplay(facetType!);

const isMethod = facetType === 'method';

// Look up real content data
const seoContent = getFacetContent(buildFacetKey(facetType!, facetValue!), 'meal-prep');
const realRecipes = getRecipesMatchingAnyFacet('meal-prep', facetType!, facetValue!);

// Build recipe display objects from real data, with fallback placeholders
const displayRecipes = realRecipes.length > 0
  ? realRecipes.slice(0, 6).map((r, i) => isMethod
      ? { id: i + 1, title: r.title, protein: `${r.protein}g`, cals: `${r.calories}`, time: `${r.prepTime + r.cookTime}m`, category: r.facets.meal || 'dinner', img: '' }
      : { id: i + 1, title: r.title, protein: `${r.protein}g`, cal: `${r.calories}`, pe: r.protein > 35 ? 'Elite' : r.protein > 25 ? 'High' : 'Mid', tags: [r.facets.meal || 'Dinner', r.facets.goal || r.facets.constraint || 'Prep'].map(t => slugToDisplay(t)) }
    )
  : isMethod
    ? Array.from({ length: 6 }, (_, i) => ({
        id: i + 1,
        title: `${displayValue} Recipe ${i + 1}`,
        protein: `${28 + i * 4}g`,
        cals: `${320 + i * 50}`,
        time: `${10 + i * 3}m`,
        category: ['lunch', 'dinner', 'snacks', 'dinner', 'lunch', 'dinner'][i],
        img: '',
      }))
    : Array.from({ length: 6 }, (_, i) => ({
        id: i + 1,
        title: `${displayValue} Meal ${i + 1}`,
        protein: `${24 + i * 3}g`,
        cal: `${380 + i * 40}`,
        pe: ['High', 'Elite', 'Mid', 'High', 'Elite', 'Mid'][i],
        tags: [['Lunch', 'Muscle Gain'], ['Dinner', 'Weight Loss'], ['Dinner', 'Cheap'], ['Breakfast', 'Quick'], ['Lunch', 'No-Microwave'], ['Dinner', 'Crockpot']][i],
      }));

// Use SEO content FAQs if available, otherwise fallback
const displayFaqs = seoContent?.faqItems ?? [
  { question: `What makes ${displayValue} meal prep unique?`, answer: `Our ${displayValue} protocols are optimized for efficiency, batch-cooking stability, and nutrient density.` },
  { question: `How long do these meals last?`, answer: `Most ${displayValue} meals are optimized for 5-day fridge life and 90-day freezer stability.` },
];

const exploreColumns = [
  { title: 'By Meal', number: '01', links: [
    { label: 'Breakfast', href: '/meal-prep/meal/breakfast/' }, { label: 'Lunch', href: '/meal-prep/meal/lunch/' }, { label: 'Dinner', href: '/meal-prep/meal/dinner/' },
  ]},
  { title: 'By Goal', number: '02', links: [
    { label: 'Weight Loss', href: '/meal-prep/goal/weight-loss/' }, { label: 'Muscle Gain', href: '/meal-prep/goal/muscle-gain/' }, { label: 'Budget', href: '/meal-prep/constraint/budget/' },
  ]},
  { title: 'Constraints', number: '03', links: [
    { label: 'High Fiber', href: '/meal-prep/constraint/high-fiber/' }, { label: 'Low Calorie', href: '/meal-prep/diet/low-calorie/' }, { label: 'Quick Prep', href: '/meal-prep/constraint/quick/' },
  ]},
];
---

{isMethod ? (
  <MethodCategory
    hub="meal-prep"
    facetType={facetType!}
    facetValue={facetValue!}
    title={seoContent?.metaTitle ?? `${displayValue} Meal Prep System | MealPrepIdeas.co`}
    description={seoContent?.metaDescription ?? `${displayValue} meal prep protocols optimized for batch-cooking.`}
    canonicalUrl={`https://mealprepideas.co/meal-prep/${facetType}/${facetValue}/`}
    headline={seoContent?.h1 ?? displayValue}
    subheadline={seoContent?.heroText ?? `High-performance ${displayValue.toLowerCase()} cooking protocols optimized for rapid protein denaturing and moisture retention.`}
    useCases={[
      { number: '01.', title: 'Efficiency', description: 'Reheating batch-prepped proteins' },
      { number: '02.', title: 'Speed', description: 'Rapid cooking under 20 minutes' },
      { number: '03.', title: 'Batch', description: 'Single-serve and family-size execution' },
    ]}
    recipes={displayRecipes as any}
    faqs={displayFaqs}
    exploreColumns={exploreColumns}
  />
) : (
  <DietCategory
    hub="meal-prep"
    facetType={facetType!}
    facetValue={facetValue!}
    title={seoContent?.metaTitle ?? `${displayValue} Meal Prep Index | MealPrepIdeas.co`}
    description={seoContent?.metaDescription ?? `Explore ${displayValue} meal prep protocols.`}
    canonicalUrl={`https://mealprepideas.co/meal-prep/${facetType}/${facetValue}/`}
    headline={seoContent?.h1 ?? displayValue}
    headlineAccent="PREP."
    definition={seoContent?.heroText ?? `High-performance ${displayValue.toLowerCase()} meal prep focuses on maximizing nutrient density while optimizing for batch-cooking logistics.`}
    definitionBullets={seoContent ? [
      seoContent.sectionIntros.recipes?.slice(0, 100) + '...' || `Best for ${displayValue.toLowerCase()} batch-cooking and storage.`,
      seoContent.sectionIntros.plans?.slice(0, 100) + '...' || `Optimized for weekly logistics and prep efficiency.`,
    ] : [
      `Best for ${displayValue.toLowerCase()} batch-cooking and storage.`,
      `Optimized for weekly logistics and prep efficiency.`,
    ]}
    recipes={displayRecipes as any}
    faqs={displayFaqs}
    exploreColumns={exploreColumns}
  />
)}
